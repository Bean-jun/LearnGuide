<!DOCTYPE html>
<html lang="en">
<html>

<head>
  <meta charset="UTF-8">
  <link href="/.static/css/primer.css" rel="stylesheet" />
  <link rel="stylesheet alternate" href="/.static/css/github-light.css" id="light-hl">
  <link rel="stylesheet alternate" href="/.static/css/github-dark.css" id="dark-hl">
  <link rel="stylesheet" href="/.static/css/main.css">
  <title>Golang-手搓HTTP制作短链接生成器.md</title>
</head>

<body id="markdown-body" data-color-mode="light" data-dark-theme="light">
  <!-- <div class="
  Box
  md
  js-code-block-container
  Box--responsive
  container-nav
  container-left-nav
  mt-5
  d-none d-lg-block
">
    <div class="Box-body p-5">
      <div class="d-flex flex-column flex-sm-row-reverse">
        <h1>填充...</h1>
      </div>
    </div>
    <div>填充</div>
  </div> -->
  <div class="
        Box
        md
        js-code-block-container
        Box--responsive
        container-xl
        px-3 px-md-4 px-lg-5
        mt-5
      " id="content">
    <div class="Box-body px-5 pb-5">
      <div class="d-flex flex-column flex-sm-row-reverse">
        <div class="border rounded-3 to-home">
          <a href="/">返回主页</a>
        </div>
        <div>
          <button id="theme-button" class="btn" type="button">
            <span id="theme-icon" class="iconify" data-icon="octicon:sun-16"></span>
          </button>
        </div>
        <div class="article-size">
          <span>3407字 | 8分钟</span>
        </div>
      </div>
      <article class="markdown-body entry-content container-lg" itemprop="text">
        <h3><a id="user-content-一tcp通信" class="anchor" aria-hidden="true" href="#一tcp通信"><span aria-hidden="true" class="octicon octicon-link"></span></a>一、tcp通信</h3>
<ol>
<li>server端</li>
</ol>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"log"</span>
	<span class="pl-s">"net"</span>
)

<span class="pl-k">var</span> (
	<span class="pl-s1">Port</span> <span class="pl-c1">=</span> <span class="pl-s">":7256"</span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-c">// 监听端口</span>
	<span class="pl-s1">listen</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">net</span>.<span class="pl-en">Listen</span>(<span class="pl-s">"tcp"</span>, <span class="pl-s1">Port</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create listen error "</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
	}
	<span class="pl-k">for</span> {
		<span class="pl-c">// 等待获取一个连接对象</span>
		<span class="pl-s1">conn</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">listen</span>.<span class="pl-en">Accept</span>()
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create conn error"</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
		}
		<span class="pl-c">// 基于协程进行当前连接对象的处理</span>
		<span class="pl-k">go</span> <span class="pl-en">handle</span>(<span class="pl-s1">conn</span>)
	}
}

<span class="pl-k">func</span> <span class="pl-en">handle</span>(<span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-k">for</span> {
		<span class="pl-s1">data</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-c1">1024</span>)
		<span class="pl-c">// 读取数据</span>
		<span class="pl-s1">n</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Read</span>(<span class="pl-s1">data</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
			<span class="pl-k">return</span>
		}
		<span class="pl-s1">from_addr</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">RemoteAddr</span>().<span class="pl-en">String</span>()
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s1">from_addr</span>, <span class="pl-s">"read bytes:"</span>, <span class="pl-s1">n</span>, <span class="pl-s">"read data:"</span>, <span class="pl-en">string</span>(<span class="pl-s1">data</span>))
		<span class="pl-c">// 发送数据</span>
		<span class="pl-s1">conn</span>.<span class="pl-en">Write</span>(<span class="pl-s1">data</span>)
	}
}</pre></div>
<ol start="2">
<li>client端</li>
</ol>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"fmt"</span>
	<span class="pl-s">"log"</span>
	<span class="pl-s">"net"</span>
)

<span class="pl-k">var</span> (
	<span class="pl-s1">Port</span> <span class="pl-c1">=</span> <span class="pl-s">":7256"</span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-c">// 对服务端进行连接</span>
	<span class="pl-s1">conn</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">net</span>.<span class="pl-en">Dial</span>(<span class="pl-s">"tcp"</span>, <span class="pl-s1">Port</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create conn error"</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
	}
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-k">for</span> {
		<span class="pl-k">var</span> <span class="pl-s1">sendData</span> <span class="pl-smi">string</span>
		<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">fmt</span>.<span class="pl-en">Scan</span>(<span class="pl-c1">&amp;</span><span class="pl-s1">sendData</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
			<span class="pl-k">return</span>
		}
		<span class="pl-c">// 向服务端发送消息</span>
		<span class="pl-s1">conn</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">sendData</span>))
		<span class="pl-k">for</span> {
			<span class="pl-s1">recvData</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-c1">1024</span>)
			<span class="pl-s1">n</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Read</span>(<span class="pl-s1">recvData</span>)
			<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
				<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
				<span class="pl-k">break</span>
			}
			<span class="pl-s1">server_addr</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">RemoteAddr</span>().<span class="pl-en">String</span>()
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s1">server_addr</span>, <span class="pl-s">"read bytes:"</span>, <span class="pl-s1">n</span>, <span class="pl-s">"read data:"</span>, <span class="pl-en">string</span>(<span class="pl-s1">recvData</span>))
			<span class="pl-k">break</span>
		}
	}
}</pre></div>
<div class="highlight highlight-source-python"><pre><span class="pl-k">import</span> <span class="pl-s1">socket</span>

<span class="pl-c"># tcp</span>
<span class="pl-s1">sk</span> <span class="pl-c1">=</span> <span class="pl-s1">socket</span>.<span class="pl-en">socket</span>(<span class="pl-s1">socket</span>.<span class="pl-v">AF_INET</span>, <span class="pl-s1">socket</span>.<span class="pl-v">SOCK_STREAM</span>)
<span class="pl-s1">sk</span>.<span class="pl-en">connect</span>((<span class="pl-s">"127.0.0.1"</span>, <span class="pl-c1">7256</span>))

<span class="pl-k">while</span> <span class="pl-c1">True</span>:
    <span class="pl-s1">to</span> <span class="pl-c1">=</span> <span class="pl-en">input</span>(<span class="pl-s">"&gt;&gt;&gt;:"</span>)
    <span class="pl-s1">sk</span>.<span class="pl-en">send</span>(<span class="pl-s1">to</span>.<span class="pl-en">encode</span>())
    <span class="pl-k">while</span> <span class="pl-c1">True</span>:
        <span class="pl-s1">msg</span> <span class="pl-c1">=</span> <span class="pl-s1">sk</span>.<span class="pl-en">recv</span>(<span class="pl-c1">1024</span>)
        <span class="pl-s1">body</span> <span class="pl-c1">=</span> <span class="pl-s1">msg</span>.<span class="pl-en">decode</span>()
        <span class="pl-k">if</span> <span class="pl-s1">body</span>:
            <span class="pl-en">print</span>(<span class="pl-s">"recv:"</span>, <span class="pl-s1">body</span>)
        <span class="pl-k">break</span></pre></div>
<h3><a id="user-content-二http协议" class="anchor" aria-hidden="true" href="#二http协议"><span aria-hidden="true" class="octicon octicon-link"></span></a>二、http协议</h3>
<blockquote>
<p>http协议介绍<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Overview" rel="nofollow">click me</a></p>
<p>当客户端想要和服务端进行信息交互时（服务端是指最终服务器，或者是一个中间代理），过程表现为下面几步：</p>
<ol>
<li>打开一个 TCP 连接：TCP 连接被用来发送一条或多条请求，以及接受响应消息。客户端可能打开一条新的连接，或重用一个已经存在的连接，或者也可能开几个新的 TCP 连接连向服务端。</li>
<li>发送一个 HTTP 报文：HTTP 报文（在 HTTP/2 之前）是语义可读的。在 HTTP/2 中，这些简单的消息被封装在了帧中，这使得报文不能被直接读取，但是原理仍是相同的。</li>
</ol>
</blockquote>
<div class="highlight highlight-source-httpspec"><pre><span class="pl-k">GET</span><span class="pl-c1"> / HTTP/1.1</span>
<span class="pl-s"><span class="pl-v">Host:</span> developer.mozilla.org</span>
<span class="pl-s"><span class="pl-v">Accept-Language:</span> fr</span></pre></div>
<blockquote>
<ol start="3">
<li>读取服务端返回的报文信息：</li>
</ol>
</blockquote>
<div class="highlight highlight-source-httpspec"><pre><span class="pl-c1">HTTP/1.1 200 OK</span>
<span class="pl-s"><span class="pl-v">Date:</span> Sat, 09 Oct 2010 14:28:02 GMT</span>
<span class="pl-s"><span class="pl-v">Server:</span> Apache</span>
<span class="pl-s"><span class="pl-v">Last-Modified:</span> Tue, 01 Dec 2009 20:18:22 GMT</span>
<span class="pl-s"><span class="pl-v">ETag:</span> "51142bc1-7449-479b075b2891b"</span>
<span class="pl-s"><span class="pl-v">Accept-Ranges:</span> bytes</span>
<span class="pl-s"><span class="pl-v">Content-Length:</span> 29769</span>
<span class="pl-s"><span class="pl-v">Content-Type:</span> text/html</span>

<span class="pl-ii">&lt;!DOCTYPE html... (here comes the 29769 bytes of the requested web page)</span></pre></div>
<blockquote>
<ol start="4">
<li>关闭连接或者为后续请求重用连接。</li>
</ol>
</blockquote>
<blockquote>
<p>http请求头格式</p>
<p><a target="_blank" rel="noopener noreferrer" href="images/http%E8%AF%B7%E6%B1%82%E5%A4%B4%E6%A0%BC%E5%BC%8F.png"><img src="images/http%E8%AF%B7%E6%B1%82%E5%A4%B4%E6%A0%BC%E5%BC%8F.png" alt="" style="max-width: 100%;"></a></p>
</blockquote>
<blockquote>
<p>http响应头格式</p>
<p><a target="_blank" rel="noopener noreferrer" href="images/http%E5%93%8D%E5%BA%94%E5%A4%B4%E6%A0%BC%E5%BC%8F.png"><img src="images/http%E5%93%8D%E5%BA%94%E5%A4%B4%E6%A0%BC%E5%BC%8F.png" alt="" style="max-width: 100%;"></a></p>
</blockquote>
<h3><a id="user-content-三http实现" class="anchor" aria-hidden="true" href="#三http实现"><span aria-hidden="true" class="octicon octicon-link"></span></a>三、http实现</h3>
<ol>
<li>socket读取请求数据流</li>
</ol>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"log"</span>
	<span class="pl-s">"net"</span>
	<span class="pl-s">"time"</span>
)

<span class="pl-k">var</span> (
	<span class="pl-s1">Port</span>           <span class="pl-c1">=</span> <span class="pl-s">":7256"</span>
	<span class="pl-s1">MaxHeaderSize</span>  <span class="pl-c1">=</span> <span class="pl-c1">1</span> <span class="pl-c1">&lt;&lt;</span> <span class="pl-c1">10</span>
	<span class="pl-s1">ReadHeaderSize</span> <span class="pl-c1">=</span> <span class="pl-c1">1</span> <span class="pl-c1">&lt;&lt;</span> <span class="pl-c1">8</span>
)

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-c">// 监听端口</span>
	<span class="pl-s1">listen</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">net</span>.<span class="pl-en">Listen</span>(<span class="pl-s">"tcp"</span>, <span class="pl-s1">Port</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create listen error "</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
	}
	<span class="pl-k">for</span> {
		<span class="pl-c">// 等待获取一个连接对象</span>
		<span class="pl-s1">conn</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">listen</span>.<span class="pl-en">Accept</span>()
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create conn error"</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
		}
		<span class="pl-c">// 基于协程进行当前连接对象的处理</span>
		<span class="pl-k">go</span> <span class="pl-en">handle</span>(<span class="pl-s1">conn</span>)
	}
}

<span class="pl-k">func</span> <span class="pl-en">handle</span>(<span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-s1">start</span> <span class="pl-c1">:=</span> <span class="pl-s1">time</span>.<span class="pl-en">Now</span>()
	<span class="pl-s1">header</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-c1">0</span>, <span class="pl-s1">MaxHeaderSize</span>)
	<span class="pl-k">for</span> {
		<span class="pl-s1">headerRead</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-s1">ReadHeaderSize</span>)
		<span class="pl-s1">n</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Read</span>(<span class="pl-s1">headerRead</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">return</span>
		}

		<span class="pl-s1">header</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">header</span>, <span class="pl-s1">headerRead</span><span class="pl-c1">...</span>)
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"read data value length: "</span>, <span class="pl-s1">n</span>)
		<span class="pl-k">if</span> <span class="pl-s1">n</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">ReadHeaderSize</span> {
			<span class="pl-k">break</span>
		}
	}
	<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"use time total: "</span>, <span class="pl-s1">time</span>.<span class="pl-en">Since</span>(<span class="pl-s1">start</span>), <span class="pl-s">"read data:<span class="pl-cce">\n</span>"</span>, <span class="pl-en">string</span>(<span class="pl-s1">header</span>))
}</pre></div>
<ol start="2">
<li>解析请求头</li>
</ol>
<div class="highlight highlight-source-go"><pre><span class="pl-c">// ReqHeaderLine 请求头首行</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeaderLine</span> <span class="pl-k">struct</span> {
    <span class="pl-c1">Method</span>   <span class="pl-smi">string</span>
    <span class="pl-c1">Url</span>      <span class="pl-smi">string</span>
    <span class="pl-c1">Protocol</span> <span class="pl-smi">string</span>
}

<span class="pl-c">// ReqHeaderBody 请求头body</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeaderBody</span> <span class="pl-k">struct</span> {
    <span class="pl-c1">Body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}
}

<span class="pl-c">// ReqHeader 请求头</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeader</span> <span class="pl-k">struct</span> {
    <span class="pl-smi">ReqHeaderLine</span>
    <span class="pl-smi">ReqHeaderBody</span>
}

<span class="pl-c">// ParseHttpRequestFirstLine 解析请求头首行</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpRequestFirstLine</span>(<span class="pl-s1">line</span> []<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeaderLine</span> {
	<span class="pl-s1">re</span> <span class="pl-c1">:=</span> <span class="pl-s1">regexp</span>.<span class="pl-en">MustCompile</span>(<span class="pl-s">`([A-Z]+)\s(/.*)\s(HTTP/1.[0-1]+)$`</span>)
	<span class="pl-s1">matched</span> <span class="pl-c1">:=</span> <span class="pl-s1">re</span>.<span class="pl-en">FindStringSubmatch</span>(<span class="pl-en">string</span>(<span class="pl-s1">line</span>))
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">matched</span>) <span class="pl-c1">!=</span> <span class="pl-c1">4</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"parse request header error"</span>))
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeaderLine</span>{
		<span class="pl-c1">Method</span>:   <span class="pl-s1">matched</span>[<span class="pl-c1">1</span>],
		<span class="pl-c1">Url</span>:      <span class="pl-s1">matched</span>[<span class="pl-c1">2</span>],
		<span class="pl-c1">Protocol</span>: <span class="pl-s1">matched</span>[<span class="pl-c1">3</span>],
	}
}

<span class="pl-c">// ParseHttpRequestLine 解析请求头</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpRequestLine</span>(<span class="pl-s1">lines</span> <span class="pl-c1">...</span>[]<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeaderBody</span> {
	<span class="pl-k">var</span> <span class="pl-s1">body</span> <span class="pl-c1">=</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}{}
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">line</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">lines</span> {
		<span class="pl-s1">lineSlice</span> <span class="pl-c1">:=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Split</span>(<span class="pl-en">string</span>(<span class="pl-s1">line</span>), <span class="pl-s">": "</span>)
		<span class="pl-s1">body</span>[<span class="pl-s1">lineSlice</span>[<span class="pl-c1">0</span>]] <span class="pl-c1">=</span> <span class="pl-s1">lineSlice</span>[<span class="pl-c1">1</span>]
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeaderBody</span>{
		<span class="pl-c1">Body</span>: <span class="pl-s1">body</span>,
	}
}

<span class="pl-c">// ParseHttpHeader 解析请求头</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpHeader</span>(<span class="pl-s1">reqData</span> []<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span> {
	<span class="pl-s1">reqHeaderWithBody</span> <span class="pl-c1">:=</span> <span class="pl-s1">bytes</span>.<span class="pl-en">Split</span>(<span class="pl-s1">reqData</span>, []<span class="pl-smi">byte</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span><span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>))
	<span class="pl-s1">reqHeader</span> <span class="pl-c1">:=</span> <span class="pl-s1">bytes</span>.<span class="pl-en">Split</span>(<span class="pl-s1">reqHeaderWithBody</span>[<span class="pl-c1">0</span>], []<span class="pl-smi">byte</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>))
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">reqHeader</span>) <span class="pl-c1">&lt;</span> <span class="pl-c1">1</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"request header parse error"</span>))
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeader</span>{
		<span class="pl-c1">ReqHeaderLine</span>: <span class="pl-c1">*</span><span class="pl-en">ParseHttpRequestFirstLine</span>(<span class="pl-s1">reqHeader</span>[<span class="pl-c1">0</span>]),
		<span class="pl-c1">ReqHeaderBody</span>: <span class="pl-c1">*</span><span class="pl-en">ParseHttpRequestLine</span>(<span class="pl-s1">reqHeader</span>[<span class="pl-c1">1</span>:]<span class="pl-c1">...</span>),
	}
}</pre></div>
<ol start="3">
<li>返回响应体</li>
</ol>
<div class="highlight highlight-source-go"><pre><span class="pl-c">// RespHeaderLine 响应头首行</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeaderLine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Protocol</span> <span class="pl-smi">string</span>
	<span class="pl-c1">Code</span>     <span class="pl-smi">int</span>
	<span class="pl-c1">Desc</span>     <span class="pl-smi">string</span>
}

<span class="pl-c">// RespHeaderBody 响应头body</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeaderBody</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}
}

<span class="pl-c">// RespHeader 响应头</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeader</span> <span class="pl-k">struct</span> {
	<span class="pl-smi">RespHeaderLine</span>
	<span class="pl-smi">RespHeaderBody</span>
}

<span class="pl-c">// InitHttpResponseHeader 写入响应头</span>
<span class="pl-k">func</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>) <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span> {
    <span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">RespHeader</span>{
        <span class="pl-smi">RespHeaderLine</span>{<span class="pl-c1">Protocol</span>: <span class="pl-s1">r</span>.<span class="pl-c1">Protocol</span>},
        <span class="pl-smi">RespHeaderBody</span>{<span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}{
			<span class="pl-s">"Server"</span>: <span class="pl-s">"Go1.19"</span>,
		}},
    }
}

<span class="pl-c">// SetResponseHeader 设置响应头</span>
<span class="pl-k">func</span> <span class="pl-en">SetResponseHeader</span>(<span class="pl-s1">resp</span> <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span>, <span class="pl-s1">code</span> <span class="pl-smi">int</span>) <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span> {
    <span class="pl-s1">resp</span>.<span class="pl-c1">Code</span> <span class="pl-c1">=</span> <span class="pl-s1">HttpStatusCodeMap</span>[<span class="pl-s1">code</span>].<span class="pl-c1">Code</span>
    <span class="pl-s1">resp</span>.<span class="pl-c1">Desc</span> <span class="pl-c1">=</span> <span class="pl-s1">HttpStatusCodeMap</span>[<span class="pl-s1">code</span>].<span class="pl-c1">Desc</span>
    <span class="pl-k">return</span> <span class="pl-s1">resp</span>
}

<span class="pl-c">// ResponseToString 响应转string</span>
<span class="pl-k">func</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span>, <span class="pl-s1">body</span> <span class="pl-smi">string</span>) <span class="pl-c1">*</span>strings.<span class="pl-smi">Builder</span> {
    <span class="pl-c">// 设置响应体长度</span>
    <span class="pl-s1">r</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Length"</span>] <span class="pl-c1">=</span> <span class="pl-s1">strconv</span>.<span class="pl-en">Itoa</span>(<span class="pl-en">len</span>(<span class="pl-s1">body</span>))
    
    <span class="pl-s1">header</span> <span class="pl-c1">:=</span> <span class="pl-c1">&amp;</span>strings.<span class="pl-smi">Builder</span>{}
    <span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s %d %s<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Protocol</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Code</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Desc</span>))
    <span class="pl-k">for</span> <span class="pl-s1">k</span>, <span class="pl-s1">v</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">r</span>.<span class="pl-c1">Body</span> {
    <span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s: %s<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>, <span class="pl-s1">k</span>, <span class="pl-s1">v</span>.(<span class="pl-smi">string</span>)))
    }
    <span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>)
    <span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">body</span>)
    <span class="pl-k">return</span> <span class="pl-s1">header</span>
}</pre></div>
<ol start="4">
<li>完整实现</li>
</ol>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"bytes"</span>
	<span class="pl-s">"errors"</span>
	<span class="pl-s">"fmt"</span>
	<span class="pl-s">"log"</span>
	<span class="pl-s">"net"</span>
	<span class="pl-s">"regexp"</span>
	<span class="pl-s">"strconv"</span>
	<span class="pl-s">"strings"</span>
	<span class="pl-s">"time"</span>
)

<span class="pl-k">var</span> (
	<span class="pl-s1">Port</span>              <span class="pl-c1">=</span> <span class="pl-s">":7256"</span>
	<span class="pl-s1">MaxHeaderSize</span>     <span class="pl-c1">=</span> <span class="pl-c1">1</span> <span class="pl-c1">&lt;&lt;</span> <span class="pl-c1">10</span>
	<span class="pl-s1">ReadHeaderSize</span>    <span class="pl-c1">=</span> <span class="pl-c1">1</span> <span class="pl-c1">&lt;&lt;</span> <span class="pl-c1">8</span>
	<span class="pl-s1">HttpStatusCodeMap</span> <span class="pl-c1">=</span> <span class="pl-smi">HttpStatusMap</span>{
		<span class="pl-c1">100</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">100</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Continue"</span>},
		<span class="pl-c1">200</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">200</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"OK"</span>},
		<span class="pl-c1">301</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">301</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Moved Permanently"</span>},
		<span class="pl-c1">400</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">400</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Bad Request"</span>},
		<span class="pl-c1">403</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">403</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Forbidden"</span>},
		<span class="pl-c1">404</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">404</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Not Found"</span>},
		<span class="pl-c1">405</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">405</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Method Not Allowed"</span>},
		<span class="pl-c1">500</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">500</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Internal Server Error"</span>},
		<span class="pl-c1">502</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">502</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Bad Gateway"</span>},
	}
)

<span class="pl-c">// ReqHeaderLine 请求头首行</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeaderLine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Method</span>   <span class="pl-smi">string</span>
	<span class="pl-c1">Url</span>      <span class="pl-smi">string</span>
	<span class="pl-c1">Protocol</span> <span class="pl-smi">string</span>
}

<span class="pl-c">// ReqHeaderBody 请求头body</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeaderBody</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}
}

<span class="pl-c">// ReqHeader 请求头</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeader</span> <span class="pl-k">struct</span> {
	<span class="pl-smi">ReqHeaderLine</span>
	<span class="pl-smi">ReqHeaderBody</span>
}

<span class="pl-c">// RespHeaderLine 响应头首行</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeaderLine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Protocol</span> <span class="pl-smi">string</span>
	<span class="pl-c1">Code</span>     <span class="pl-smi">int</span>
	<span class="pl-c1">Desc</span>     <span class="pl-smi">string</span>
}

<span class="pl-c">// RespHeaderBody 响应头body</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeaderBody</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}
}

<span class="pl-c">// RespHeader 响应头</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeader</span> <span class="pl-k">struct</span> {
	<span class="pl-smi">RespHeaderLine</span>
	<span class="pl-smi">RespHeaderBody</span>
}

<span class="pl-c">// HttpStatus http状态码</span>
<span class="pl-k">type</span> <span class="pl-smi">HttpStatus</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Code</span> <span class="pl-smi">int</span>
	<span class="pl-c1">Desc</span> <span class="pl-smi">string</span>
}

<span class="pl-c">// HttpStatusMap http状态码集合</span>
<span class="pl-k">type</span> <span class="pl-smi">HttpStatusMap</span> <span class="pl-k">map</span>[<span class="pl-smi">int</span>]<span class="pl-smi">HttpStatus</span>

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-c">// 监听端口</span>
	<span class="pl-s1">listen</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">net</span>.<span class="pl-en">Listen</span>(<span class="pl-s">"tcp"</span>, <span class="pl-s1">Port</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create listen error "</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
	}
	<span class="pl-k">for</span> {
		<span class="pl-c">// 等待获取一个连接对象</span>
		<span class="pl-s1">conn</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">listen</span>.<span class="pl-en">Accept</span>()
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create conn error"</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
		}
		<span class="pl-c">// 基于协程进行当前连接对象的处理</span>
		<span class="pl-k">go</span> <span class="pl-en">Handle</span>(<span class="pl-s1">conn</span>)
	}
}

<span class="pl-k">func</span> <span class="pl-en">Handle</span>(<span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-s1">start</span> <span class="pl-c1">:=</span> <span class="pl-s1">time</span>.<span class="pl-en">Now</span>()
	<span class="pl-s1">header</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-c1">0</span>, <span class="pl-s1">MaxHeaderSize</span>)
	<span class="pl-k">for</span> {
		<span class="pl-s1">headerRead</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-s1">ReadHeaderSize</span>)
		<span class="pl-s1">n</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Read</span>(<span class="pl-s1">headerRead</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">return</span>
		}

		<span class="pl-s1">header</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">header</span>, <span class="pl-s1">headerRead</span><span class="pl-c1">...</span>)
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"read data value length: "</span>, <span class="pl-s1">n</span>)
		<span class="pl-k">if</span> <span class="pl-s1">n</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">ReadHeaderSize</span> {
			<span class="pl-k">break</span>
		}
	}
	<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"use time total: "</span>, <span class="pl-s1">time</span>.<span class="pl-en">Since</span>(<span class="pl-s1">start</span>))
	<span class="pl-c">// 解析请求头</span>
	<span class="pl-s1">headers</span> <span class="pl-c1">:=</span> <span class="pl-en">ParseHttpHeader</span>(<span class="pl-s1">header</span>)
	<span class="pl-c">// 写入响应头</span>
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">:=</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">headers</span>)
	<span class="pl-c">// 设置响应头状态码</span>
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeader</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">200</span>)
	<span class="pl-c">// 拼装响应头</span>
	<span class="pl-s1">responseBody</span> <span class="pl-c1">:=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s">"hello world"</span>)
	<span class="pl-c">// 设置响应体</span>
	<span class="pl-s1">n</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">responseBody</span>.<span class="pl-en">String</span>()))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-k">return</span>
	}
	<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"http headers:"</span>, <span class="pl-s1">n</span>)
}

<span class="pl-c">// ParseHttpRequestFirstLine 解析请求头首行</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpRequestFirstLine</span>(<span class="pl-s1">line</span> []<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeaderLine</span> {
	<span class="pl-s1">re</span> <span class="pl-c1">:=</span> <span class="pl-s1">regexp</span>.<span class="pl-en">MustCompile</span>(<span class="pl-s">`([A-Z]+)\s(/.*)\s(HTTP/1.[0-1]+)$`</span>)
	<span class="pl-s1">matched</span> <span class="pl-c1">:=</span> <span class="pl-s1">re</span>.<span class="pl-en">FindStringSubmatch</span>(<span class="pl-en">string</span>(<span class="pl-s1">line</span>))
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">matched</span>) <span class="pl-c1">!=</span> <span class="pl-c1">4</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"parse request header error"</span>))
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeaderLine</span>{
		<span class="pl-c1">Method</span>:   <span class="pl-s1">matched</span>[<span class="pl-c1">1</span>],
		<span class="pl-c1">Url</span>:      <span class="pl-s1">matched</span>[<span class="pl-c1">2</span>],
		<span class="pl-c1">Protocol</span>: <span class="pl-s1">matched</span>[<span class="pl-c1">3</span>],
	}
}

<span class="pl-c">// ParseHttpRequestLine 解析请求头</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpRequestLine</span>(<span class="pl-s1">lines</span> <span class="pl-c1">...</span>[]<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeaderBody</span> {
	<span class="pl-k">var</span> <span class="pl-s1">body</span> <span class="pl-c1">=</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}{}
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">line</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">lines</span> {
		<span class="pl-s1">lineSlice</span> <span class="pl-c1">:=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Split</span>(<span class="pl-en">string</span>(<span class="pl-s1">line</span>), <span class="pl-s">": "</span>)
		<span class="pl-s1">body</span>[<span class="pl-s1">lineSlice</span>[<span class="pl-c1">0</span>]] <span class="pl-c1">=</span> <span class="pl-s1">lineSlice</span>[<span class="pl-c1">1</span>]
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeaderBody</span>{
		<span class="pl-c1">Body</span>: <span class="pl-s1">body</span>,
	}
}

<span class="pl-c">// ParseHttpHeader 解析请求头</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpHeader</span>(<span class="pl-s1">reqData</span> []<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span> {
	<span class="pl-s1">reqHeaderWithBody</span> <span class="pl-c1">:=</span> <span class="pl-s1">bytes</span>.<span class="pl-en">Split</span>(<span class="pl-s1">reqData</span>, []<span class="pl-smi">byte</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span><span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>))
	<span class="pl-s1">reqHeader</span> <span class="pl-c1">:=</span> <span class="pl-s1">bytes</span>.<span class="pl-en">Split</span>(<span class="pl-s1">reqHeaderWithBody</span>[<span class="pl-c1">0</span>], []<span class="pl-smi">byte</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>))
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">reqHeader</span>) <span class="pl-c1">&lt;</span> <span class="pl-c1">1</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"request header parse error"</span>))
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeader</span>{
		<span class="pl-c1">ReqHeaderLine</span>: <span class="pl-c1">*</span><span class="pl-en">ParseHttpRequestFirstLine</span>(<span class="pl-s1">reqHeader</span>[<span class="pl-c1">0</span>]),
		<span class="pl-c1">ReqHeaderBody</span>: <span class="pl-c1">*</span><span class="pl-en">ParseHttpRequestLine</span>(<span class="pl-s1">reqHeader</span>[<span class="pl-c1">1</span>:]<span class="pl-c1">...</span>),
	}
}

<span class="pl-c">// InitHttpResponseHeader 写入响应头</span>
<span class="pl-k">func</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>) <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">RespHeader</span>{
		<span class="pl-smi">RespHeaderLine</span>{<span class="pl-c1">Protocol</span>: <span class="pl-s1">r</span>.<span class="pl-c1">Protocol</span>},
		<span class="pl-smi">RespHeaderBody</span>{<span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}{
			<span class="pl-s">"Server"</span>: <span class="pl-s">"Go1.19"</span>,
		}},
	}
}

<span class="pl-c">// SetResponseHeader 设置响应头</span>
<span class="pl-k">func</span> <span class="pl-en">SetResponseHeader</span>(<span class="pl-s1">resp</span> <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span>, <span class="pl-s1">code</span> <span class="pl-smi">int</span>) <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span> {
	<span class="pl-s1">resp</span>.<span class="pl-c1">Code</span> <span class="pl-c1">=</span> <span class="pl-s1">HttpStatusCodeMap</span>[<span class="pl-s1">code</span>].<span class="pl-c1">Code</span>
	<span class="pl-s1">resp</span>.<span class="pl-c1">Desc</span> <span class="pl-c1">=</span> <span class="pl-s1">HttpStatusCodeMap</span>[<span class="pl-s1">code</span>].<span class="pl-c1">Desc</span>
	<span class="pl-k">return</span> <span class="pl-s1">resp</span>
}

<span class="pl-c">// ResponseToString 响应转string</span>
<span class="pl-k">func</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span>, <span class="pl-s1">body</span> <span class="pl-smi">string</span>) <span class="pl-c1">*</span>strings.<span class="pl-smi">Builder</span> {
	<span class="pl-c">// 设置响应体长度</span>
	<span class="pl-s1">r</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Length"</span>] <span class="pl-c1">=</span> <span class="pl-s1">strconv</span>.<span class="pl-en">Itoa</span>(<span class="pl-en">len</span>(<span class="pl-s1">body</span>))

	<span class="pl-s1">header</span> <span class="pl-c1">:=</span> <span class="pl-c1">&amp;</span>strings.<span class="pl-smi">Builder</span>{}
	<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s %d %s<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Protocol</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Code</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Desc</span>))
	<span class="pl-k">for</span> <span class="pl-s1">k</span>, <span class="pl-s1">v</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">r</span>.<span class="pl-c1">Body</span> {
		<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s: %s<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>, <span class="pl-s1">k</span>, <span class="pl-s1">v</span>.(<span class="pl-smi">string</span>)))
	}
	<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>)
	<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">body</span>)
	<span class="pl-k">return</span> <span class="pl-s1">header</span>
}</pre></div>
<h3><a id="user-content-四手搓url重定向功能" class="anchor" aria-hidden="true" href="#四手搓url重定向功能"><span aria-hidden="true" class="octicon octicon-link"></span></a>四、手搓URL重定向功能</h3>
<ol>
<li>简易实现</li>
</ol>
<p>效果图:
<a target="_blank" rel="noopener noreferrer" href="images/2023-03-15-07-35-20.png"><img src="images/2023-03-15-07-35-20.png" alt="" style="max-width: 100%;"></a></p>
<p>代码:</p>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"bytes"</span>
	<span class="pl-s">"encoding/base64"</span>
	<span class="pl-s">"errors"</span>
	<span class="pl-s">"fmt"</span>
	<span class="pl-s">"log"</span>
	<span class="pl-s">"math/rand"</span>
	<span class="pl-s">"net"</span>
	<span class="pl-s">"net/url"</span>
	<span class="pl-s">"regexp"</span>
	<span class="pl-s">"strconv"</span>
	<span class="pl-s">"strings"</span>
	<span class="pl-s">"sync"</span>
	<span class="pl-s">"time"</span>
)

<span class="pl-k">var</span> (
	<span class="pl-s1">Schema</span>         <span class="pl-c1">=</span> <span class="pl-s">"http"</span>
	<span class="pl-s1">Host</span>           <span class="pl-c1">=</span> <span class="pl-s">"127.0.0.1"</span>
	<span class="pl-s1">Port</span>           <span class="pl-c1">=</span> <span class="pl-s">":7256"</span>
	<span class="pl-s1">MaxHeaderSize</span>  <span class="pl-c1">=</span> <span class="pl-c1">1</span> <span class="pl-c1">&lt;&lt;</span> <span class="pl-c1">10</span>
	<span class="pl-s1">ReadHeaderSize</span> <span class="pl-c1">=</span> <span class="pl-c1">1</span> <span class="pl-c1">&lt;&lt;</span> <span class="pl-c1">8</span>
	<span class="pl-s1">IndexHtml</span>      <span class="pl-c1">=</span> <span class="pl-s">"&lt;!DOCTYPE html&gt;<span class="pl-cce">\n</span>&lt;html lang=<span class="pl-cce">\"</span>en<span class="pl-cce">\"</span>&gt;<span class="pl-cce">\n</span>&lt;head&gt;<span class="pl-cce">\n</span>    &lt;meta charset=<span class="pl-cce">\"</span>UTF-8<span class="pl-cce">\"</span>&gt;<span class="pl-cce">\n</span>    &lt;title&gt;短连接生成器&lt;/title&gt;<span class="pl-cce">\n</span>&lt;/head&gt;<span class="pl-cce">\n</span>&lt;body&gt;<span class="pl-cce">\n</span>&lt;form action=<span class="pl-cce">\"</span>/<span class="pl-cce">\"</span> method=<span class="pl-cce">\"</span>post<span class="pl-cce">\"</span>&gt;<span class="pl-cce">\n</span>    &lt;label&gt;<span class="pl-cce">\n</span>        &lt;input type=<span class="pl-cce">\"</span>text<span class="pl-cce">\"</span> name=<span class="pl-cce">\"</span>url<span class="pl-cce">\"</span>/&gt;<span class="pl-cce">\n</span>    &lt;/label&gt;<span class="pl-cce">\n</span>    &lt;input type=<span class="pl-cce">\"</span>submit<span class="pl-cce">\"</span> value=<span class="pl-cce">\"</span>提交<span class="pl-cce">\"</span>&gt;<span class="pl-cce">\n</span>&lt;/form&gt;<span class="pl-cce">\n</span>&lt;/body&gt;<span class="pl-cce">\n</span>&lt;/html&gt;"</span>
	<span class="pl-s1">PathUnescape</span>   <span class="pl-c1">=</span> <span class="pl-s1">url</span>.<span class="pl-c1">PathUnescape</span>
	<span class="pl-s1">UrlMap</span>         <span class="pl-c1">=</span> <span class="pl-k">struct</span> {
		<span class="pl-c1">L</span>   sync.<span class="pl-smi">RWMutex</span>
		<span class="pl-c1">Url</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>
	}{
		<span class="pl-c1">Url</span>: <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>{},
	}
	<span class="pl-s1">HttpStatusCodeMap</span> <span class="pl-c1">=</span> <span class="pl-smi">HttpStatusMap</span>{
		<span class="pl-c1">100</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">100</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Continue"</span>},
		<span class="pl-c1">200</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">200</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"OK"</span>},
		<span class="pl-c1">301</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">301</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Moved Permanently"</span>},
		<span class="pl-c1">400</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">400</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Bad Request"</span>},
		<span class="pl-c1">403</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">403</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Forbidden"</span>},
		<span class="pl-c1">404</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">404</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Not Found"</span>},
		<span class="pl-c1">405</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">405</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Method Not Allowed"</span>},
		<span class="pl-c1">500</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">500</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Internal Server Error"</span>},
		<span class="pl-c1">502</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">502</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Bad Gateway"</span>},
	}
)

<span class="pl-c">// UrlGet 获取Url</span>
<span class="pl-k">func</span> <span class="pl-en">UrlGet</span>(<span class="pl-s1">key</span> <span class="pl-smi">string</span>) <span class="pl-smi">string</span> {
	<span class="pl-s1">UrlMap</span>.<span class="pl-c1">L</span>.<span class="pl-en">RLock</span>()
	<span class="pl-k">defer</span> <span class="pl-s1">UrlMap</span>.<span class="pl-c1">L</span>.<span class="pl-en">RUnlock</span>()
	<span class="pl-k">if</span> <span class="pl-s1">value</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">UrlMap</span>.<span class="pl-c1">Url</span>[<span class="pl-s1">key</span>]; <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-s">""</span>
	} <span class="pl-k">else</span> {
		<span class="pl-k">return</span> <span class="pl-s1">value</span>
	}
}

<span class="pl-c">// UrlSet 设置Url</span>
<span class="pl-k">func</span> <span class="pl-en">UrlSet</span>(<span class="pl-s1">key</span>, <span class="pl-s1">value</span> <span class="pl-smi">string</span>) <span class="pl-smi">bool</span> {
	<span class="pl-k">if</span> <span class="pl-s1">_</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">UrlMap</span>.<span class="pl-c1">Url</span>[<span class="pl-s1">key</span>]; <span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-c1">false</span>
	}
	<span class="pl-s1">UrlMap</span>.<span class="pl-c1">L</span>.<span class="pl-en">Lock</span>()
	<span class="pl-k">defer</span> <span class="pl-s1">UrlMap</span>.<span class="pl-c1">L</span>.<span class="pl-en">Unlock</span>()
	<span class="pl-k">if</span> <span class="pl-c1">!</span><span class="pl-s1">strings</span>.<span class="pl-en">HasPrefix</span>(<span class="pl-s1">value</span>, <span class="pl-s">"http"</span>) {
		<span class="pl-s1">value</span> <span class="pl-c1">=</span> <span class="pl-s">"http://"</span> <span class="pl-c1">+</span> <span class="pl-s1">value</span>
	}
	<span class="pl-s1">UrlMap</span>.<span class="pl-c1">Url</span>[<span class="pl-s1">key</span>] <span class="pl-c1">=</span> <span class="pl-s1">value</span>
	<span class="pl-k">return</span> <span class="pl-c1">true</span>
}

<span class="pl-c">// ReqHeaderLine 请求头首行</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeaderLine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Method</span>   <span class="pl-smi">string</span>
	<span class="pl-c1">Url</span>      <span class="pl-smi">string</span>
	<span class="pl-c1">Protocol</span> <span class="pl-smi">string</span>
}

<span class="pl-c">// ReqHeaderBody 请求头body</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeaderBody</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}
}

<span class="pl-c">// ReqHeader 请求头</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeader</span> <span class="pl-k">struct</span> {
	<span class="pl-smi">ReqHeaderLine</span>
	<span class="pl-smi">ReqHeaderBody</span>
}

<span class="pl-c">// RespHeaderLine 响应头首行</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeaderLine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Protocol</span> <span class="pl-smi">string</span>
	<span class="pl-c1">Code</span>     <span class="pl-smi">int</span>
	<span class="pl-c1">Desc</span>     <span class="pl-smi">string</span>
}

<span class="pl-c">// RespHeaderBody 响应头body</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeaderBody</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}
}

<span class="pl-c">// RespHeader 响应头</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeader</span> <span class="pl-k">struct</span> {
	<span class="pl-smi">RespHeaderLine</span>
	<span class="pl-smi">RespHeaderBody</span>
}

<span class="pl-c">// HttpStatus http状态码</span>
<span class="pl-k">type</span> <span class="pl-smi">HttpStatus</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Code</span> <span class="pl-smi">int</span>
	<span class="pl-c1">Desc</span> <span class="pl-smi">string</span>
}

<span class="pl-c">// HttpStatusMap http状态码集合</span>
<span class="pl-k">type</span> <span class="pl-smi">HttpStatusMap</span> <span class="pl-k">map</span>[<span class="pl-smi">int</span>]<span class="pl-smi">HttpStatus</span>

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-c">// 监听端口</span>
	<span class="pl-s1">listen</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">net</span>.<span class="pl-en">Listen</span>(<span class="pl-s">"tcp"</span>, <span class="pl-s1">Port</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create listen error "</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
	}
	<span class="pl-k">for</span> {
		<span class="pl-c">// 等待获取一个连接对象</span>
		<span class="pl-s1">conn</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">listen</span>.<span class="pl-en">Accept</span>()
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create conn error"</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
		}
		<span class="pl-c">// 基于协程进行当前连接对象的处理</span>
		<span class="pl-k">go</span> <span class="pl-en">Handle</span>(<span class="pl-s1">conn</span>)
	}
}

<span class="pl-k">func</span> <span class="pl-en">Handle</span>(<span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-s1">start</span> <span class="pl-c1">:=</span> <span class="pl-s1">time</span>.<span class="pl-en">Now</span>()
	<span class="pl-s1">header</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-c1">0</span>, <span class="pl-s1">MaxHeaderSize</span>)
	<span class="pl-k">for</span> {
		<span class="pl-s1">headerRead</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-s1">ReadHeaderSize</span>)
		<span class="pl-s1">n</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Read</span>(<span class="pl-s1">headerRead</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">return</span>
		}

		<span class="pl-s1">header</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">header</span>, <span class="pl-s1">headerRead</span><span class="pl-c1">...</span>)
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"read data value length: "</span>, <span class="pl-s1">n</span>)
		<span class="pl-k">if</span> <span class="pl-s1">n</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">ReadHeaderSize</span> {
			<span class="pl-k">break</span>
		}
	}
	<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"use time total: "</span>, <span class="pl-s1">time</span>.<span class="pl-en">Since</span>(<span class="pl-s1">start</span>))
	<span class="pl-c">// 解析请求头</span>
	<span class="pl-s1">headers</span>, <span class="pl-s1">body</span> <span class="pl-c1">:=</span> <span class="pl-en">ParseHttpHeader</span>(<span class="pl-s1">header</span>)

	<span class="pl-s1">err</span>, <span class="pl-s1">m</span> <span class="pl-c1">:=</span> <span class="pl-en">ParseRequestBody</span>(<span class="pl-s1">headers</span>, <span class="pl-s1">body</span>)

	<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s1">m</span>, <span class="pl-s1">err</span>)

	<span class="pl-k">switch</span> <span class="pl-s1">headers</span>.<span class="pl-c1">Method</span> {
	<span class="pl-k">case</span> <span class="pl-s">"GET"</span>:
		<span class="pl-en">DoGet</span>(<span class="pl-s1">headers</span>, <span class="pl-c1">nil</span>, <span class="pl-s1">conn</span>)
	<span class="pl-k">case</span> <span class="pl-s">"POST"</span>:
		<span class="pl-en">DoPost</span>(<span class="pl-s1">headers</span>, <span class="pl-s1">m</span>, <span class="pl-s1">conn</span>)
	<span class="pl-k">default</span>:
		<span class="pl-en">Abort</span>(<span class="pl-s1">headers</span>, <span class="pl-s1">conn</span>)
	}
}

<span class="pl-c">// ParseHttpRequestFirstLine 解析请求头首行</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpRequestFirstLine</span>(<span class="pl-s1">line</span> []<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeaderLine</span> {
	<span class="pl-s1">re</span> <span class="pl-c1">:=</span> <span class="pl-s1">regexp</span>.<span class="pl-en">MustCompile</span>(<span class="pl-s">`([A-Z]+)\s(/.*)\s(HTTP/1.[0-1]+)$`</span>)
	<span class="pl-s1">matched</span> <span class="pl-c1">:=</span> <span class="pl-s1">re</span>.<span class="pl-en">FindStringSubmatch</span>(<span class="pl-en">string</span>(<span class="pl-s1">line</span>))
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">matched</span>) <span class="pl-c1">!=</span> <span class="pl-c1">4</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"parse request header error"</span>))
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeaderLine</span>{
		<span class="pl-c1">Method</span>:   <span class="pl-s1">matched</span>[<span class="pl-c1">1</span>],
		<span class="pl-c1">Url</span>:      <span class="pl-s1">matched</span>[<span class="pl-c1">2</span>],
		<span class="pl-c1">Protocol</span>: <span class="pl-s1">matched</span>[<span class="pl-c1">3</span>],
	}
}

<span class="pl-c">// ParseHttpRequestLine 解析请求头</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpRequestLine</span>(<span class="pl-s1">lines</span> <span class="pl-c1">...</span>[]<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeaderBody</span> {
	<span class="pl-k">var</span> <span class="pl-s1">body</span> <span class="pl-c1">=</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}{}
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">line</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">lines</span> {
		<span class="pl-s1">lineSlice</span> <span class="pl-c1">:=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Split</span>(<span class="pl-en">string</span>(<span class="pl-s1">line</span>), <span class="pl-s">": "</span>)
		<span class="pl-s1">body</span>[<span class="pl-s1">lineSlice</span>[<span class="pl-c1">0</span>]] <span class="pl-c1">=</span> <span class="pl-s1">lineSlice</span>[<span class="pl-c1">1</span>]
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeaderBody</span>{
		<span class="pl-c1">Body</span>: <span class="pl-s1">body</span>,
	}
}

<span class="pl-c">// ParseHttpHeader 解析请求头</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpHeader</span>(<span class="pl-s1">reqData</span> []<span class="pl-smi">byte</span>) (<span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, []<span class="pl-smi">byte</span>) {
	<span class="pl-s1">reqHeaderWithBody</span> <span class="pl-c1">:=</span> <span class="pl-s1">bytes</span>.<span class="pl-en">Split</span>(<span class="pl-s1">reqData</span>, []<span class="pl-smi">byte</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span><span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>))
	<span class="pl-s1">reqHeader</span> <span class="pl-c1">:=</span> <span class="pl-s1">bytes</span>.<span class="pl-en">Split</span>(<span class="pl-s1">reqHeaderWithBody</span>[<span class="pl-c1">0</span>], []<span class="pl-smi">byte</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>))
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">reqHeader</span>) <span class="pl-c1">&lt;</span> <span class="pl-c1">1</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"request header parse error"</span>))
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeader</span>{
		<span class="pl-c1">ReqHeaderLine</span>: <span class="pl-c1">*</span><span class="pl-en">ParseHttpRequestFirstLine</span>(<span class="pl-s1">reqHeader</span>[<span class="pl-c1">0</span>]),
		<span class="pl-c1">ReqHeaderBody</span>: <span class="pl-c1">*</span><span class="pl-en">ParseHttpRequestLine</span>(<span class="pl-s1">reqHeader</span>[<span class="pl-c1">1</span>:]<span class="pl-c1">...</span>),
	}, <span class="pl-s1">reqHeaderWithBody</span>[<span class="pl-c1">1</span>]
}

<span class="pl-c">// InitHttpResponseHeader 写入响应头</span>
<span class="pl-k">func</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>) <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">RespHeader</span>{
		<span class="pl-smi">RespHeaderLine</span>{<span class="pl-c1">Protocol</span>: <span class="pl-s1">r</span>.<span class="pl-c1">Protocol</span>},
		<span class="pl-smi">RespHeaderBody</span>{<span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}{
			<span class="pl-s">"Server"</span>: <span class="pl-s">"Go1.19"</span>,
		}},
	}
}

<span class="pl-c">// SetResponseHeaderCode 设置响应头</span>
<span class="pl-k">func</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">resp</span> <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span>, <span class="pl-s1">code</span> <span class="pl-smi">int</span>) <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span> {
	<span class="pl-s1">resp</span>.<span class="pl-c1">Code</span> <span class="pl-c1">=</span> <span class="pl-s1">HttpStatusCodeMap</span>[<span class="pl-s1">code</span>].<span class="pl-c1">Code</span>
	<span class="pl-s1">resp</span>.<span class="pl-c1">Desc</span> <span class="pl-c1">=</span> <span class="pl-s1">HttpStatusCodeMap</span>[<span class="pl-s1">code</span>].<span class="pl-c1">Desc</span>
	<span class="pl-k">return</span> <span class="pl-s1">resp</span>
}

<span class="pl-c">// ResponseToString 响应转string</span>
<span class="pl-k">func</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span>, <span class="pl-s1">body</span> <span class="pl-smi">string</span>) <span class="pl-c1">*</span>strings.<span class="pl-smi">Builder</span> {
	<span class="pl-c">// 设置响应体长度</span>
	<span class="pl-s1">r</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Length"</span>] <span class="pl-c1">=</span> <span class="pl-s1">strconv</span>.<span class="pl-en">Itoa</span>(<span class="pl-en">len</span>(<span class="pl-s1">body</span>))

	<span class="pl-s1">header</span> <span class="pl-c1">:=</span> <span class="pl-c1">&amp;</span>strings.<span class="pl-smi">Builder</span>{}
	<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s %d %s<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Protocol</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Code</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Desc</span>))
	<span class="pl-k">for</span> <span class="pl-s1">k</span>, <span class="pl-s1">v</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">r</span>.<span class="pl-c1">Body</span> {
		<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s: %s<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>, <span class="pl-s1">k</span>, <span class="pl-s1">v</span>.(<span class="pl-smi">string</span>)))
	}
	<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>)
	<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">body</span>)
	<span class="pl-k">return</span> <span class="pl-s1">header</span>
}

<span class="pl-c">// ParseFormUrlencoded application/x-www-form-urlencoded</span>
<span class="pl-k">func</span> <span class="pl-en">ParseFormUrlencoded</span>(<span class="pl-s1">bodyStr</span> <span class="pl-smi">string</span>) <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span> {
	<span class="pl-s1">bodyStrSlice</span> <span class="pl-c1">:=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Split</span>(<span class="pl-s1">bodyStr</span>, <span class="pl-s">"&amp;"</span>)
	<span class="pl-s1">bodyMap</span> <span class="pl-c1">:=</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>{}
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">bodykv</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">bodyStrSlice</span> {
		<span class="pl-s1">kvSlice</span> <span class="pl-c1">:=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Split</span>(<span class="pl-s1">bodykv</span>, <span class="pl-s">"="</span>)
		<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">kvSlice</span>) <span class="pl-c1">&gt;=</span> <span class="pl-c1">2</span> {
			<span class="pl-s1">bodyMap</span>[<span class="pl-s1">kvSlice</span>[<span class="pl-c1">0</span>]] <span class="pl-c1">=</span> <span class="pl-s1">kvSlice</span>[<span class="pl-c1">1</span>]
		} <span class="pl-k">else</span> {
			<span class="pl-s1">bodyMap</span>[<span class="pl-s1">kvSlice</span>[<span class="pl-c1">0</span>]] <span class="pl-c1">=</span> <span class="pl-s">""</span>
		}
	}
	<span class="pl-k">return</span> <span class="pl-s1">bodyMap</span>
}

<span class="pl-c">// ParseRequestBody 解析请求体</span>
<span class="pl-k">func</span> <span class="pl-en">ParseRequestBody</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, <span class="pl-s1">body</span> []<span class="pl-smi">byte</span>) (<span class="pl-s1">error</span>, <span class="pl-s1">map</span>[<span class="pl-s1">string</span>]<span class="pl-smi">string</span>) {
	<span class="pl-s1">value</span> <span class="pl-c1">:=</span> <span class="pl-c1">0</span>
	<span class="pl-k">if</span> <span class="pl-s1">v</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Length"</span>]; <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"error"</span>), <span class="pl-c1">nil</span>
	} <span class="pl-k">else</span> {
		<span class="pl-s1">value</span>, <span class="pl-s1">_</span> <span class="pl-c1">=</span> <span class="pl-s1">strconv</span>.<span class="pl-en">Atoi</span>(<span class="pl-s1">v</span>.(<span class="pl-smi">string</span>))
	}
	<span class="pl-s1">bodyStr</span> <span class="pl-c1">:=</span> <span class="pl-en">string</span>(<span class="pl-s1">body</span>[:<span class="pl-s1">value</span>])

	<span class="pl-k">if</span> <span class="pl-s1">cType</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Type"</span>]; <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"error Content-Type"</span>), <span class="pl-c1">nil</span>
	} <span class="pl-k">else</span> {
		<span class="pl-c">//application/x-www-form-urlencoded</span>
		<span class="pl-k">if</span> <span class="pl-s1">cType</span> <span class="pl-c1">==</span> <span class="pl-s">"application/x-www-form-urlencoded"</span> {
			<span class="pl-k">return</span> <span class="pl-c1">nil</span>, <span class="pl-en">ParseFormUrlencoded</span>(<span class="pl-s1">bodyStr</span>)
		}
	}
	<span class="pl-k">return</span> <span class="pl-c1">nil</span>, <span class="pl-c1">nil</span>
}

<span class="pl-c">// GenerateRandomKey 生成一个随机key</span>
<span class="pl-k">func</span> <span class="pl-en">GenerateRandomKey</span>() <span class="pl-smi">string</span> {
	<span class="pl-s1">key</span> <span class="pl-c1">:=</span> <span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s-%s"</span>, <span class="pl-s1">strconv</span>.<span class="pl-en">Itoa</span>(<span class="pl-s1">rand</span>.<span class="pl-en">Int</span>()), <span class="pl-s1">time</span>.<span class="pl-en">Now</span>().<span class="pl-en">Format</span>(<span class="pl-s">"2006-01-02 15:04:05"</span>))
	<span class="pl-k">return</span> <span class="pl-s1">base64</span>.<span class="pl-c1">StdEncoding</span>.<span class="pl-en">EncodeToString</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">key</span>))
}

<span class="pl-c">// GetRequestUrlPath 获取请求路径</span>
<span class="pl-k">func</span> <span class="pl-en">GetRequestUrlPath</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>) <span class="pl-smi">string</span> {
	<span class="pl-k">return</span> <span class="pl-s1">r</span>.<span class="pl-c1">Url</span>
}

<span class="pl-k">func</span> <span class="pl-en">DoGet</span>(<span class="pl-s1">headers</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, <span class="pl-s1">body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>, <span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">:=</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">headers</span>)
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">200</span>)
	<span class="pl-k">var</span> <span class="pl-s1">responseBody</span> <span class="pl-c1">*</span>strings.<span class="pl-smi">Builder</span>

	<span class="pl-s1">redirectKey</span> <span class="pl-c1">:=</span> <span class="pl-en">GetRequestUrlPath</span>(<span class="pl-s1">headers</span>)
	<span class="pl-c">// 返回首页</span>
	<span class="pl-k">if</span> <span class="pl-s1">redirectKey</span> <span class="pl-c1">==</span> <span class="pl-s">"/"</span> {
		<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s1">IndexHtml</span>)
	} <span class="pl-k">else</span> {
		<span class="pl-s1">redirectValue</span> <span class="pl-c1">:=</span> <span class="pl-en">UrlGet</span>(<span class="pl-s1">strings</span>.<span class="pl-en">Trim</span>(<span class="pl-s1">redirectKey</span>, <span class="pl-s">"/"</span>))
		<span class="pl-s1">responseHeader</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Location"</span>] <span class="pl-c1">=</span> <span class="pl-s1">redirectValue</span>
		<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">301</span>)
		<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s">""</span>)
	}
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">responseBody</span>.<span class="pl-en">String</span>()))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-k">return</span>
	}
}

<span class="pl-k">func</span> <span class="pl-en">DoPost</span>(<span class="pl-s1">headers</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, <span class="pl-s1">body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>, <span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">:=</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">headers</span>)
	<span class="pl-s1">responseHeader</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Type"</span>] <span class="pl-c1">=</span> <span class="pl-s">"text/html;charset=utf-8"</span>
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">200</span>)
	<span class="pl-k">var</span> <span class="pl-s1">responseBody</span> <span class="pl-c1">*</span>strings.<span class="pl-smi">Builder</span>

	<span class="pl-k">if</span> <span class="pl-s1">v</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">body</span>[<span class="pl-s">"url"</span>]; <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">400</span>)
		<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s">"地址填写异常"</span>)
	} <span class="pl-k">else</span> {
		<span class="pl-s1">key</span> <span class="pl-c1">:=</span> <span class="pl-en">GenerateRandomKey</span>()
		<span class="pl-s1">pathUnescape</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-en">PathUnescape</span>(<span class="pl-s1">v</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-en">panic</span>(<span class="pl-s1">err</span>)
		}
		<span class="pl-s1">status</span> <span class="pl-c1">:=</span> <span class="pl-en">UrlSet</span>(<span class="pl-s1">key</span>, <span class="pl-s1">pathUnescape</span>)
		<span class="pl-k">if</span> <span class="pl-c1">!</span><span class="pl-s1">status</span> {
			<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s">"地址配置重复"</span>)
		} <span class="pl-k">else</span> {
			<span class="pl-s1">respKey</span> <span class="pl-c1">:=</span> <span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s://%s%s/%s"</span>, <span class="pl-s1">Schema</span>, <span class="pl-s1">Host</span>, <span class="pl-s1">Port</span>, <span class="pl-s1">key</span>)
			<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s1">respKey</span>)
		}
	}
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">responseBody</span>.<span class="pl-en">String</span>()))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-k">return</span>
	}
}

<span class="pl-c">// Abort 网站异常</span>
<span class="pl-k">func</span> <span class="pl-en">Abort</span>(<span class="pl-s1">headers</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, <span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-c">// 写入响应头</span>
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">:=</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">headers</span>)
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">400</span>)
	<span class="pl-c">// 拼装响应头</span>
	<span class="pl-s1">responseBody</span> <span class="pl-c1">:=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s">""</span>)
	<span class="pl-c">// 设置响应体</span>
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">responseBody</span>.<span class="pl-en">String</span>()))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-k">return</span>
	}
}</pre></div>
<ol start="2">
<li>使用文件支持连接持久化</li>
</ol>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"bytes"</span>
	<span class="pl-s">"encoding/base64"</span>
	<span class="pl-s">"encoding/json"</span>
	<span class="pl-s">"errors"</span>
	<span class="pl-s">"fmt"</span>
	<span class="pl-s">"log"</span>
	<span class="pl-s">"math/rand"</span>
	<span class="pl-s">"net"</span>
	<span class="pl-s">"net/url"</span>
	<span class="pl-s">"os"</span>
	<span class="pl-s">"regexp"</span>
	<span class="pl-s">"strconv"</span>
	<span class="pl-s">"strings"</span>
	<span class="pl-s">"sync"</span>
	<span class="pl-s">"time"</span>
)

<span class="pl-k">var</span> (
	<span class="pl-s1">Schema</span>         <span class="pl-c1">=</span> <span class="pl-s">"http"</span>
	<span class="pl-s1">Host</span>           <span class="pl-c1">=</span> <span class="pl-s">"127.0.0.1"</span>
	<span class="pl-s1">Port</span>           <span class="pl-c1">=</span> <span class="pl-s">":7256"</span>
	<span class="pl-s1">MaxHeaderSize</span>  <span class="pl-c1">=</span> <span class="pl-c1">1</span> <span class="pl-c1">&lt;&lt;</span> <span class="pl-c1">10</span>
	<span class="pl-s1">ReadHeaderSize</span> <span class="pl-c1">=</span> <span class="pl-c1">1</span> <span class="pl-c1">&lt;&lt;</span> <span class="pl-c1">8</span>
	<span class="pl-s1">IndexHtml</span>      <span class="pl-c1">=</span> <span class="pl-s">"&lt;!DOCTYPE html&gt;<span class="pl-cce">\n</span>&lt;html lang=<span class="pl-cce">\"</span>en<span class="pl-cce">\"</span>&gt;<span class="pl-cce">\n</span>&lt;head&gt;<span class="pl-cce">\n</span>    &lt;meta charset=<span class="pl-cce">\"</span>UTF-8<span class="pl-cce">\"</span>&gt;<span class="pl-cce">\n</span>    &lt;title&gt;短连接生成器&lt;/title&gt;<span class="pl-cce">\n</span>&lt;/head&gt;<span class="pl-cce">\n</span>&lt;body&gt;<span class="pl-cce">\n</span>&lt;form action=<span class="pl-cce">\"</span>/<span class="pl-cce">\"</span> method=<span class="pl-cce">\"</span>post<span class="pl-cce">\"</span>&gt;<span class="pl-cce">\n</span>    &lt;label&gt;<span class="pl-cce">\n</span>        &lt;input type=<span class="pl-cce">\"</span>text<span class="pl-cce">\"</span> name=<span class="pl-cce">\"</span>url<span class="pl-cce">\"</span>/&gt;<span class="pl-cce">\n</span>    &lt;/label&gt;<span class="pl-cce">\n</span>    &lt;input type=<span class="pl-cce">\"</span>submit<span class="pl-cce">\"</span> value=<span class="pl-cce">\"</span>提交<span class="pl-cce">\"</span>&gt;<span class="pl-cce">\n</span>&lt;/form&gt;<span class="pl-cce">\n</span>&lt;/body&gt;<span class="pl-cce">\n</span>&lt;/html&gt;"</span>
	<span class="pl-s1">PathUnescape</span>   <span class="pl-c1">=</span> <span class="pl-s1">url</span>.<span class="pl-c1">PathUnescape</span>
	<span class="pl-s1">LocalDB</span>        <span class="pl-c1">=</span> <span class="pl-s">"short.json"</span>
	<span class="pl-s1">UrlMap</span>         <span class="pl-c1">=</span> <span class="pl-k">struct</span> {
		<span class="pl-c1">L</span>   sync.<span class="pl-smi">RWMutex</span>
		<span class="pl-c1">Url</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>
	}{
		<span class="pl-c1">Url</span>: <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>{},
	}
	<span class="pl-s1">HttpStatusCodeMap</span> <span class="pl-c1">=</span> <span class="pl-smi">HttpStatusMap</span>{
		<span class="pl-c1">100</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">100</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Continue"</span>},
		<span class="pl-c1">200</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">200</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"OK"</span>},
		<span class="pl-c1">301</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">301</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Moved Permanently"</span>},
		<span class="pl-c1">400</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">400</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Bad Request"</span>},
		<span class="pl-c1">403</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">403</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Forbidden"</span>},
		<span class="pl-c1">404</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">404</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Not Found"</span>},
		<span class="pl-c1">405</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">405</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Method Not Allowed"</span>},
		<span class="pl-c1">500</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">500</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Internal Server Error"</span>},
		<span class="pl-c1">502</span>: <span class="pl-smi">HttpStatus</span>{<span class="pl-c1">Code</span>: <span class="pl-c1">502</span>, <span class="pl-c1">Desc</span>: <span class="pl-s">"Bad Gateway"</span>},
	}
)

<span class="pl-c">// UrlGet 获取Url</span>
<span class="pl-k">func</span> <span class="pl-en">UrlGet</span>(<span class="pl-s1">key</span> <span class="pl-smi">string</span>) <span class="pl-smi">string</span> {
	<span class="pl-s1">UrlMap</span>.<span class="pl-c1">L</span>.<span class="pl-en">RLock</span>()
	<span class="pl-k">defer</span> <span class="pl-s1">UrlMap</span>.<span class="pl-c1">L</span>.<span class="pl-en">RUnlock</span>()
	<span class="pl-k">if</span> <span class="pl-s1">value</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">UrlMap</span>.<span class="pl-c1">Url</span>[<span class="pl-s1">key</span>]; <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-s">""</span>
	} <span class="pl-k">else</span> {
		<span class="pl-k">return</span> <span class="pl-s1">value</span>
	}
}

<span class="pl-c">// UrlSet 设置Url</span>
<span class="pl-k">func</span> <span class="pl-en">UrlSet</span>(<span class="pl-s1">key</span>, <span class="pl-s1">value</span> <span class="pl-smi">string</span>) <span class="pl-smi">bool</span> {
	<span class="pl-k">if</span> <span class="pl-s1">_</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">UrlMap</span>.<span class="pl-c1">Url</span>[<span class="pl-s1">key</span>]; <span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-c1">false</span>
	}
	<span class="pl-s1">UrlMap</span>.<span class="pl-c1">L</span>.<span class="pl-en">Lock</span>()
	<span class="pl-k">defer</span> <span class="pl-s1">UrlMap</span>.<span class="pl-c1">L</span>.<span class="pl-en">Unlock</span>()
	<span class="pl-k">if</span> <span class="pl-c1">!</span><span class="pl-s1">strings</span>.<span class="pl-en">HasPrefix</span>(<span class="pl-s1">value</span>, <span class="pl-s">"http"</span>) {
		<span class="pl-s1">value</span> <span class="pl-c1">=</span> <span class="pl-s">"http://"</span> <span class="pl-c1">+</span> <span class="pl-s1">value</span>
	}
	<span class="pl-s1">UrlMap</span>.<span class="pl-c1">Url</span>[<span class="pl-s1">key</span>] <span class="pl-c1">=</span> <span class="pl-s1">value</span>
	<span class="pl-k">return</span> <span class="pl-c1">true</span>
}

<span class="pl-c">// ReqHeaderLine 请求头首行</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeaderLine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Method</span>   <span class="pl-smi">string</span>
	<span class="pl-c1">Url</span>      <span class="pl-smi">string</span>
	<span class="pl-c1">Protocol</span> <span class="pl-smi">string</span>
}

<span class="pl-c">// ReqHeaderBody 请求头body</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeaderBody</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}
}

<span class="pl-c">// ReqHeader 请求头</span>
<span class="pl-k">type</span> <span class="pl-smi">ReqHeader</span> <span class="pl-k">struct</span> {
	<span class="pl-smi">ReqHeaderLine</span>
	<span class="pl-smi">ReqHeaderBody</span>
}

<span class="pl-c">// RespHeaderLine 响应头首行</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeaderLine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Protocol</span> <span class="pl-smi">string</span>
	<span class="pl-c1">Code</span>     <span class="pl-smi">int</span>
	<span class="pl-c1">Desc</span>     <span class="pl-smi">string</span>
}

<span class="pl-c">// RespHeaderBody 响应头body</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeaderBody</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}
}

<span class="pl-c">// RespHeader 响应头</span>
<span class="pl-k">type</span> <span class="pl-smi">RespHeader</span> <span class="pl-k">struct</span> {
	<span class="pl-smi">RespHeaderLine</span>
	<span class="pl-smi">RespHeaderBody</span>
}

<span class="pl-c">// HttpStatus http状态码</span>
<span class="pl-k">type</span> <span class="pl-smi">HttpStatus</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Code</span> <span class="pl-smi">int</span>
	<span class="pl-c1">Desc</span> <span class="pl-smi">string</span>
}

<span class="pl-c">// HttpStatusMap http状态码集合</span>
<span class="pl-k">type</span> <span class="pl-smi">HttpStatusMap</span> <span class="pl-k">map</span>[<span class="pl-smi">int</span>]<span class="pl-smi">HttpStatus</span>

<span class="pl-k">func</span> <span class="pl-en">exist</span>(<span class="pl-s1">path</span> <span class="pl-smi">string</span>) <span class="pl-smi">bool</span> {
	<span class="pl-k">if</span> <span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">os</span>.<span class="pl-en">Stat</span>(<span class="pl-s1">path</span>); <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-k">return</span> <span class="pl-c1">false</span>
	} <span class="pl-k">else</span> {
		<span class="pl-k">return</span> <span class="pl-c1">true</span>
	}
}

<span class="pl-k">func</span> <span class="pl-en">init</span>() {
	<span class="pl-k">var</span> <span class="pl-s1">fileData</span> []<span class="pl-smi">byte</span>
	<span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-en">exist</span>(<span class="pl-s1">LocalDB</span>)
	<span class="pl-k">if</span> <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-s1">file</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">os</span>.<span class="pl-en">OpenFile</span>(<span class="pl-s1">LocalDB</span>, <span class="pl-s1">os</span>.<span class="pl-c1">O_APPEND</span><span class="pl-c1">|</span><span class="pl-s1">os</span>.<span class="pl-c1">O_CREATE</span><span class="pl-c1">|</span><span class="pl-s1">os</span>.<span class="pl-c1">O_RDWR</span>, <span class="pl-c1">0777</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-en">panic</span>(<span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
		}
		<span class="pl-s1">file</span>.<span class="pl-en">Close</span>()
	}
	<span class="pl-s1">fileData</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">os</span>.<span class="pl-en">ReadFile</span>(<span class="pl-s1">LocalDB</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
	}
	<span class="pl-s1">err</span> <span class="pl-c1">=</span> <span class="pl-s1">json</span>.<span class="pl-en">Unmarshal</span>(<span class="pl-s1">fileData</span>, <span class="pl-c1">&amp;</span><span class="pl-s1">UrlMap</span>.<span class="pl-c1">Url</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"Unmarshal"</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
	}
}

<span class="pl-k">func</span> <span class="pl-en">WriteUrlToDB</span>(<span class="pl-s1">db</span> <span class="pl-smi">string</span>) {
	<span class="pl-k">for</span> {
		<span class="pl-s1">time</span>.<span class="pl-en">Sleep</span>(<span class="pl-s1">time</span>.<span class="pl-c1">Second</span> <span class="pl-c1">*</span> <span class="pl-c1">2</span>)
		<span class="pl-s1">url</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">json</span>.<span class="pl-en">Marshal</span>(<span class="pl-s1">UrlMap</span>.<span class="pl-c1">Url</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"Marshal"</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
			<span class="pl-k">continue</span>
		}
		<span class="pl-s1">err</span> <span class="pl-c1">=</span> <span class="pl-s1">os</span>.<span class="pl-en">WriteFile</span>(<span class="pl-s1">db</span>, <span class="pl-s1">url</span>, <span class="pl-c1">0777</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"WriteFile"</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
		}
	}
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-c">// 监听端口</span>
	<span class="pl-s1">listen</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">net</span>.<span class="pl-en">Listen</span>(<span class="pl-s">"tcp"</span>, <span class="pl-s1">Port</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create listen error "</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
	}

	<span class="pl-k">go</span> <span class="pl-en">WriteUrlToDB</span>(<span class="pl-s1">LocalDB</span>)

	<span class="pl-k">for</span> {
		<span class="pl-c">// 等待获取一个连接对象</span>
		<span class="pl-s1">conn</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">listen</span>.<span class="pl-en">Accept</span>()
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"create conn error"</span>, <span class="pl-s1">err</span>.<span class="pl-en">Error</span>())
		}
		<span class="pl-c">// 基于协程进行当前连接对象的处理</span>
		<span class="pl-k">go</span> <span class="pl-en">Handle</span>(<span class="pl-s1">conn</span>)
	}
}

<span class="pl-k">func</span> <span class="pl-en">Handle</span>(<span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-s1">start</span> <span class="pl-c1">:=</span> <span class="pl-s1">time</span>.<span class="pl-en">Now</span>()
	<span class="pl-s1">header</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-c1">0</span>, <span class="pl-s1">MaxHeaderSize</span>)
	<span class="pl-k">for</span> {
		<span class="pl-s1">headerRead</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">byte</span>, <span class="pl-s1">ReadHeaderSize</span>)
		<span class="pl-s1">n</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Read</span>(<span class="pl-s1">headerRead</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">return</span>
		}

		<span class="pl-s1">header</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">header</span>, <span class="pl-s1">headerRead</span><span class="pl-c1">...</span>)
		<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"read data value length: "</span>, <span class="pl-s1">n</span>)
		<span class="pl-k">if</span> <span class="pl-s1">n</span> <span class="pl-c1">&lt;</span> <span class="pl-s1">ReadHeaderSize</span> {
			<span class="pl-k">break</span>
		}
	}
	<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s">"use time total: "</span>, <span class="pl-s1">time</span>.<span class="pl-en">Since</span>(<span class="pl-s1">start</span>))
	<span class="pl-c">// 解析请求头</span>
	<span class="pl-s1">headers</span>, <span class="pl-s1">body</span> <span class="pl-c1">:=</span> <span class="pl-en">ParseHttpHeader</span>(<span class="pl-s1">header</span>)

	<span class="pl-s1">err</span>, <span class="pl-s1">m</span> <span class="pl-c1">:=</span> <span class="pl-en">ParseRequestBody</span>(<span class="pl-s1">headers</span>, <span class="pl-s1">body</span>)

	<span class="pl-s1">log</span>.<span class="pl-en">Println</span>(<span class="pl-s1">m</span>, <span class="pl-s1">err</span>)

	<span class="pl-k">switch</span> <span class="pl-s1">headers</span>.<span class="pl-c1">Method</span> {
	<span class="pl-k">case</span> <span class="pl-s">"GET"</span>:
		<span class="pl-en">DoGet</span>(<span class="pl-s1">headers</span>, <span class="pl-c1">nil</span>, <span class="pl-s1">conn</span>)
	<span class="pl-k">case</span> <span class="pl-s">"POST"</span>:
		<span class="pl-en">DoPost</span>(<span class="pl-s1">headers</span>, <span class="pl-s1">m</span>, <span class="pl-s1">conn</span>)
	<span class="pl-k">default</span>:
		<span class="pl-en">Abort</span>(<span class="pl-s1">headers</span>, <span class="pl-s1">conn</span>)
	}
}

<span class="pl-c">// ParseHttpRequestFirstLine 解析请求头首行</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpRequestFirstLine</span>(<span class="pl-s1">line</span> []<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeaderLine</span> {
	<span class="pl-s1">re</span> <span class="pl-c1">:=</span> <span class="pl-s1">regexp</span>.<span class="pl-en">MustCompile</span>(<span class="pl-s">`([A-Z]+)\s(/.*)\s(HTTP/1.[0-1]+)$`</span>)
	<span class="pl-s1">matched</span> <span class="pl-c1">:=</span> <span class="pl-s1">re</span>.<span class="pl-en">FindStringSubmatch</span>(<span class="pl-en">string</span>(<span class="pl-s1">line</span>))
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">matched</span>) <span class="pl-c1">!=</span> <span class="pl-c1">4</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"parse request header error"</span>))
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeaderLine</span>{
		<span class="pl-c1">Method</span>:   <span class="pl-s1">matched</span>[<span class="pl-c1">1</span>],
		<span class="pl-c1">Url</span>:      <span class="pl-s1">matched</span>[<span class="pl-c1">2</span>],
		<span class="pl-c1">Protocol</span>: <span class="pl-s1">matched</span>[<span class="pl-c1">3</span>],
	}
}

<span class="pl-c">// ParseHttpRequestLine 解析请求头</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpRequestLine</span>(<span class="pl-s1">lines</span> <span class="pl-c1">...</span>[]<span class="pl-smi">byte</span>) <span class="pl-c1">*</span><span class="pl-smi">ReqHeaderBody</span> {
	<span class="pl-k">var</span> <span class="pl-s1">body</span> <span class="pl-c1">=</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}{}
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">line</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">lines</span> {
		<span class="pl-s1">lineSlice</span> <span class="pl-c1">:=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Split</span>(<span class="pl-en">string</span>(<span class="pl-s1">line</span>), <span class="pl-s">": "</span>)
		<span class="pl-s1">body</span>[<span class="pl-s1">lineSlice</span>[<span class="pl-c1">0</span>]] <span class="pl-c1">=</span> <span class="pl-s1">lineSlice</span>[<span class="pl-c1">1</span>]
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeaderBody</span>{
		<span class="pl-c1">Body</span>: <span class="pl-s1">body</span>,
	}
}

<span class="pl-c">// ParseHttpHeader 解析请求头</span>
<span class="pl-k">func</span> <span class="pl-en">ParseHttpHeader</span>(<span class="pl-s1">reqData</span> []<span class="pl-smi">byte</span>) (<span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, []<span class="pl-smi">byte</span>) {
	<span class="pl-s1">reqHeaderWithBody</span> <span class="pl-c1">:=</span> <span class="pl-s1">bytes</span>.<span class="pl-en">Split</span>(<span class="pl-s1">reqData</span>, []<span class="pl-smi">byte</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span><span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>))
	<span class="pl-s1">reqHeader</span> <span class="pl-c1">:=</span> <span class="pl-s1">bytes</span>.<span class="pl-en">Split</span>(<span class="pl-s1">reqHeaderWithBody</span>[<span class="pl-c1">0</span>], []<span class="pl-smi">byte</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>))
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">reqHeader</span>) <span class="pl-c1">&lt;</span> <span class="pl-c1">1</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"request header parse error"</span>))
	}
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">ReqHeader</span>{
		<span class="pl-c1">ReqHeaderLine</span>: <span class="pl-c1">*</span><span class="pl-en">ParseHttpRequestFirstLine</span>(<span class="pl-s1">reqHeader</span>[<span class="pl-c1">0</span>]),
		<span class="pl-c1">ReqHeaderBody</span>: <span class="pl-c1">*</span><span class="pl-en">ParseHttpRequestLine</span>(<span class="pl-s1">reqHeader</span>[<span class="pl-c1">1</span>:]<span class="pl-c1">...</span>),
	}, <span class="pl-s1">reqHeaderWithBody</span>[<span class="pl-c1">1</span>]
}

<span class="pl-c">// InitHttpResponseHeader 写入响应头</span>
<span class="pl-k">func</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>) <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">RespHeader</span>{
		<span class="pl-smi">RespHeaderLine</span>{<span class="pl-c1">Protocol</span>: <span class="pl-s1">r</span>.<span class="pl-c1">Protocol</span>},
		<span class="pl-smi">RespHeaderBody</span>{<span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}{
			<span class="pl-s">"Server"</span>: <span class="pl-s">"Go1.19"</span>,
		}},
	}
}

<span class="pl-c">// SetResponseHeaderCode 设置响应头</span>
<span class="pl-k">func</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">resp</span> <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span>, <span class="pl-s1">code</span> <span class="pl-smi">int</span>) <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span> {
	<span class="pl-s1">resp</span>.<span class="pl-c1">Code</span> <span class="pl-c1">=</span> <span class="pl-s1">HttpStatusCodeMap</span>[<span class="pl-s1">code</span>].<span class="pl-c1">Code</span>
	<span class="pl-s1">resp</span>.<span class="pl-c1">Desc</span> <span class="pl-c1">=</span> <span class="pl-s1">HttpStatusCodeMap</span>[<span class="pl-s1">code</span>].<span class="pl-c1">Desc</span>
	<span class="pl-k">return</span> <span class="pl-s1">resp</span>
}

<span class="pl-c">// ResponseToString 响应转string</span>
<span class="pl-k">func</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RespHeader</span>, <span class="pl-s1">body</span> <span class="pl-smi">string</span>) <span class="pl-c1">*</span>strings.<span class="pl-smi">Builder</span> {
	<span class="pl-c">// 设置响应体长度</span>
	<span class="pl-s1">r</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Length"</span>] <span class="pl-c1">=</span> <span class="pl-s1">strconv</span>.<span class="pl-en">Itoa</span>(<span class="pl-en">len</span>(<span class="pl-s1">body</span>))

	<span class="pl-s1">header</span> <span class="pl-c1">:=</span> <span class="pl-c1">&amp;</span>strings.<span class="pl-smi">Builder</span>{}
	<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s %d %s<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Protocol</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Code</span>, <span class="pl-s1">r</span>.<span class="pl-c1">Desc</span>))
	<span class="pl-k">for</span> <span class="pl-s1">k</span>, <span class="pl-s1">v</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">r</span>.<span class="pl-c1">Body</span> {
		<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s: %s<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>, <span class="pl-s1">k</span>, <span class="pl-s1">v</span>.(<span class="pl-smi">string</span>)))
	}
	<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s">"<span class="pl-cce">\r</span><span class="pl-cce">\n</span>"</span>)
	<span class="pl-s1">header</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">body</span>)
	<span class="pl-k">return</span> <span class="pl-s1">header</span>
}

<span class="pl-c">// ParseFormUrlencoded application/x-www-form-urlencoded</span>
<span class="pl-k">func</span> <span class="pl-en">ParseFormUrlencoded</span>(<span class="pl-s1">bodyStr</span> <span class="pl-smi">string</span>) <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span> {
	<span class="pl-s1">bodyStrSlice</span> <span class="pl-c1">:=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Split</span>(<span class="pl-s1">bodyStr</span>, <span class="pl-s">"&amp;"</span>)
	<span class="pl-s1">bodyMap</span> <span class="pl-c1">:=</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>{}
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">bodykv</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">bodyStrSlice</span> {
		<span class="pl-s1">kvSlice</span> <span class="pl-c1">:=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Split</span>(<span class="pl-s1">bodykv</span>, <span class="pl-s">"="</span>)
		<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">kvSlice</span>) <span class="pl-c1">&gt;=</span> <span class="pl-c1">2</span> {
			<span class="pl-s1">bodyMap</span>[<span class="pl-s1">kvSlice</span>[<span class="pl-c1">0</span>]] <span class="pl-c1">=</span> <span class="pl-s1">kvSlice</span>[<span class="pl-c1">1</span>]
		} <span class="pl-k">else</span> {
			<span class="pl-s1">bodyMap</span>[<span class="pl-s1">kvSlice</span>[<span class="pl-c1">0</span>]] <span class="pl-c1">=</span> <span class="pl-s">""</span>
		}
	}
	<span class="pl-k">return</span> <span class="pl-s1">bodyMap</span>
}

<span class="pl-c">// ParseRequestBody 解析请求体</span>
<span class="pl-k">func</span> <span class="pl-en">ParseRequestBody</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, <span class="pl-s1">body</span> []<span class="pl-smi">byte</span>) (<span class="pl-s1">error</span>, <span class="pl-s1">map</span>[<span class="pl-s1">string</span>]<span class="pl-smi">string</span>) {
	<span class="pl-s1">value</span> <span class="pl-c1">:=</span> <span class="pl-c1">0</span>
	<span class="pl-k">if</span> <span class="pl-s1">v</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Length"</span>]; <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"error"</span>), <span class="pl-c1">nil</span>
	} <span class="pl-k">else</span> {
		<span class="pl-s1">value</span>, <span class="pl-s1">_</span> <span class="pl-c1">=</span> <span class="pl-s1">strconv</span>.<span class="pl-en">Atoi</span>(<span class="pl-s1">v</span>.(<span class="pl-smi">string</span>))
	}
	<span class="pl-s1">bodyStr</span> <span class="pl-c1">:=</span> <span class="pl-en">string</span>(<span class="pl-s1">body</span>[:<span class="pl-s1">value</span>])

	<span class="pl-k">if</span> <span class="pl-s1">cType</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Type"</span>]; <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-s1">errors</span>.<span class="pl-en">New</span>(<span class="pl-s">"error Content-Type"</span>), <span class="pl-c1">nil</span>
	} <span class="pl-k">else</span> {
		<span class="pl-c">//application/x-www-form-urlencoded</span>
		<span class="pl-k">if</span> <span class="pl-s1">cType</span> <span class="pl-c1">==</span> <span class="pl-s">"application/x-www-form-urlencoded"</span> {
			<span class="pl-k">return</span> <span class="pl-c1">nil</span>, <span class="pl-en">ParseFormUrlencoded</span>(<span class="pl-s1">bodyStr</span>)
		}
	}
	<span class="pl-k">return</span> <span class="pl-c1">nil</span>, <span class="pl-c1">nil</span>
}

<span class="pl-c">// GenerateRandomKey 生成一个随机key</span>
<span class="pl-k">func</span> <span class="pl-en">GenerateRandomKey</span>() <span class="pl-smi">string</span> {
	<span class="pl-s1">key</span> <span class="pl-c1">:=</span> <span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s-%s"</span>, <span class="pl-s1">strconv</span>.<span class="pl-en">Itoa</span>(<span class="pl-s1">rand</span>.<span class="pl-en">Int</span>()), <span class="pl-s1">time</span>.<span class="pl-en">Now</span>().<span class="pl-en">Format</span>(<span class="pl-s">"2006-01-02 15:04:05"</span>))
	<span class="pl-k">return</span> <span class="pl-s1">base64</span>.<span class="pl-c1">StdEncoding</span>.<span class="pl-en">EncodeToString</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">key</span>))
}

<span class="pl-c">// GetRequestUrlPath 获取请求路径</span>
<span class="pl-k">func</span> <span class="pl-en">GetRequestUrlPath</span>(<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>) <span class="pl-smi">string</span> {
	<span class="pl-k">return</span> <span class="pl-s1">r</span>.<span class="pl-c1">Url</span>
}

<span class="pl-k">func</span> <span class="pl-en">DoGet</span>(<span class="pl-s1">headers</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, <span class="pl-s1">body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>, <span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">:=</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">headers</span>)
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">200</span>)
	<span class="pl-k">var</span> <span class="pl-s1">responseBody</span> <span class="pl-c1">*</span>strings.<span class="pl-smi">Builder</span>

	<span class="pl-s1">redirectKey</span> <span class="pl-c1">:=</span> <span class="pl-en">GetRequestUrlPath</span>(<span class="pl-s1">headers</span>)
	<span class="pl-c">// 返回首页</span>
	<span class="pl-k">if</span> <span class="pl-s1">redirectKey</span> <span class="pl-c1">==</span> <span class="pl-s">"/"</span> {
		<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s1">IndexHtml</span>)
	} <span class="pl-k">else</span> {
		<span class="pl-s1">redirectValue</span> <span class="pl-c1">:=</span> <span class="pl-en">UrlGet</span>(<span class="pl-s1">strings</span>.<span class="pl-en">Trim</span>(<span class="pl-s1">redirectKey</span>, <span class="pl-s">"/"</span>))
		<span class="pl-s1">responseHeader</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Location"</span>] <span class="pl-c1">=</span> <span class="pl-s1">redirectValue</span>
		<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">301</span>)
		<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s">""</span>)
	}
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">responseBody</span>.<span class="pl-en">String</span>()))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-k">return</span>
	}
}

<span class="pl-k">func</span> <span class="pl-en">DoPost</span>(<span class="pl-s1">headers</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, <span class="pl-s1">body</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>, <span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">:=</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">headers</span>)
	<span class="pl-s1">responseHeader</span>.<span class="pl-c1">Body</span>[<span class="pl-s">"Content-Type"</span>] <span class="pl-c1">=</span> <span class="pl-s">"text/html;charset=utf-8"</span>
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">200</span>)
	<span class="pl-k">var</span> <span class="pl-s1">responseBody</span> <span class="pl-c1">*</span>strings.<span class="pl-smi">Builder</span>

	<span class="pl-k">if</span> <span class="pl-s1">v</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">body</span>[<span class="pl-s">"url"</span>]; <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">400</span>)
		<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s">"地址填写异常"</span>)
	} <span class="pl-k">else</span> {
		<span class="pl-s1">key</span> <span class="pl-c1">:=</span> <span class="pl-en">GenerateRandomKey</span>()
		<span class="pl-s1">pathUnescape</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-en">PathUnescape</span>(<span class="pl-s1">v</span>)
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-en">panic</span>(<span class="pl-s1">err</span>)
		}
		<span class="pl-s1">status</span> <span class="pl-c1">:=</span> <span class="pl-en">UrlSet</span>(<span class="pl-s1">key</span>, <span class="pl-s1">pathUnescape</span>)
		<span class="pl-k">if</span> <span class="pl-c1">!</span><span class="pl-s1">status</span> {
			<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s">"地址配置重复"</span>)
		} <span class="pl-k">else</span> {
			<span class="pl-s1">respKey</span> <span class="pl-c1">:=</span> <span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s://%s%s/%s"</span>, <span class="pl-s1">Schema</span>, <span class="pl-s1">Host</span>, <span class="pl-s1">Port</span>, <span class="pl-s1">key</span>)
			<span class="pl-s1">responseBody</span> <span class="pl-c1">=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s1">respKey</span>)
		}
	}
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">responseBody</span>.<span class="pl-en">String</span>()))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-k">return</span>
	}
}

<span class="pl-c">// Abort 网站异常</span>
<span class="pl-k">func</span> <span class="pl-en">Abort</span>(<span class="pl-s1">headers</span> <span class="pl-c1">*</span><span class="pl-smi">ReqHeader</span>, <span class="pl-s1">conn</span> net.<span class="pl-smi">Conn</span>) {
	<span class="pl-k">defer</span> <span class="pl-s1">conn</span>.<span class="pl-en">Close</span>()
	<span class="pl-c">// 写入响应头</span>
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">:=</span> <span class="pl-en">InitHttpResponseHeader</span>(<span class="pl-s1">headers</span>)
	<span class="pl-s1">responseHeader</span> <span class="pl-c1">=</span> <span class="pl-en">SetResponseHeaderCode</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-c1">400</span>)
	<span class="pl-c">// 拼装响应头</span>
	<span class="pl-s1">responseBody</span> <span class="pl-c1">:=</span> <span class="pl-en">ResponseToString</span>(<span class="pl-s1">responseHeader</span>, <span class="pl-s">""</span>)
	<span class="pl-c">// 设置响应体</span>
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">conn</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">responseBody</span>.<span class="pl-en">String</span>()))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-k">return</span>
	}
}</pre></div>
<ol start="3">
<li>优化代码</li>
</ol>
<div class="highlight highlight-source-shell"><pre><span class="pl-c"><span class="pl-c">#</span> 项目见GolangDocs\src\RawShortUrl</span>
<span class="pl-c1">.</span>
├── Makefile
├── README.html
├── go.mod
├── handle			<span class="pl-c"><span class="pl-c">#</span> 业务处理</span>
├── images
├── internal		<span class="pl-c"><span class="pl-c">#</span> 请求解析</span>
├── main.go			<span class="pl-c"><span class="pl-c">#</span> 启动文件</span>
└── short.json</pre></div>
<ol start="4">
<li>基于原生http库的实现</li>
</ol>
<div class="highlight highlight-source-shell"><pre><span class="pl-c"><span class="pl-c">#</span> 项目见GolangDocs\src\GoshortUrl</span></pre></div>

      </article>
    </div>
  </div>
  <div class="
    side
    Box
    md
    js-code-block-container
    Box--responsive
    container-right-nav
    mt-5
    d-none d-lg-block
  " style="overflow: hidden;">
    <div class="Box-body p-5">
      <div class="container-right-nav-logo">
        <a href="https://www.github.com/Bean-jun"><svg height="32" class="octicon octicon-mark-github anim-pulse"
            viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true">
            <path fill-rule="evenodd"
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z">
            </path>
          </svg></a>
      </div>
    </div>
    <div class="content-title-nav">
      <ul>
        <li><a href="#一、tcp通信">一、tcp通信</a></li><li><a href="#二、http协议">二、http协议</a></li><li><a href="#三、http实现">三、http实现</a></li><li><a href="#四、手搓URL重定向功能">四、手搓URL重定向功能</a></li>
      </ul>
    </div>
  </div>
  <script src="/.static/js/theme.js"></script>
  <script src="/.static/js/iconify.min.js"></script>
</body>

</html>