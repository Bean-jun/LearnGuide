<!DOCTYPE html>
<html lang="en">
<html>

<head>
  <meta charset="UTF-8">
  <link href="/.static/css/primer.css" rel="stylesheet" />
  <link rel="stylesheet alternate" href="/.static/css/github-light.css" id="light-hl">
  <link rel="stylesheet alternate" href="/.static/css/github-dark.css" id="dark-hl">
  <link rel="stylesheet" href="/.static/css/main.css">
  <title>Golang-自定义Web框架.md</title>
</head>

<body id="markdown-body" data-color-mode="light" data-dark-theme="light">
  <!-- <div class="
  Box
  md
  js-code-block-container
  Box--responsive
  container-nav
  container-left-nav
  mt-5
  d-none d-lg-block
">
    <div class="Box-body p-5">
      <div class="d-flex flex-column flex-sm-row-reverse">
        <h1>填充...</h1>
      </div>
    </div>
    <div>填充</div>
  </div> -->
  <div class="
        Box
        md
        js-code-block-container
        Box--responsive
        container-xl
        px-3 px-md-4 px-lg-5
        mt-5
      " id="content">
    <div class="Box-body px-5 pb-5">
      <div class="d-flex flex-column flex-sm-row-reverse">
        <div class="border rounded-3 to-home">
          <a href="/">返回主页</a>
        </div>
        <div>
          <button id="theme-button" class="btn" type="button">
            <span id="theme-icon" class="iconify" data-icon="octicon:sun-16"></span>
          </button>
        </div>
        <div class="article-size">
          <span>2198字 | 5分钟</span>
        </div>
      </div>
      <article class="markdown-body entry-content container-lg" itemprop="text">
        <p><strong>相关源码见<code>GolangDocs\src\webframe</code>目录</strong></p>
<h2><a id="user-content-0x01-基础的http请求接口实现" class="anchor" aria-hidden="true" href="#0x01-基础的http请求接口实现"><span aria-hidden="true" class="octicon octicon-link"></span></a>0x01 基础的http请求接口实现</h2>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"fmt"</span>
	<span class="pl-s">"log"</span>
	<span class="pl-s">"net/http"</span>
)

<span class="pl-k">func</span> <span class="pl-en">hello</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) {
	<span class="pl-s1">fmt</span>.<span class="pl-en">Println</span>(<span class="pl-s1">r</span>.<span class="pl-c1">Method</span>)
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">w</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s">"hello"</span>))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">err</span>)
	}
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-s1">http</span>.<span class="pl-en">HandleFunc</span>(<span class="pl-s">"/hello"</span>, <span class="pl-s1">hello</span>)
	<span class="pl-s1">log</span>.<span class="pl-en">Fatal</span>(<span class="pl-s1">http</span>.<span class="pl-en">ListenAndServe</span>(<span class="pl-s">":8080"</span>, <span class="pl-c1">nil</span>))
}</pre></div>
<h2><a id="user-content-0x02-自定义handler-实现serverhttp方法" class="anchor" aria-hidden="true" href="#0x02-自定义handler-实现serverhttp方法"><span aria-hidden="true" class="octicon octicon-link"></span></a>0x02 自定义Handler-实现ServerHTTP方法</h2>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"fmt"</span>
	<span class="pl-s">"log"</span>
	<span class="pl-s">"net/http"</span>
)

<span class="pl-c">// Handler 写在这里就是醒目作用 官方已自定义</span>
<span class="pl-k">type</span> <span class="pl-smi">Handler</span> <span class="pl-k">interface</span> {
	<span class="pl-c1">ServeHTTP</span>(http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>)
}

<span class="pl-k">type</span> <span class="pl-smi">Engine</span> <span class="pl-k">struct</span>{}

<span class="pl-c">// ServeHTTP 实现此方法即可将此解构丢入ListenAndServe</span>
<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">ServeHTTP</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) {
	<span class="pl-s1">fmt</span>.<span class="pl-en">Println</span>(<span class="pl-s1">r</span>.<span class="pl-c1">Method</span>, <span class="pl-s1">r</span>.<span class="pl-c1">URL</span>.<span class="pl-c1">Path</span>)
	<span class="pl-k">switch</span> <span class="pl-s1">r</span>.<span class="pl-c1">URL</span>.<span class="pl-c1">Path</span> {
	<span class="pl-k">case</span> <span class="pl-s">"/hello"</span>:
		<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">w</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>((<span class="pl-s">"hello"</span>)))
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">return</span>
		}
	<span class="pl-k">case</span> <span class="pl-s">"/world"</span>:
		<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">w</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>((<span class="pl-s">"world"</span>)))
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">return</span>
		}
	}
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-s1">log</span>.<span class="pl-en">Fatal</span>(<span class="pl-s1">http</span>.<span class="pl-en">ListenAndServe</span>(<span class="pl-s">":8080"</span>, <span class="pl-en">new</span>(<span class="pl-smi">Engine</span>)))
}</pre></div>
<h2><a id="user-content-0x03-仿gin可自定义请求动作" class="anchor" aria-hidden="true" href="#0x03-仿gin可自定义请求动作"><span aria-hidden="true" class="octicon octicon-link"></span></a>0x03 仿gin,可自定义请求动作</h2>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> main

<span class="pl-k">import</span> (
	<span class="pl-s">"fmt"</span>
	<span class="pl-s">"log"</span>
	<span class="pl-s">"net/http"</span>
)

<span class="pl-c">// HandlerFunc 定义HandlerFunc用于设置用户请求约束</span>
<span class="pl-k">type</span> <span class="pl-smi">HandlerFunc</span> <span class="pl-k">func</span>(http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>)

<span class="pl-k">type</span> <span class="pl-smi">Engine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">router</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">HandlerFunc</span>
}

<span class="pl-k">func</span> <span class="pl-en">NewEngine</span>() <span class="pl-c1">*</span><span class="pl-smi">Engine</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">Engine</span>{
		<span class="pl-c1">router</span>: <span class="pl-en">make</span>(<span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">HandlerFunc</span>),
	}
}
<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">AddRoute</span>(<span class="pl-s1">method</span>, <span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">keys</span> <span class="pl-c1">:=</span> <span class="pl-s1">method</span> <span class="pl-c1">+</span> <span class="pl-s">"_"</span> <span class="pl-c1">+</span> <span class="pl-s1">patten</span>
	<span class="pl-s1">e</span>.<span class="pl-c1">router</span>[<span class="pl-s1">keys</span>] <span class="pl-c1">=</span> <span class="pl-s1">handler</span>
}

<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">GET</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">e</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"GET"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">POST</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">e</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"POST"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">PUT</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">e</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"PUT"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">DELETE</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">e</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"DELETE"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">Any</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">e</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"GET"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
	<span class="pl-s1">e</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"POST"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
	<span class="pl-s1">e</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"PUT"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
	<span class="pl-s1">e</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"DELETE"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-c">// ServeHTTP 实现此方法即可将此解构丢入ListenAndServe</span>
<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">ServeHTTP</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) {
	<span class="pl-s1">fmt</span>.<span class="pl-en">Println</span>(<span class="pl-s1">r</span>.<span class="pl-c1">Method</span>, <span class="pl-s1">r</span>.<span class="pl-c1">URL</span>.<span class="pl-c1">Path</span>)
	<span class="pl-s1">keys</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">Method</span> <span class="pl-c1">+</span> <span class="pl-s">"_"</span> <span class="pl-c1">+</span> <span class="pl-s1">r</span>.<span class="pl-c1">URL</span>.<span class="pl-c1">Path</span>
	<span class="pl-k">if</span> <span class="pl-s1">handler</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">e</span>.<span class="pl-c1">router</span>[<span class="pl-s1">keys</span>]; <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">w</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s">"404 NOT FOUND"</span>))
		<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">return</span>
		}
	} <span class="pl-k">else</span> {
		<span class="pl-en">handler</span>(<span class="pl-s1">w</span>, <span class="pl-s1">r</span>)
	}
}

<span class="pl-c">// Run 用户调用Run实现server启动</span>
<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">Run</span>(<span class="pl-s1">addr</span> <span class="pl-smi">string</span>) <span class="pl-smi">error</span> {
	<span class="pl-k">return</span> <span class="pl-s1">http</span>.<span class="pl-en">ListenAndServe</span>(<span class="pl-s1">addr</span>, <span class="pl-s1">e</span>)
}

<span class="pl-c">// ===========================分割线===================================</span>
<span class="pl-k">func</span> <span class="pl-en">hello</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) {
	<span class="pl-s1">fmt</span>.<span class="pl-en">Println</span>(<span class="pl-s1">r</span>.<span class="pl-c1">Method</span>)
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">w</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s">"hello"</span>))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-en">panic</span>(<span class="pl-s1">err</span>)
	}
}

<span class="pl-k">func</span> <span class="pl-en">main</span>() {
	<span class="pl-s1">engine</span> <span class="pl-c1">:=</span> <span class="pl-en">NewEngine</span>()
	<span class="pl-s1">engine</span>.<span class="pl-en">Any</span>(<span class="pl-s">"/hello"</span>, <span class="pl-s1">hello</span>)
	<span class="pl-s1">log</span>.<span class="pl-en">Fatal</span>(<span class="pl-s1">engine</span>.<span class="pl-en">Run</span>(<span class="pl-s">":8080"</span>))
}</pre></div>
<h2><a id="user-content-0x04-分离路由封装请求" class="anchor" aria-hidden="true" href="#0x04-分离路由封装请求"><span aria-hidden="true" class="octicon octicon-link"></span></a>0x04 分离路由&amp;封装请求</h2>
<div class="highlight highlight-source-go"><pre><span class="pl-c">//分离路由</span>
<span class="pl-k">package</span> frame

<span class="pl-k">import</span> <span class="pl-s">"net/http"</span>

<span class="pl-c">/*</span>
<span class="pl-c">将用户请求路由拆出</span>
<span class="pl-c">*/</span>

<span class="pl-k">type</span> <span class="pl-smi">router</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">handlers</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">HandlerFunc</span>
}

<span class="pl-k">func</span> <span class="pl-en">newRouter</span>() <span class="pl-c1">*</span><span class="pl-smi">router</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">router</span>{<span class="pl-c1">handlers</span>: <span class="pl-en">make</span>(<span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">HandlerFunc</span>)}
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">router</span>) <span class="pl-en">addRoute</span>(<span class="pl-s1">method</span>, <span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">key</span> <span class="pl-c1">:=</span> <span class="pl-s1">method</span> <span class="pl-c1">+</span> <span class="pl-s">"-"</span> <span class="pl-c1">+</span> <span class="pl-s1">patten</span>
	<span class="pl-s1">r</span>.<span class="pl-c1">handlers</span>[<span class="pl-s1">key</span>] <span class="pl-c1">=</span> <span class="pl-s1">handler</span>
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">router</span>) <span class="pl-en">handle</span>(<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) {
	<span class="pl-s1">key</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">Method</span> <span class="pl-c1">+</span> <span class="pl-s">"-"</span> <span class="pl-c1">+</span> <span class="pl-s1">c</span>.<span class="pl-c1">Path</span>
	<span class="pl-k">if</span> <span class="pl-s1">handler</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">handlers</span>[<span class="pl-s1">key</span>]; <span class="pl-s1">ok</span> {
		<span class="pl-en">handler</span>(<span class="pl-s1">c</span>)
	} <span class="pl-k">else</span> {
		<span class="pl-s1">c</span>.<span class="pl-en">String</span>(<span class="pl-s1">http</span>.<span class="pl-c1">StatusNotFound</span>, <span class="pl-s">"404 NOT FOUND: %s<span class="pl-cce">\n</span>"</span>, <span class="pl-s1">c</span>.<span class="pl-c1">Path</span>)
	}
}

<span class="pl-c">//封装请求</span>
<span class="pl-k">package</span> frame

<span class="pl-c">/*</span>
<span class="pl-c">   对请求handler(w http.ResponseWriter, r *http.Request)进行封装</span>
<span class="pl-c">*/</span>

<span class="pl-k">import</span> (
<span class="pl-s">"encoding/json"</span>
<span class="pl-s">"fmt"</span>
<span class="pl-s">"net/http"</span>
)

<span class="pl-c">// H 约束用户传入结构格式</span>
<span class="pl-k">type</span> <span class="pl-smi">H</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}

<span class="pl-k">type</span> <span class="pl-smi">Context</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Writer</span>     http.<span class="pl-smi">ResponseWriter</span>
	<span class="pl-c1">Request</span>    <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>
	<span class="pl-c1">Path</span>       <span class="pl-smi">string</span>
	<span class="pl-c1">Method</span>     <span class="pl-smi">string</span>
	<span class="pl-c1">StatusCode</span> <span class="pl-smi">int</span>
}

<span class="pl-k">func</span> <span class="pl-en">newContext</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) <span class="pl-c1">*</span><span class="pl-smi">Context</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">Context</span>{
		<span class="pl-c1">Writer</span>:  <span class="pl-s1">w</span>,
		<span class="pl-c1">Request</span>: <span class="pl-s1">r</span>,
		<span class="pl-c1">Path</span>:    <span class="pl-s1">r</span>.<span class="pl-c1">URL</span>.<span class="pl-c1">Path</span>,
		<span class="pl-c1">Method</span>:  <span class="pl-s1">r</span>.<span class="pl-c1">Method</span>,
	}
}

<span class="pl-c">// PostForm 获取请求体参数</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">PostForm</span>(<span class="pl-s1">key</span> <span class="pl-smi">string</span>) <span class="pl-smi">string</span> {
	<span class="pl-k">return</span> <span class="pl-s1">c</span>.<span class="pl-c1">Request</span>.<span class="pl-en">FormValue</span>(<span class="pl-s1">key</span>)
}

<span class="pl-c">// Query 获取查询参数</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">Query</span>(<span class="pl-s1">key</span> <span class="pl-smi">string</span>) <span class="pl-smi">string</span> {
	<span class="pl-k">return</span> <span class="pl-s1">c</span>.<span class="pl-c1">Request</span>.<span class="pl-c1">URL</span>.<span class="pl-en">Query</span>().<span class="pl-en">Get</span>(<span class="pl-s1">key</span>)
}

<span class="pl-c">// Status 设置相应状态码</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">Status</span>(<span class="pl-s1">code</span> <span class="pl-smi">int</span>) {
	<span class="pl-s1">c</span>.<span class="pl-c1">StatusCode</span> <span class="pl-c1">=</span> <span class="pl-s1">code</span>
	<span class="pl-s1">c</span>.<span class="pl-c1">Writer</span>.<span class="pl-en">WriteHeader</span>(<span class="pl-s1">code</span>)
}

<span class="pl-c">// SetHeader 设置相应头</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">SetHeader</span>(<span class="pl-s1">key</span>, <span class="pl-s1">value</span> <span class="pl-smi">string</span>) {
	<span class="pl-s1">c</span>.<span class="pl-c1">Writer</span>.<span class="pl-en">Header</span>().<span class="pl-en">Set</span>(<span class="pl-s1">key</span>, <span class="pl-s1">value</span>)
}

<span class="pl-c">// Error 相应错误</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">Error</span>(<span class="pl-s1">code</span> <span class="pl-smi">int</span>) {
	<span class="pl-s1">c</span>.<span class="pl-en">SetHeader</span>(<span class="pl-s">"Content-Type"</span>, <span class="pl-s">"text/plain"</span>)
	<span class="pl-s1">c</span>.<span class="pl-en">Status</span>(<span class="pl-s1">code</span>)
}

<span class="pl-c">// String 相应字符串</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">String</span>(<span class="pl-s1">code</span> <span class="pl-smi">int</span>, <span class="pl-s1">format</span> <span class="pl-smi">string</span>, <span class="pl-s1">values</span> <span class="pl-c1">...</span><span class="pl-k">interface</span>{}) {
	<span class="pl-s1">c</span>.<span class="pl-en">SetHeader</span>(<span class="pl-s">"Content-Type"</span>, <span class="pl-s">"text/plain"</span>)
	<span class="pl-s1">c</span>.<span class="pl-en">Status</span>(<span class="pl-s1">code</span>)
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">Writer</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s1">format</span>, <span class="pl-s1">values</span><span class="pl-c1">...</span>)))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">c</span>.<span class="pl-en">Error</span>(<span class="pl-c1">500</span>)
	}
}

<span class="pl-c">// Json 相应Json</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">Json</span>(<span class="pl-s1">code</span> <span class="pl-smi">int</span>, <span class="pl-s1">obj</span> <span class="pl-k">interface</span>{}) {
	<span class="pl-s1">c</span>.<span class="pl-en">SetHeader</span>(<span class="pl-s">"Content-Type"</span>, <span class="pl-s">"application/json"</span>)
	<span class="pl-s1">c</span>.<span class="pl-en">Status</span>(<span class="pl-s1">code</span>)
	<span class="pl-s1">encoder</span> <span class="pl-c1">:=</span> <span class="pl-s1">json</span>.<span class="pl-en">NewEncoder</span>(<span class="pl-s1">c</span>.<span class="pl-c1">Writer</span>)
	<span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">encoder</span>.<span class="pl-en">Encode</span>(<span class="pl-s1">obj</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">c</span>.<span class="pl-en">Error</span>(<span class="pl-c1">500</span>)
	}
}

<span class="pl-c">// Data 相应Data</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">Data</span>(<span class="pl-s1">code</span> <span class="pl-smi">int</span>, <span class="pl-s1">data</span> []<span class="pl-smi">byte</span>) {
	<span class="pl-s1">c</span>.<span class="pl-en">Status</span>(<span class="pl-s1">code</span>)
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">Writer</span>.<span class="pl-en">Write</span>(<span class="pl-s1">data</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">c</span>.<span class="pl-en">Error</span>(<span class="pl-c1">500</span>)
	}
}

<span class="pl-c">// HTML 相应HTML</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">HTML</span>(<span class="pl-s1">code</span> <span class="pl-smi">int</span>, <span class="pl-s1">html</span> <span class="pl-smi">string</span>) {
	<span class="pl-s1">c</span>.<span class="pl-en">SetHeader</span>(<span class="pl-s">"Content-Type"</span>, <span class="pl-s">"text/html"</span>)
	<span class="pl-s1">c</span>.<span class="pl-en">Status</span>(<span class="pl-s1">code</span>)
	<span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">Writer</span>.<span class="pl-en">Write</span>([]<span class="pl-smi">byte</span>(<span class="pl-s1">html</span>))
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">c</span>.<span class="pl-en">Error</span>(<span class="pl-c1">500</span>)
	}
}

<span class="pl-c">// 调整框架</span>
<span class="pl-k">package</span> frame

<span class="pl-k">import</span> (
<span class="pl-s">"net/http"</span>
)

<span class="pl-c">// HandlerFunc 定义HandlerFunc用于设置用户请求约束 -设置为 func (*Context)</span>
<span class="pl-k">type</span> <span class="pl-smi">HandlerFunc</span> <span class="pl-k">func</span>(<span class="pl-c1">*</span><span class="pl-smi">Context</span>)

<span class="pl-k">type</span> <span class="pl-smi">Engine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">router</span> <span class="pl-c1">*</span><span class="pl-smi">router</span>
}

<span class="pl-k">func</span> <span class="pl-en">NewEngine</span>() <span class="pl-c1">*</span><span class="pl-smi">Engine</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">Engine</span>{
		<span class="pl-c1">router</span>: <span class="pl-en">newRouter</span>(),
	}
}
<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">AddRoute</span>(<span class="pl-s1">method</span>, <span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">e</span>.<span class="pl-c1">router</span>.<span class="pl-en">addRoute</span>(<span class="pl-s1">method</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-c">// ServeHTTP 实现此方法即可将此解构丢入ListenAndServe</span>
<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">ServeHTTP</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) {
	<span class="pl-c">// 构造请求-将请求封装到Context中</span>
	<span class="pl-s1">c</span> <span class="pl-c1">:=</span> <span class="pl-en">newContext</span>(<span class="pl-s1">w</span>, <span class="pl-s1">r</span>)
	<span class="pl-c">// 执行请求</span>
	<span class="pl-s1">e</span>.<span class="pl-c1">router</span>.<span class="pl-en">handle</span>(<span class="pl-s1">c</span>)
}</pre></div>
<h2><a id="user-content-0x05-前缀树路由" class="anchor" aria-hidden="true" href="#0x05-前缀树路由"><span aria-hidden="true" class="octicon octicon-link"></span></a>0x05 前缀树路由</h2>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> frame

<span class="pl-k">import</span> <span class="pl-s">"strings"</span>

<span class="pl-c">/*</span>
<span class="pl-c">使用前缀树实现路由匹配</span>
<span class="pl-c">*/</span>
<span class="pl-k">type</span> <span class="pl-smi">node</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">patten</span>   <span class="pl-smi">string</span>  <span class="pl-c">// 匹配路由</span>
	<span class="pl-c1">part</span>     <span class="pl-smi">string</span>  <span class="pl-c">//匹配路由中的一部分</span>
	<span class="pl-c1">children</span> []<span class="pl-c1">*</span><span class="pl-smi">node</span> <span class="pl-c">// 子节点</span>
	<span class="pl-c1">isWild</span>   <span class="pl-smi">bool</span>    <span class="pl-c">//是否精确匹配 part中含有：或者*时为true</span>
}

<span class="pl-c">// matchChild</span>
<span class="pl-k">func</span> (<span class="pl-s1">n</span> <span class="pl-c1">*</span><span class="pl-smi">node</span>) <span class="pl-en">matchChild</span>(<span class="pl-s1">part</span> <span class="pl-smi">string</span>) <span class="pl-c1">*</span><span class="pl-smi">node</span> {
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">child</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">n</span>.<span class="pl-c1">children</span> {
		<span class="pl-k">if</span> <span class="pl-s1">child</span>.<span class="pl-c1">part</span> <span class="pl-c1">==</span> <span class="pl-s1">part</span> <span class="pl-c1">||</span> <span class="pl-s1">child</span>.<span class="pl-c1">isWild</span> {
			<span class="pl-k">return</span> <span class="pl-s1">child</span>
		}
	}
	<span class="pl-k">return</span> <span class="pl-c1">nil</span>
}

<span class="pl-c">// matchChildren 匹配查找节点</span>
<span class="pl-k">func</span> (<span class="pl-s1">n</span> <span class="pl-c1">*</span><span class="pl-smi">node</span>) <span class="pl-en">matchChildren</span>(<span class="pl-s1">part</span> <span class="pl-smi">string</span>) []<span class="pl-c1">*</span><span class="pl-smi">node</span> {
	<span class="pl-s1">nodes</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-c1">*</span><span class="pl-smi">node</span>, <span class="pl-c1">0</span>)
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">child</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">n</span>.<span class="pl-c1">children</span> {
		<span class="pl-k">if</span> <span class="pl-s1">child</span>.<span class="pl-c1">part</span> <span class="pl-c1">==</span> <span class="pl-s1">part</span> <span class="pl-c1">||</span> <span class="pl-s1">child</span>.<span class="pl-c1">isWild</span> {
			<span class="pl-s1">nodes</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">nodes</span>, <span class="pl-s1">child</span>)
		}
	}
	<span class="pl-k">return</span> <span class="pl-s1">nodes</span>
}

<span class="pl-c">// insert 递归插入节点 从顶层往下层 层层查找并插入</span>
<span class="pl-k">func</span> (<span class="pl-s1">n</span> <span class="pl-c1">*</span><span class="pl-smi">node</span>) <span class="pl-en">insert</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">parts</span> []<span class="pl-smi">string</span>, <span class="pl-s1">height</span> <span class="pl-smi">int</span>) {
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">parts</span>) <span class="pl-c1">==</span> <span class="pl-s1">height</span> {
		<span class="pl-s1">n</span>.<span class="pl-c1">patten</span> <span class="pl-c1">=</span> <span class="pl-s1">patten</span>
		<span class="pl-k">return</span>
	}
	<span class="pl-s1">part</span> <span class="pl-c1">:=</span> <span class="pl-s1">parts</span>[<span class="pl-s1">height</span>]
	<span class="pl-s1">child</span> <span class="pl-c1">:=</span> <span class="pl-s1">n</span>.<span class="pl-en">matchChild</span>(<span class="pl-s1">part</span>)
	<span class="pl-k">if</span> <span class="pl-s1">child</span> <span class="pl-c1">==</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">child</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-smi">node</span>{<span class="pl-c1">part</span>: <span class="pl-s1">part</span>, <span class="pl-c1">isWild</span>: <span class="pl-s1">part</span>[<span class="pl-c1">0</span>] <span class="pl-c1">==</span> <span class="pl-s">':'</span> <span class="pl-c1">||</span> <span class="pl-s1">part</span>[<span class="pl-c1">0</span>] <span class="pl-c1">==</span> <span class="pl-s">'*'</span>}
		<span class="pl-s1">n</span>.<span class="pl-c1">children</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">n</span>.<span class="pl-c1">children</span>, <span class="pl-s1">child</span>)
	}
	<span class="pl-s1">child</span>.<span class="pl-en">insert</span>(<span class="pl-s1">patten</span>, <span class="pl-s1">parts</span>, <span class="pl-s1">height</span><span class="pl-c1">+</span><span class="pl-c1">1</span>)
}

<span class="pl-c">// search 递归查询节点</span>
<span class="pl-k">func</span> (<span class="pl-s1">n</span> <span class="pl-c1">*</span><span class="pl-smi">node</span>) <span class="pl-en">search</span>(<span class="pl-s1">parts</span> []<span class="pl-smi">string</span>, <span class="pl-s1">height</span> <span class="pl-smi">int</span>) <span class="pl-c1">*</span><span class="pl-smi">node</span> {
	<span class="pl-k">if</span> <span class="pl-en">len</span>(<span class="pl-s1">parts</span>) <span class="pl-c1">==</span> <span class="pl-s1">height</span> <span class="pl-c1">||</span> <span class="pl-s1">strings</span>.<span class="pl-en">HasPrefix</span>(<span class="pl-s1">n</span>.<span class="pl-c1">part</span>, <span class="pl-s">"*"</span>) {
		<span class="pl-k">if</span> <span class="pl-s1">n</span>.<span class="pl-c1">patten</span> <span class="pl-c1">==</span> <span class="pl-s">""</span> {
			<span class="pl-k">return</span> <span class="pl-c1">nil</span>
		}
		<span class="pl-k">return</span> <span class="pl-s1">n</span>
	}
	<span class="pl-s1">part</span> <span class="pl-c1">:=</span> <span class="pl-s1">parts</span>[<span class="pl-s1">height</span>]
	<span class="pl-s1">children</span> <span class="pl-c1">:=</span> <span class="pl-s1">n</span>.<span class="pl-en">matchChildren</span>(<span class="pl-s1">part</span>)
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">child</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">children</span> {
		<span class="pl-s1">result</span> <span class="pl-c1">:=</span> <span class="pl-s1">child</span>.<span class="pl-en">search</span>(<span class="pl-s1">parts</span>, <span class="pl-s1">height</span><span class="pl-c1">+</span><span class="pl-c1">1</span>)
		<span class="pl-k">if</span> <span class="pl-s1">result</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-k">return</span> <span class="pl-s1">result</span>
		}
	}
	<span class="pl-k">return</span> <span class="pl-c1">nil</span>
}

<span class="pl-k">package</span> frame

<span class="pl-k">import</span> (
<span class="pl-s">"net/http"</span>
<span class="pl-s">"strings"</span>
)

<span class="pl-c">/*</span>
<span class="pl-c">将用户请求路由拆出</span>
<span class="pl-c">*/</span>

<span class="pl-k">type</span> <span class="pl-smi">router</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">roots</span>    <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-c1">*</span><span class="pl-smi">node</span>
	<span class="pl-c1">handlers</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">HandlerFunc</span>
}

<span class="pl-k">func</span> <span class="pl-en">newRouter</span>() <span class="pl-c1">*</span><span class="pl-smi">router</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">router</span>{
		<span class="pl-c1">roots</span>:    <span class="pl-en">make</span>(<span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-c1">*</span><span class="pl-smi">node</span>),
		<span class="pl-c1">handlers</span>: <span class="pl-en">make</span>(<span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">HandlerFunc</span>),
	}
}

<span class="pl-k">func</span> <span class="pl-en">parsePatten</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>) []<span class="pl-smi">string</span> {
	<span class="pl-s1">pattenSplit</span> <span class="pl-c1">:=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Split</span>(<span class="pl-s1">patten</span>, <span class="pl-s">"/"</span>)

	<span class="pl-s1">parts</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>([]<span class="pl-smi">string</span>, <span class="pl-c1">0</span>)
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">item</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">pattenSplit</span> {
		<span class="pl-k">if</span> <span class="pl-s1">item</span> <span class="pl-c1">!=</span> <span class="pl-s">""</span> {
			<span class="pl-s1">parts</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">parts</span>, <span class="pl-s1">item</span>)
			<span class="pl-c">// 当前匹配到*便不再往下匹配</span>
			<span class="pl-k">if</span> <span class="pl-s1">item</span>[<span class="pl-c1">0</span>] <span class="pl-c1">==</span> <span class="pl-s">'*'</span> {
				<span class="pl-k">break</span>
			}
		}
	}
	<span class="pl-k">return</span> <span class="pl-s1">parts</span>
}

<span class="pl-c">// addRoute 添加路由时 动态注册至前缀树结构中</span>
<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">router</span>) <span class="pl-en">addRoute</span>(<span class="pl-s1">method</span>, <span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">parts</span> <span class="pl-c1">:=</span> <span class="pl-en">parsePatten</span>(<span class="pl-s1">patten</span>)
	<span class="pl-s1">key</span> <span class="pl-c1">:=</span> <span class="pl-s1">method</span> <span class="pl-c1">+</span> <span class="pl-s">"-"</span> <span class="pl-c1">+</span> <span class="pl-s1">patten</span>

	<span class="pl-s1">_</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">roots</span>[<span class="pl-s1">method</span>]
	<span class="pl-k">if</span> <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-s1">r</span>.<span class="pl-c1">roots</span>[<span class="pl-s1">method</span>] <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-smi">node</span>{}
	}

	<span class="pl-s1">r</span>.<span class="pl-c1">roots</span>[<span class="pl-s1">method</span>].<span class="pl-en">insert</span>(<span class="pl-s1">patten</span>, <span class="pl-s1">parts</span>, <span class="pl-c1">0</span>)
	<span class="pl-s1">r</span>.<span class="pl-c1">handlers</span>[<span class="pl-s1">key</span>] <span class="pl-c1">=</span> <span class="pl-s1">handler</span>
}

<span class="pl-c">// getRoute 获取时，从前缀树结构中获取</span>
<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">router</span>) <span class="pl-en">getRoute</span>(<span class="pl-s1">method</span>, <span class="pl-s1">path</span> <span class="pl-smi">string</span>) (<span class="pl-c1">*</span><span class="pl-smi">node</span>, <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>) {
	<span class="pl-s1">searchParts</span> <span class="pl-c1">:=</span> <span class="pl-en">parsePatten</span>(<span class="pl-s1">path</span>)
	<span class="pl-s1">params</span> <span class="pl-c1">:=</span> <span class="pl-en">make</span>(<span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span>)
	<span class="pl-s1">root</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">roots</span>[<span class="pl-s1">method</span>]
	<span class="pl-k">if</span> <span class="pl-c1">!</span><span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-c1">nil</span>, <span class="pl-c1">nil</span>
	}
	<span class="pl-s1">n</span> <span class="pl-c1">:=</span> <span class="pl-s1">root</span>.<span class="pl-en">search</span>(<span class="pl-s1">searchParts</span>, <span class="pl-c1">0</span>)
	<span class="pl-k">if</span> <span class="pl-s1">n</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">parts</span> <span class="pl-c1">:=</span> <span class="pl-en">parsePatten</span>(<span class="pl-s1">n</span>.<span class="pl-c1">patten</span>)
		<span class="pl-k">for</span> <span class="pl-s1">index</span>, <span class="pl-s1">part</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">parts</span> {
			<span class="pl-k">if</span> <span class="pl-s1">part</span>[<span class="pl-c1">0</span>] <span class="pl-c1">==</span> <span class="pl-s">':'</span> {
				<span class="pl-s1">params</span>[<span class="pl-s1">part</span>[<span class="pl-c1">1</span>:]] <span class="pl-c1">=</span> <span class="pl-s1">searchParts</span>[<span class="pl-s1">index</span>]
			}
			<span class="pl-k">if</span> <span class="pl-s1">part</span>[<span class="pl-c1">0</span>] <span class="pl-c1">==</span> <span class="pl-s">'*'</span> <span class="pl-c1">&amp;&amp;</span> <span class="pl-en">len</span>(<span class="pl-s1">part</span>) <span class="pl-c1">&gt;</span> <span class="pl-c1">1</span> {
				<span class="pl-s1">params</span>[<span class="pl-s1">part</span>[<span class="pl-c1">1</span>:]] <span class="pl-c1">=</span> <span class="pl-s1">strings</span>.<span class="pl-en">Join</span>(<span class="pl-s1">searchParts</span>[<span class="pl-s1">index</span>:], <span class="pl-s">"/"</span>)
				<span class="pl-k">break</span>
			}
		}
		<span class="pl-k">return</span> <span class="pl-s1">n</span>, <span class="pl-s1">params</span>
	}
	<span class="pl-k">return</span> <span class="pl-c1">nil</span>, <span class="pl-c1">nil</span>
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">router</span>) <span class="pl-en">handle</span>(<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) {
	<span class="pl-s1">n</span>, <span class="pl-s1">params</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-en">getRoute</span>(<span class="pl-s1">c</span>.<span class="pl-c1">Method</span>, <span class="pl-s1">c</span>.<span class="pl-c1">Path</span>)
	<span class="pl-k">if</span> <span class="pl-s1">n</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">c</span>.<span class="pl-c1">Params</span> <span class="pl-c1">=</span> <span class="pl-s1">params</span>
		<span class="pl-s1">key</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">Method</span> <span class="pl-c1">+</span> <span class="pl-s">"-"</span> <span class="pl-c1">+</span> <span class="pl-s1">n</span>.<span class="pl-c1">patten</span>
		<span class="pl-s1">r</span>.<span class="pl-c1">handlers</span>[<span class="pl-s1">key</span>](<span class="pl-s1">c</span>)
	} <span class="pl-k">else</span> {
		<span class="pl-s1">c</span>.<span class="pl-en">String</span>(<span class="pl-s1">http</span>.<span class="pl-c1">StatusNotFound</span>, <span class="pl-s">"404 NOT FOUND: %s<span class="pl-cce">\n</span>"</span>, <span class="pl-s1">c</span>.<span class="pl-c1">Path</span>)
	}
}

<span class="pl-k">package</span> frame

<span class="pl-c">/*</span>
<span class="pl-c">   对请求handler(w http.ResponseWriter, r *http.Request)进行封装</span>
<span class="pl-c">*/</span>

<span class="pl-k">import</span> (
<span class="pl-s">"encoding/json"</span>
<span class="pl-s">"fmt"</span>
<span class="pl-s">"net/http"</span>
)

<span class="pl-c">// H 约束用户传入结构格式</span>
<span class="pl-k">type</span> <span class="pl-smi">H</span> <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-k">interface</span>{}

<span class="pl-k">type</span> <span class="pl-smi">Context</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Writer</span>     http.<span class="pl-smi">ResponseWriter</span>
	<span class="pl-c1">Request</span>    <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>
	<span class="pl-c1">Path</span>       <span class="pl-smi">string</span>
	<span class="pl-c1">Method</span>     <span class="pl-smi">string</span>
	<span class="pl-c1">Params</span>     <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span> <span class="pl-c">// 获取路径参数</span>
	<span class="pl-c1">StatusCode</span> <span class="pl-smi">int</span>
}

<span class="pl-k">func</span> <span class="pl-en">newContext</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) <span class="pl-c1">*</span><span class="pl-smi">Context</span> {
	<span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">Context</span>{
		<span class="pl-c1">Writer</span>:  <span class="pl-s1">w</span>,
		<span class="pl-c1">Request</span>: <span class="pl-s1">r</span>,
		<span class="pl-c1">Path</span>:    <span class="pl-s1">r</span>.<span class="pl-c1">URL</span>.<span class="pl-c1">Path</span>,
		<span class="pl-c1">Method</span>:  <span class="pl-s1">r</span>.<span class="pl-c1">Method</span>,
	}
}

} <span class="pl-c">// Param 获取路径参数</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">Param</span>(<span class="pl-s1">key</span> <span class="pl-smi">string</span>) <span class="pl-smi">string</span> {
	<span class="pl-s1">v</span>, <span class="pl-s1">ok</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">Params</span>[<span class="pl-s1">key</span>]
	<span class="pl-k">if</span> <span class="pl-s1">ok</span> {
		<span class="pl-k">return</span> <span class="pl-s1">v</span>
	}
	<span class="pl-k">return</span> <span class="pl-s">""</span>
}</pre></div>
<h2><a id="user-content-0x06-路由分组" class="anchor" aria-hidden="true" href="#0x06-路由分组"><span aria-hidden="true" class="octicon octicon-link"></span></a>0x06 路由分组</h2>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> frame

<span class="pl-k">import</span> (
	<span class="pl-s">"net/http"</span>
)

<span class="pl-c">// HandlerFunc 定义HandlerFunc用于设置用户请求约束 -设置为 func (*Context)</span>
<span class="pl-k">type</span> <span class="pl-smi">HandlerFunc</span> <span class="pl-k">func</span>(<span class="pl-c1">*</span><span class="pl-smi">Context</span>)

<span class="pl-c">// RouterGroup 路由分组</span>
<span class="pl-k">type</span> <span class="pl-smi">RouterGroup</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">prefix</span>     <span class="pl-smi">string</span>
	<span class="pl-c1">middleware</span> []<span class="pl-smi">HandlerFunc</span> <span class="pl-c">// 中间件支持</span>
	<span class="pl-c1">parent</span>     <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>  <span class="pl-c">// 嵌套分组</span>
	<span class="pl-c1">engine</span>     <span class="pl-c1">*</span><span class="pl-smi">Engine</span>       <span class="pl-c">// 支持操作路由</span>
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">Group</span>(<span class="pl-s1">prefix</span> <span class="pl-smi">string</span>) <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span> {
	<span class="pl-s1">engine</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">engine</span>
	<span class="pl-s1">newGroup</span> <span class="pl-c1">:=</span> <span class="pl-c1">&amp;</span><span class="pl-smi">RouterGroup</span>{
		<span class="pl-c1">prefix</span>: <span class="pl-s1">r</span>.<span class="pl-c1">prefix</span> <span class="pl-c1">+</span> <span class="pl-s1">prefix</span>,
		<span class="pl-c1">parent</span>: <span class="pl-s1">r</span>,
		<span class="pl-c1">engine</span>: <span class="pl-s1">engine</span>,
	}
	<span class="pl-s1">engine</span>.<span class="pl-c1">groups</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">engine</span>.<span class="pl-c1">groups</span>, <span class="pl-s1">newGroup</span>)
	<span class="pl-k">return</span> <span class="pl-s1">newGroup</span>
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">AddRoute</span>(<span class="pl-s1">method</span>, <span class="pl-s1">comp</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">patten</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">prefix</span> <span class="pl-c1">+</span> <span class="pl-s1">comp</span>
	<span class="pl-s1">r</span>.<span class="pl-c1">engine</span>.<span class="pl-c1">router</span>.<span class="pl-en">addRoute</span>(<span class="pl-s1">method</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">GET</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">r</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"GET"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">POST</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">r</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"POST"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">PUT</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">r</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"PUT"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">DELETE</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">r</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"DELETE"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">Any</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>, <span class="pl-s1">handler</span> <span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">r</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"GET"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
	<span class="pl-s1">r</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"POST"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
	<span class="pl-s1">r</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"PUT"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
	<span class="pl-s1">r</span>.<span class="pl-en">AddRoute</span>(<span class="pl-s">"DELETE"</span>, <span class="pl-s1">patten</span>, <span class="pl-s1">handler</span>)
}

<span class="pl-k">type</span> <span class="pl-smi">Engine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span> <span class="pl-c">//当前engine可以使用路由组中的方法</span>
	<span class="pl-c1">router</span>       <span class="pl-c1">*</span><span class="pl-smi">router</span>
	<span class="pl-c1">groups</span>       []<span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span> <span class="pl-c">// 存储所有分组</span>
}

<span class="pl-k">func</span> <span class="pl-en">NewEngine</span>() <span class="pl-c1">*</span><span class="pl-smi">Engine</span> {
	<span class="pl-s1">engine</span> <span class="pl-c1">:=</span> <span class="pl-c1">&amp;</span><span class="pl-smi">Engine</span>{
		<span class="pl-c1">router</span>: <span class="pl-en">newRouter</span>(),
	}
	<span class="pl-s1">engine</span>.<span class="pl-c1">RouterGroup</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-smi">RouterGroup</span>{<span class="pl-c1">engine</span>: <span class="pl-s1">engine</span>}
	<span class="pl-s1">engine</span>.<span class="pl-c1">groups</span> <span class="pl-c1">=</span> []<span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>{<span class="pl-s1">engine</span>.<span class="pl-c1">RouterGroup</span>}
	<span class="pl-k">return</span> <span class="pl-s1">engine</span>
}</pre></div>
<h2><a id="user-content-0x07-中间件" class="anchor" aria-hidden="true" href="#0x07-中间件"><span aria-hidden="true" class="octicon octicon-link"></span></a>0x07 中间件</h2>
<div class="highlight highlight-source-go"><pre><span class="pl-c">// Use 实现中间件的添加</span>
<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">Use</span>(<span class="pl-s1">middlewares</span> <span class="pl-c1">...</span><span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">r</span>.<span class="pl-c1">middleware</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">r</span>.<span class="pl-c1">middleware</span>, <span class="pl-s1">middlewares</span><span class="pl-c1">...</span>)
}

<span class="pl-c">// ServeHTTP 实现此方法即可将此解构丢入ListenAndServe</span>
<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">ServeHTTP</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) {
    <span class="pl-c">// 确认是否存在中间件</span>
    <span class="pl-k">var</span> <span class="pl-s1">middlewares</span> []<span class="pl-smi">HandlerFunc</span>
    <span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">rGroup</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">e</span>.<span class="pl-c1">groups</span> {
    <span class="pl-s1">middlewares</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">middlewares</span>, <span class="pl-s1">rGroup</span>.<span class="pl-c1">middleware</span><span class="pl-c1">...</span>)
    }
    <span class="pl-c">// 构造请求-将请求封装到Context中</span>
    <span class="pl-s1">c</span> <span class="pl-c1">:=</span> <span class="pl-en">newContext</span>(<span class="pl-s1">w</span>, <span class="pl-s1">r</span>)
    <span class="pl-c">// 将中间件封装至Context</span>
    <span class="pl-s1">c</span>.<span class="pl-c1">handlers</span> <span class="pl-c1">=</span> <span class="pl-s1">middlewares</span>
    <span class="pl-c">// 执行请求</span>
    <span class="pl-s1">e</span>.<span class="pl-c1">router</span>.<span class="pl-en">handle</span>(<span class="pl-s1">c</span>)
}

<span class="pl-k">type</span> <span class="pl-smi">Context</span> <span class="pl-k">struct</span> {
    <span class="pl-c1">Writer</span>     http.<span class="pl-smi">ResponseWriter</span>
    <span class="pl-c1">Request</span>    <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>
    <span class="pl-c1">Path</span>       <span class="pl-smi">string</span>
    <span class="pl-c1">Method</span>     <span class="pl-smi">string</span>
    <span class="pl-c1">Params</span>     <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span> <span class="pl-c">// 获取路径参数</span>
    <span class="pl-c1">StatusCode</span> <span class="pl-smi">int</span>
    
    <span class="pl-c1">handlers</span> []<span class="pl-smi">HandlerFunc</span> <span class="pl-c">// 保存中间件 方便中间件的后续调用</span>
    <span class="pl-c1">index</span>    <span class="pl-smi">int</span>
}

<span class="pl-k">func</span> <span class="pl-en">newContext</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) <span class="pl-c1">*</span><span class="pl-smi">Context</span> {
    <span class="pl-k">return</span> <span class="pl-c1">&amp;</span><span class="pl-smi">Context</span>{
    <span class="pl-c1">Writer</span>:  <span class="pl-s1">w</span>,
    <span class="pl-c1">Request</span>: <span class="pl-s1">r</span>,
    <span class="pl-c1">Path</span>:    <span class="pl-s1">r</span>.<span class="pl-c1">URL</span>.<span class="pl-c1">Path</span>,
    <span class="pl-c1">Method</span>:  <span class="pl-s1">r</span>.<span class="pl-c1">Method</span>,
    <span class="pl-c1">index</span>:   <span class="pl-c1">-</span><span class="pl-c1">1</span>,
    }
}

<span class="pl-c">// Next 中间件</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">Next</span>() {
    <span class="pl-s1">c</span>.<span class="pl-c1">index</span><span class="pl-c1">++</span>
    <span class="pl-k">for</span> ; <span class="pl-s1">c</span>.<span class="pl-c1">index</span> <span class="pl-c1">&lt;</span> <span class="pl-en">len</span>(<span class="pl-s1">c</span>.<span class="pl-c1">handlers</span>); <span class="pl-s1">c</span>.<span class="pl-c1">index</span><span class="pl-c1">++</span> {
    <span class="pl-s1">c</span>.<span class="pl-c1">handlers</span>[<span class="pl-s1">c</span>.<span class="pl-c1">index</span>](<span class="pl-s1">c</span>)
    }
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">router</span>) <span class="pl-en">handle</span>(<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) {
    <span class="pl-s1">n</span>, <span class="pl-s1">params</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-en">getRoute</span>(<span class="pl-s1">c</span>.<span class="pl-c1">Method</span>, <span class="pl-s1">c</span>.<span class="pl-c1">Path</span>)
    <span class="pl-c">/*</span>
<span class="pl-c">        将中间封装至请求中，通过Next来启动</span>
<span class="pl-c">    */</span>
    <span class="pl-k">if</span> <span class="pl-s1">n</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
    <span class="pl-s1">c</span>.<span class="pl-c1">Params</span> <span class="pl-c1">=</span> <span class="pl-s1">params</span> <span class="pl-c">// 将参数封装至Context</span>
    <span class="pl-s1">key</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">Method</span> <span class="pl-c1">+</span> <span class="pl-s">"-"</span> <span class="pl-c1">+</span> <span class="pl-s1">n</span>.<span class="pl-c1">patten</span>
    <span class="pl-s1">c</span>.<span class="pl-c1">handlers</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">c</span>.<span class="pl-c1">handlers</span>, <span class="pl-s1">r</span>.<span class="pl-c1">handlers</span>[<span class="pl-s1">key</span>])
    <span class="pl-c">//r.handlers[key](c) 这段直接被放在中间件之后，中间件通过Next启动后，会主动将Context传递至Handler中</span>
    } <span class="pl-k">else</span> {
    <span class="pl-s1">c</span>.<span class="pl-c1">handlers</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">c</span>.<span class="pl-c1">handlers</span>, <span class="pl-k">func</span>(<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) {
    <span class="pl-s1">c</span>.<span class="pl-en">String</span>(<span class="pl-s1">http</span>.<span class="pl-c1">StatusNotFound</span>, <span class="pl-s">"404 NOT FOUND: %s<span class="pl-cce">\n</span>"</span>, <span class="pl-s1">c</span>.<span class="pl-c1">Path</span>)
    })
    }
    
    <span class="pl-c">// 向下处理</span>
    <span class="pl-s1">c</span>.<span class="pl-en">Next</span>()
}</pre></div>
<h2><a id="user-content-0x08-静态文件模板渲染" class="anchor" aria-hidden="true" href="#0x08-静态文件模板渲染"><span aria-hidden="true" class="octicon octicon-link"></span></a>0x08 静态文件&amp;模板渲染</h2>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> frame

<span class="pl-k">import</span> (
	<span class="pl-s">"html/template"</span>
	<span class="pl-s">"net/http"</span>
	<span class="pl-s">"path"</span>
)

<span class="pl-c">// HandlerFunc 定义HandlerFunc用于设置用户请求约束 -设置为 func (*Context)</span>
<span class="pl-k">type</span> <span class="pl-smi">HandlerFunc</span> <span class="pl-k">func</span>(<span class="pl-c1">*</span><span class="pl-smi">Context</span>)

<span class="pl-c">// RouterGroup 路由分组</span>
<span class="pl-k">type</span> <span class="pl-smi">RouterGroup</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">prefix</span>     <span class="pl-smi">string</span>
	<span class="pl-c1">middleware</span> []<span class="pl-smi">HandlerFunc</span> <span class="pl-c">// 中间件支持</span>
	<span class="pl-c1">parent</span>     <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>  <span class="pl-c">// 嵌套分组</span>
	<span class="pl-c1">engine</span>     <span class="pl-c1">*</span><span class="pl-smi">Engine</span>       <span class="pl-c">// 支持操作路由</span>
}

<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">Group</span>(<span class="pl-s1">prefix</span> <span class="pl-smi">string</span>) <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span> {
	<span class="pl-s1">engine</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-c1">engine</span>
	<span class="pl-s1">newGroup</span> <span class="pl-c1">:=</span> <span class="pl-c1">&amp;</span><span class="pl-smi">RouterGroup</span>{
		<span class="pl-c1">prefix</span>: <span class="pl-s1">r</span>.<span class="pl-c1">prefix</span> <span class="pl-c1">+</span> <span class="pl-s1">prefix</span>,
		<span class="pl-c1">parent</span>: <span class="pl-s1">r</span>,
		<span class="pl-c1">engine</span>: <span class="pl-s1">engine</span>,
	}
	<span class="pl-s1">engine</span>.<span class="pl-c1">groups</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">engine</span>.<span class="pl-c1">groups</span>, <span class="pl-s1">newGroup</span>)
	<span class="pl-k">return</span> <span class="pl-s1">newGroup</span>
}

<span class="pl-c">// createStaticHandler 借用http FileHandler对静态文件进行处理</span>
<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">createStaticHandler</span>(<span class="pl-s1">relativePath</span> <span class="pl-smi">string</span>, <span class="pl-s1">fs</span> http.<span class="pl-smi">FileSystem</span>) <span class="pl-smi">HandlerFunc</span> {
	<span class="pl-s1">absolutePath</span> <span class="pl-c1">:=</span> <span class="pl-s1">path</span>.<span class="pl-en">Join</span>(<span class="pl-s1">r</span>.<span class="pl-c1">prefix</span>, <span class="pl-s1">relativePath</span>)
	<span class="pl-s1">fileServer</span> <span class="pl-c1">:=</span> <span class="pl-s1">http</span>.<span class="pl-en">StripPrefix</span>(<span class="pl-s1">absolutePath</span>, <span class="pl-s1">http</span>.<span class="pl-en">FileServer</span>(<span class="pl-s1">fs</span>))
	<span class="pl-k">return</span> <span class="pl-k">func</span>(<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) {
		<span class="pl-s1">file</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-en">Param</span>(<span class="pl-s">"filename"</span>)
		<span class="pl-k">if</span> <span class="pl-s1">_</span>, <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">fs</span>.<span class="pl-en">Open</span>(<span class="pl-s1">file</span>); <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
			<span class="pl-s1">c</span>.<span class="pl-en">Status</span>(<span class="pl-c1">404</span>)
			<span class="pl-k">return</span>
		}
		<span class="pl-s1">fileServer</span>.<span class="pl-en">ServeHTTP</span>(<span class="pl-s1">c</span>.<span class="pl-c1">Writer</span>, <span class="pl-s1">c</span>.<span class="pl-c1">Request</span>)
	}
}

<span class="pl-c">// Use 实现中间件的添加</span>
<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">Use</span>(<span class="pl-s1">middlewares</span> <span class="pl-c1">...</span><span class="pl-smi">HandlerFunc</span>) {
	<span class="pl-s1">r</span>.<span class="pl-c1">middleware</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">r</span>.<span class="pl-c1">middleware</span>, <span class="pl-s1">middlewares</span><span class="pl-c1">...</span>)
}

<span class="pl-c">// Static 处理静态文件</span>
<span class="pl-k">func</span> (<span class="pl-s1">r</span> <span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>) <span class="pl-en">Static</span>(<span class="pl-s1">relativePath</span>, <span class="pl-s1">root</span> <span class="pl-smi">string</span>) {
	<span class="pl-c">// 构造文件处理器</span>
	<span class="pl-s1">handler</span> <span class="pl-c1">:=</span> <span class="pl-s1">r</span>.<span class="pl-en">createStaticHandler</span>(<span class="pl-s1">relativePath</span>, <span class="pl-s1">http</span>.<span class="pl-en">Dir</span>(<span class="pl-s1">root</span>))

	<span class="pl-c">// 构造请求路径，*匹配文件</span>
	<span class="pl-s1">urlPatten</span> <span class="pl-c1">:=</span> <span class="pl-s1">path</span>.<span class="pl-en">Join</span>(<span class="pl-s1">relativePath</span>, <span class="pl-s">"/*filename"</span>)
	<span class="pl-s1">r</span>.<span class="pl-en">GET</span>(<span class="pl-s1">urlPatten</span>, <span class="pl-s1">handler</span>)
}


<span class="pl-k">type</span> <span class="pl-smi">Engine</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>  <span class="pl-c">//当前engine可以使用路由组中的方法</span>
	<span class="pl-c1">router</span>        <span class="pl-c1">*</span><span class="pl-smi">router</span>
	<span class="pl-c1">groups</span>        []<span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>     <span class="pl-c">// 存储所有分组</span>
	<span class="pl-c1">htmlTemplates</span> <span class="pl-c1">*</span>template.<span class="pl-smi">Template</span> <span class="pl-c">// 添加HTML template支持</span>
	<span class="pl-c1">funcMap</span>       template.<span class="pl-smi">FuncMap</span>   <span class="pl-c">// 添加HTML funcMap</span>
}

<span class="pl-k">func</span> <span class="pl-en">NewEngine</span>() <span class="pl-c1">*</span><span class="pl-smi">Engine</span> {
	<span class="pl-s1">engine</span> <span class="pl-c1">:=</span> <span class="pl-c1">&amp;</span><span class="pl-smi">Engine</span>{
		<span class="pl-c1">router</span>: <span class="pl-en">newRouter</span>(),
	}
	<span class="pl-s1">engine</span>.<span class="pl-c1">RouterGroup</span> <span class="pl-c1">=</span> <span class="pl-c1">&amp;</span><span class="pl-smi">RouterGroup</span>{<span class="pl-c1">engine</span>: <span class="pl-s1">engine</span>}
	<span class="pl-s1">engine</span>.<span class="pl-c1">groups</span> <span class="pl-c1">=</span> []<span class="pl-c1">*</span><span class="pl-smi">RouterGroup</span>{<span class="pl-s1">engine</span>.<span class="pl-c1">RouterGroup</span>}
	<span class="pl-k">return</span> <span class="pl-s1">engine</span>
}

<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">SetFuncMap</span>(<span class="pl-s1">funcMap</span> template.<span class="pl-smi">FuncMap</span>) {
	<span class="pl-s1">e</span>.<span class="pl-c1">funcMap</span> <span class="pl-c1">=</span> <span class="pl-s1">funcMap</span>
}

<span class="pl-c">// LoadHTMLGlob 加载静态文件并使用funcMap渲染</span>
<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">LoadHTMLGlob</span>(<span class="pl-s1">patten</span> <span class="pl-smi">string</span>) {
	<span class="pl-s1">e</span>.<span class="pl-c1">htmlTemplates</span> <span class="pl-c1">=</span> <span class="pl-s1">template</span>.<span class="pl-en">Must</span>(<span class="pl-s1">template</span>.<span class="pl-en">New</span>(<span class="pl-s">""</span>).<span class="pl-en">Funcs</span>(<span class="pl-s1">e</span>.<span class="pl-c1">funcMap</span>).<span class="pl-en">ParseGlob</span>(<span class="pl-s1">patten</span>))
}

<span class="pl-c">// ServeHTTP 实现此方法即可将此解构丢入ListenAndServe</span>
<span class="pl-k">func</span> (<span class="pl-s1">e</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span>) <span class="pl-en">ServeHTTP</span>(<span class="pl-s1">w</span> http.<span class="pl-smi">ResponseWriter</span>, <span class="pl-s1">r</span> <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>) {
	<span class="pl-c">// 确认是否存在中间件</span>
	<span class="pl-k">var</span> <span class="pl-s1">middlewares</span> []<span class="pl-smi">HandlerFunc</span>
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">rGroup</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">e</span>.<span class="pl-c1">groups</span> {
		<span class="pl-s1">middlewares</span> <span class="pl-c1">=</span> <span class="pl-en">append</span>(<span class="pl-s1">middlewares</span>, <span class="pl-s1">rGroup</span>.<span class="pl-c1">middleware</span><span class="pl-c1">...</span>)
	}
	<span class="pl-c">// 构造请求-将请求封装到Context中</span>
	<span class="pl-s1">c</span> <span class="pl-c1">:=</span> <span class="pl-en">newContext</span>(<span class="pl-s1">w</span>, <span class="pl-s1">r</span>)
	<span class="pl-c">// 将中间件封装至Context</span>
	<span class="pl-s1">c</span>.<span class="pl-c1">handlers</span> <span class="pl-c1">=</span> <span class="pl-s1">middlewares</span>
	<span class="pl-c">// 将engine封装至Context</span>
	<span class="pl-s1">c</span>.<span class="pl-c1">engine</span> <span class="pl-c1">=</span> <span class="pl-s1">e</span>
	<span class="pl-c">// 执行请求</span>
	<span class="pl-s1">e</span>.<span class="pl-c1">router</span>.<span class="pl-en">handle</span>(<span class="pl-s1">c</span>)
}

<span class="pl-k">type</span> <span class="pl-smi">Context</span> <span class="pl-k">struct</span> {
	<span class="pl-c1">Writer</span>     http.<span class="pl-smi">ResponseWriter</span>
	<span class="pl-c1">Request</span>    <span class="pl-c1">*</span>http.<span class="pl-smi">Request</span>
	<span class="pl-c1">Path</span>       <span class="pl-smi">string</span>
	<span class="pl-c1">Method</span>     <span class="pl-smi">string</span>
	<span class="pl-c1">Params</span>     <span class="pl-k">map</span>[<span class="pl-smi">string</span>]<span class="pl-smi">string</span> <span class="pl-c">// 获取路径参数</span>
	<span class="pl-c1">StatusCode</span> <span class="pl-smi">int</span>

	<span class="pl-c1">handlers</span> []<span class="pl-smi">HandlerFunc</span> <span class="pl-c">// 保存中间件 方便中间件的后续调用</span>
	<span class="pl-c1">index</span>    <span class="pl-smi">int</span>

	<span class="pl-c1">engine</span> <span class="pl-c1">*</span><span class="pl-smi">Engine</span> <span class="pl-c">//可通过Context访问engine</span>
}

<span class="pl-c">// HTML 相应HTML</span>
<span class="pl-k">func</span> (<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) <span class="pl-en">HTML</span>(<span class="pl-s1">code</span> <span class="pl-smi">int</span>, <span class="pl-s1">name</span> <span class="pl-smi">string</span>, <span class="pl-s1">data</span> <span class="pl-k">interface</span>{}) {
	<span class="pl-s1">c</span>.<span class="pl-en">SetHeader</span>(<span class="pl-s">"Content-Type"</span>, <span class="pl-s">"text/html"</span>)
	<span class="pl-s1">c</span>.<span class="pl-en">Status</span>(<span class="pl-s1">code</span>)
	<span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-s1">c</span>.<span class="pl-c1">engine</span>.<span class="pl-c1">htmlTemplates</span>.<span class="pl-en">ExecuteTemplate</span>(<span class="pl-s1">c</span>.<span class="pl-c1">Writer</span>, <span class="pl-s1">name</span>, <span class="pl-s1">data</span>)
	<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
		<span class="pl-s1">c</span>.<span class="pl-en">Error</span>(<span class="pl-c1">500</span>)
	}
}</pre></div>
<h2><a id="user-content-0x09-错误恢复" class="anchor" aria-hidden="true" href="#0x09-错误恢复"><span aria-hidden="true" class="octicon octicon-link"></span></a>0x09 错误恢复</h2>
<div class="highlight highlight-source-go"><pre><span class="pl-k">package</span> frame

<span class="pl-k">import</span> (
	<span class="pl-s">"fmt"</span>
	<span class="pl-s">"log"</span>
	<span class="pl-s">"runtime"</span>
	<span class="pl-s">"strings"</span>
)

<span class="pl-k">func</span> <span class="pl-en">trace</span>(<span class="pl-s1">err</span> <span class="pl-smi">string</span>) <span class="pl-smi">string</span> {
	<span class="pl-k">var</span> <span class="pl-s1">pcs</span> [<span class="pl-c1">32</span>]<span class="pl-smi">uintptr</span>
	<span class="pl-s1">n</span> <span class="pl-c1">:=</span> <span class="pl-s1">runtime</span>.<span class="pl-en">Callers</span>(<span class="pl-c1">3</span>, <span class="pl-s1">pcs</span>[:]) <span class="pl-c">// skip first 3 caller</span>
	<span class="pl-k">var</span> <span class="pl-s1">str</span> strings.<span class="pl-smi">Builder</span>
	<span class="pl-s1">str</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">err</span> <span class="pl-c1">+</span> <span class="pl-s">"<span class="pl-cce">\n</span>Traceback:"</span>)
	<span class="pl-k">for</span> <span class="pl-s1">_</span>, <span class="pl-s1">pc</span> <span class="pl-c1">:=</span> <span class="pl-k">range</span> <span class="pl-s1">pcs</span>[:<span class="pl-s1">n</span>] {
		<span class="pl-s1">fn</span> <span class="pl-c1">:=</span> <span class="pl-s1">runtime</span>.<span class="pl-en">FuncForPC</span>(<span class="pl-s1">pc</span>)
		<span class="pl-s1">file</span>, <span class="pl-s1">line</span> <span class="pl-c1">:=</span> <span class="pl-s1">fn</span>.<span class="pl-en">FileLine</span>(<span class="pl-s1">pc</span>)
		<span class="pl-s1">str</span>.<span class="pl-en">WriteString</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"<span class="pl-cce">\n</span><span class="pl-cce">\t</span>%s:%d"</span>, <span class="pl-s1">file</span>, <span class="pl-s1">line</span>))
	}
	<span class="pl-k">return</span> <span class="pl-s1">str</span>.<span class="pl-en">String</span>()
}

<span class="pl-c">// Recovery 捕获异常</span>
<span class="pl-k">func</span> <span class="pl-en">Recovery</span>() <span class="pl-smi">HandlerFunc</span> {
	<span class="pl-k">return</span> <span class="pl-k">func</span>(<span class="pl-s1">c</span> <span class="pl-c1">*</span><span class="pl-smi">Context</span>) {
		<span class="pl-k">defer</span> <span class="pl-k">func</span>() {
			<span class="pl-k">if</span> <span class="pl-s1">err</span> <span class="pl-c1">:=</span> <span class="pl-en">recover</span>(); <span class="pl-s1">err</span> <span class="pl-c1">!=</span> <span class="pl-c1">nil</span> {
				<span class="pl-s1">msg</span> <span class="pl-c1">:=</span> <span class="pl-en">trace</span>(<span class="pl-s1">fmt</span>.<span class="pl-en">Sprintf</span>(<span class="pl-s">"%s"</span>, <span class="pl-s1">err</span>))
				<span class="pl-s1">log</span>.<span class="pl-en">Printf</span>(<span class="pl-s">"%s<span class="pl-cce">\n</span><span class="pl-cce">\n</span>"</span>, <span class="pl-s1">msg</span>)
			}
		}()
		<span class="pl-s1">c</span>.<span class="pl-en">Next</span>()
	}
}</pre></div>

      </article>
    </div>
  </div>
  <div class="
    side
    Box
    md
    js-code-block-container
    Box--responsive
    container-right-nav
    mt-5
    d-none d-lg-block
  " style="overflow: hidden;">
    <div class="Box-body p-5">
      <div class="container-right-nav-logo">
        <a href="https://www.github.com/Bean-jun"><svg height="32" class="octicon octicon-mark-github anim-pulse"
            viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true">
            <path fill-rule="evenodd"
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z">
            </path>
          </svg></a>
      </div>
    </div>
    <div class="content-title-nav">
      <ul>
        <li><a href="#0x01 基础的http请求接口实现">0x01 基础的http请求接口实现</a></li><li><a href="#0x02 自定义Handler-实现ServerHTTP方法">0x02 自定义Handler-实现ServerHTTP方法</a></li><li><a href="#0x03 仿gin,可自定义请求动作">0x03 仿gin,可自定义请求动作</a></li><li><a href="#0x04 分离路由&封装请求">0x04 分离路由&封装请求</a></li><li><a href="#0x05 前缀树路由">0x05 前缀树路由</a></li><li><a href="#0x06 路由分组">0x06 路由分组</a></li><li><a href="#0x07 中间件">0x07 中间件</a></li><li><a href="#0x08 静态文件&模板渲染">0x08 静态文件&模板渲染</a></li><li><a href="#0x09 错误恢复">0x09 错误恢复</a></li>
      </ul>
    </div>
  </div>
  <script src="/.static/js/theme.js"></script>
  <script src="/.static/js/iconify.min.js"></script>
</body>

</html>