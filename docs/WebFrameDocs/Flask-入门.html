<!DOCTYPE html>
<html lang="en">
<html>

<head>
  <meta charset="UTF-8">
  <link href="/.static/css/primer.css" rel="stylesheet" />
  <link rel="stylesheet alternate" href="/.static/css/github-light.css" id="light-hl">
  <link rel="stylesheet alternate" href="/.static/css/github-dark.css" id="dark-hl">
  <link rel="stylesheet" href="/.static/css/main.css">
  <title>Flask-入门.md</title>
</head>

<body id="markdown-body" data-color-mode="light" data-dark-theme="light">
  <!-- <div class="
  Box
  md
  js-code-block-container
  Box--responsive
  container-nav
  container-left-nav
  mt-5
  d-none d-lg-block
">
    <div class="Box-body p-5">
      <div class="d-flex flex-column flex-sm-row-reverse">
        <h1>填充...</h1>
      </div>
    </div>
    <div>填充</div>
  </div> -->
  <div class="
        Box
        md
        js-code-block-container
        Box--responsive
        container-xl
        px-3 px-md-4 px-lg-5
        mt-5
      " id="content">
    <div class="Box-body px-5 pb-5">
      <div class="d-flex flex-column flex-sm-row-reverse">
        <div class="border rounded-3 to-home">
          <a href="/">返回主页</a>
        </div>
        <div>
          <button id="theme-button" class="btn" type="button">
            <span id="theme-icon" class="iconify" data-icon="octicon:sun-16"></span>
          </button>
        </div>
        <div class="article-size">
          <span>2117字 | 5分钟</span>
        </div>
      </div>
      <article class="markdown-body entry-content container-lg" itemprop="text">
        <h3><a id="user-content-一视图" class="anchor" aria-hidden="true" href="#一视图"><span aria-hidden="true" class="octicon octicon-link"></span></a>一、视图</h3>
<ol>
<li>FBV 和CBV写法简介</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>, <span class="pl-s1">views</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)


<span class="pl-k">def</span> <span class="pl-en">auth</span>(<span class="pl-s1">func</span>):
    <span class="pl-k">def</span> <span class="pl-en">inner</span>(<span class="pl-c1">*</span><span class="pl-s1">args</span>, <span class="pl-c1">**</span><span class="pl-s1">kwargs</span>):
        <span class="pl-en">print</span>(<span class="pl-s">'before'</span>)
        <span class="pl-s1">result</span> <span class="pl-c1">=</span> <span class="pl-en">func</span>(<span class="pl-c1">*</span><span class="pl-s1">args</span>, <span class="pl-c1">**</span><span class="pl-s1">kwargs</span>)
        <span class="pl-en">print</span>(<span class="pl-s">'after'</span>)
        <span class="pl-k">return</span> <span class="pl-s1">result</span>

    <span class="pl-k">return</span> <span class="pl-s1">inner</span>


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/'</span>, <span class="pl-s1">methods</span><span class="pl-c1">=</span>[<span class="pl-s">'GET'</span>], <span class="pl-s1">endpoint</span><span class="pl-c1">=</span><span class="pl-s">'index_1'</span>)</span>
<span class="pl-en">@<span class="pl-s1">auth</span></span>
<span class="pl-k">def</span> <span class="pl-en">index</span>():
    <span class="pl-s">"""自定义页"""</span>
    <span class="pl-k">return</span> <span class="pl-s">"hello"</span>


<span class="pl-k">class</span> <span class="pl-v">IndexView</span>(<span class="pl-s1">views</span>.<span class="pl-v">View</span>):
    <span class="pl-s1">methods</span> <span class="pl-c1">=</span> [<span class="pl-s">'GET'</span>]
    <span class="pl-s1">decorators</span> <span class="pl-c1">=</span> [<span class="pl-s1">auth</span>, ]

    <span class="pl-k">def</span> <span class="pl-en">dispatch_request</span>(<span class="pl-s1">self</span>):
        <span class="pl-en">print</span>(<span class="pl-s">'Index'</span>)
        <span class="pl-k">return</span> <span class="pl-s">'Index!'</span>


<span class="pl-s1">app</span>.<span class="pl-en">add_url_rule</span>(<span class="pl-s">'/index'</span>, <span class="pl-s1">view_func</span><span class="pl-c1">=</span><span class="pl-v">IndexView</span>.<span class="pl-en">as_view</span>(<span class="pl-s1">name</span><span class="pl-c1">=</span><span class="pl-s">'index'</span>))  <span class="pl-c"># name=endpoint</span>


<span class="pl-c"># 或者继承自MethodView，调用写好的dispatch_request</span>


<span class="pl-k">class</span> <span class="pl-v">IndexView</span>(<span class="pl-s1">views</span>.<span class="pl-v">MethodView</span>):
    <span class="pl-s1">methods</span> <span class="pl-c1">=</span> [<span class="pl-s">'GET'</span>]
    <span class="pl-s1">decorators</span> <span class="pl-c1">=</span> [<span class="pl-s1">auth</span>, ]

    <span class="pl-k">def</span> <span class="pl-en">get</span>(<span class="pl-s1">self</span>):
        <span class="pl-k">return</span> <span class="pl-s">'Index.GET'</span>

    <span class="pl-k">def</span> <span class="pl-en">post</span>(<span class="pl-s1">self</span>):
        <span class="pl-k">return</span> <span class="pl-s">'Index.POST'</span>


<span class="pl-s1">app</span>.<span class="pl-en">add_url_rule</span>(<span class="pl-s">'/index'</span>, <span class="pl-s1">view_func</span><span class="pl-c1">=</span><span class="pl-v">IndexView</span>.<span class="pl-en">as_view</span>(<span class="pl-s1">name</span><span class="pl-c1">=</span><span class="pl-s">'index'</span>))  <span class="pl-c"># name=endpoint</span></pre></div>
<ol start="2">
<li>request及response内容</li>
</ol>
<div class="highlight highlight-source-gfm"><pre><span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>请求相关信息</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.method</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.args 和 django的request.GET相同</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.form 和 django的request.POST相同</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.values</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.cookies</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.headers</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.path</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.full_path</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.script_root</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.url</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.base_url</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.url_root</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.host_url</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.host</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>request.files</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>obj = request.files['the_file_name']</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>obj.save('/var/www/uploads/' + secure_filename(f.filename))</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>响应相关信息</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>return "字符串"</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>return render_template('html模板路径',**{})</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>response = make_response(render_template('index.html'))</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>response是flask.wrappers.Response类型</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>response.delete_cookie('key')</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>response.set_cookie('key', 'value')</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>response.headers['X-Something'] = 'A value'</span>

<span class="pl-mh"><span class="pl-mh">#</span><span class="pl-mh"> </span>return response</span></pre></div>
<ol start="3">
<li>session</li>
</ol>
<p><code>from flask import session</code></p>
<ol start="4">
<li>常见装饰器</li>
</ol>
<ul>
<li>before_first_request：在处理第一个请求前运行。</li>
<li>before_request：在每次请求前运行。</li>
<li>after_request：如果没有未处理的异常抛出，在每次请求后运行。</li>
<li>teardown_request：在每次请求后运行，即使有未处理的异常抛出。</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>, <span class="pl-s1">url_for</span>, <span class="pl-s1">render_template</span>, <span class="pl-s1">redirect</span>, <span class="pl-s1">session</span>, <span class="pl-s1">request</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>, <span class="pl-s1">template_folder</span><span class="pl-c1">=</span><span class="pl-s">'templates'</span>)

<span class="pl-c"># 黑名单</span>
<span class="pl-v">BLACK_LIST</span> <span class="pl-c1">=</span> [<span class="pl-s">'127.0.0.2'</span>]


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-s1">before_request</span>  <span class="pl-c"># 在每次请求之前都会运行</span></span>
<span class="pl-k">def</span> <span class="pl-en">check_login</span>():
    <span class="pl-s">'''</span>
<span class="pl-s">    检测用户登录</span>
<span class="pl-s">    :return: None 表示通过，否则表示不通过</span>
<span class="pl-s">    '''</span>
    <span class="pl-k">if</span> <span class="pl-s1">request</span>.<span class="pl-s1">remote_addr</span> <span class="pl-c1">in</span> <span class="pl-v">BLACK_LIST</span>:
        <span class="pl-k">return</span> <span class="pl-s">"你小子滚犊子"</span>

    <span class="pl-k">if</span> <span class="pl-s1">request</span>.<span class="pl-s1">path</span> <span class="pl-c1">==</span> <span class="pl-en">url_for</span>(<span class="pl-s">'login'</span>):
        <span class="pl-k">return</span> <span class="pl-c1">None</span>

    <span class="pl-s1">user</span> <span class="pl-c1">=</span> <span class="pl-s1">session</span>.<span class="pl-en">get</span>(<span class="pl-s">'user_id'</span>)
    <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">user</span>:
        <span class="pl-en">print</span>(<span class="pl-s">"用户未登录"</span>)
        <span class="pl-k">return</span> <span class="pl-en">redirect</span>(<span class="pl-en">url_for</span>(<span class="pl-s">'login'</span>))
    <span class="pl-k">else</span>:
        <span class="pl-en">print</span>(<span class="pl-s">"检测到用户登录，跳转到首页"</span>)
        <span class="pl-k">return</span> <span class="pl-c1">None</span>


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-s1">after_request</span>  <span class="pl-c"># 在每次请求后运行</span></span>
<span class="pl-k">def</span> <span class="pl-en">check_response</span>(<span class="pl-s1">response</span>):
    <span class="pl-s">'''</span>
<span class="pl-s">    返回给用户的最后一个环节</span>
<span class="pl-s">    :return:</span>
<span class="pl-s">    '''</span>
    <span class="pl-en">print</span>(<span class="pl-s">"响应下"</span>)
    <span class="pl-k">return</span> <span class="pl-s1">response</span>


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/login/'</span>, <span class="pl-s1">methods</span><span class="pl-c1">=</span>[<span class="pl-s">'GET'</span>], <span class="pl-s1">endpoint</span><span class="pl-c1">=</span><span class="pl-s">'login'</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">login</span>():
    <span class="pl-s1">session</span>[<span class="pl-s">'user_id'</span>] <span class="pl-c1">=</span> <span class="pl-c1">123</span>
    <span class="pl-k">return</span> <span class="pl-s">"登录成功"</span>


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/'</span>, <span class="pl-s1">methods</span><span class="pl-c1">=</span>[<span class="pl-s">'GET'</span>], <span class="pl-s1">endpoint</span><span class="pl-c1">=</span><span class="pl-s">'index'</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">index</span>():
    <span class="pl-k">return</span> <span class="pl-en">render_template</span>(<span class="pl-s">'V3.html'</span>, <span class="pl-c1">**</span>({<span class="pl-s">'age'</span>: <span class="pl-c1">12</span>}))</pre></div>
<ol start="5">
<li>闪现</li>
</ol>
<ul>
<li>一般用于消息提醒，用于访问某个视图时进行设置并获取</li>
<li>这部分可以基于session实现，但是也可以直接使用flask内部提供的flash及get_flashed_messaged实现</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>, <span class="pl-s1">flash</span>, <span class="pl-s1">get_flashed_messages</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>, <span class="pl-s1">template_folder</span><span class="pl-c1">=</span><span class="pl-s">'templates'</span>)
<span class="pl-s1">app</span>.<span class="pl-s1">config</span>.<span class="pl-en">from_object</span>(<span class="pl-s">'settings.DevelopmentConfig'</span>)


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/login/'</span>, <span class="pl-s1">methods</span><span class="pl-c1">=</span>[<span class="pl-s">'GET'</span>], <span class="pl-s1">endpoint</span><span class="pl-c1">=</span><span class="pl-s">'login'</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">login</span>():
    <span class="pl-en">flash</span>(<span class="pl-s">"你好哦， 这是闪现"</span>)
    <span class="pl-k">return</span> <span class="pl-s">"登录成功"</span>


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/'</span>, <span class="pl-s1">methods</span><span class="pl-c1">=</span>[<span class="pl-s">'GET'</span>], <span class="pl-s1">endpoint</span><span class="pl-c1">=</span><span class="pl-s">'index'</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">index</span>():
    <span class="pl-s1">data</span> <span class="pl-c1">=</span> <span class="pl-en">get_flashed_messages</span>()
    <span class="pl-k">return</span> <span class="pl-s">'index'</span> <span class="pl-c1">+</span> <span class="pl-en">str</span>(<span class="pl-s1">data</span>)


<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">"__main__"</span>:
    <span class="pl-s1">app</span>.<span class="pl-en">run</span>()</pre></div>
<ol start="5">
<li>中间件</li>
</ol>
<ul>
<li>针对app的wsgi做操作</li>
<li>使用在处理请求之前 【在before_request之前】</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)


<span class="pl-k">class</span> <span class="pl-v">Middleware</span>:
    <span class="pl-k">def</span> <span class="pl-en">__init__</span>(<span class="pl-s1">self</span>, <span class="pl-s1">old_wsgi</span>):
        <span class="pl-s1">self</span>.<span class="pl-s1">old_wsgi</span> <span class="pl-c1">=</span> <span class="pl-s1">old_wsgi</span>

    <span class="pl-k">def</span> <span class="pl-en">__call__</span>(<span class="pl-s1">self</span>, <span class="pl-c1">*</span><span class="pl-s1">args</span>, <span class="pl-c1">**</span><span class="pl-s1">kwargs</span>):
        <span class="pl-c"># 请求之前</span>
        <span class="pl-k">return</span> <span class="pl-s1">self</span>.<span class="pl-en">old_wsgi</span>(<span class="pl-c1">*</span><span class="pl-s1">args</span>, <span class="pl-c1">**</span><span class="pl-s1">kwargs</span>)


<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">"__main__"</span>:
    <span class="pl-c"># 将原生wsgi经过Middleware中间件加工</span>
    <span class="pl-s1">app</span>.<span class="pl-s1">wsgi_app</span> <span class="pl-c1">=</span> <span class="pl-v">Middleware</span>(<span class="pl-s1">app</span>.<span class="pl-s1">wsgi_app</span>)

    <span class="pl-s1">app</span>.<span class="pl-en">run</span>()</pre></div>
<ol start="7">
<li>蓝图</li>
</ol>
<ul>
<li>做目录划分</li>
<li>做路由前缀</li>
<li>针对某一类视图函数添加之前及之后的操作【before_request及after_request等】</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-s">'''</span>
<span class="pl-s">.</span>
<span class="pl-s">├── manage.py   启动文件</span>
<span class="pl-s">└── mysite_flask    项目</span>
<span class="pl-s">    ├── __init__.py</span>
<span class="pl-s">    ├── static  静态文件</span>
<span class="pl-s">    ├── templates   模板文件</span>
<span class="pl-s">    └── views   视图模块</span>
<span class="pl-s">        ├── account.py</span>
<span class="pl-s">        └── admin.py</span>
<span class="pl-s">        </span>
<span class="pl-s">manage.py[老板] --&gt; mysite_flask.__init__.py[经理] --&gt; mysite_flask.views.***[打工人]</span>
<span class="pl-s">'''</span>

<span class="pl-c"># manage.py</span>
<span class="pl-k">from</span> <span class="pl-s1">mysite_flask</span> <span class="pl-k">import</span> <span class="pl-s1">app</span>

<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">'__main__'</span>:
    <span class="pl-s1">app</span>.<span class="pl-en">run</span>()

<span class="pl-c"># mysite_flask.__init__.py</span>
<span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>
<span class="pl-k">from</span> .<span class="pl-s1">views</span> <span class="pl-k">import</span> <span class="pl-s1">account</span>, <span class="pl-s1">admin</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)

<span class="pl-c"># 将蓝图对象进行关联</span>
<span class="pl-s1">app</span>.<span class="pl-en">register_blueprint</span>(<span class="pl-s1">account</span>.<span class="pl-s1">account</span>, <span class="pl-s1">url_prefix</span><span class="pl-c1">=</span><span class="pl-s">'/account'</span>)  <span class="pl-c"># url_prefix 路由前缀，可以在这部分加，也可以单独写在视图函数中</span>
<span class="pl-s1">app</span>.<span class="pl-en">register_blueprint</span>(<span class="pl-s1">admin</span>.<span class="pl-s1">admin</span>)

<span class="pl-c"># mysite_flask.views.account</span>
<span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Blueprint</span>

<span class="pl-s1">account</span> <span class="pl-c1">=</span> <span class="pl-v">Blueprint</span>(<span class="pl-s">'account'</span>, <span class="pl-s1">__name__</span>)


<span class="pl-en">@<span class="pl-s1">account</span>.<span class="pl-en">route</span>(<span class="pl-s">'/register/'</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">register</span>():
    <span class="pl-k">return</span> <span class="pl-s">"用户注册"</span>


<span class="pl-en">@<span class="pl-s1">account</span>.<span class="pl-en">route</span>(<span class="pl-s">'/login/'</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">login</span>():
    <span class="pl-k">return</span> <span class="pl-s">"用户登录"</span>


<span class="pl-c"># mysite_flask.views.admin</span>
<span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Blueprint</span>

<span class="pl-s1">admin</span> <span class="pl-c1">=</span> <span class="pl-v">Blueprint</span>(<span class="pl-s">'admin'</span>, <span class="pl-s1">__name__</span>, <span class="pl-s1">url_prefix</span><span class="pl-c1">=</span><span class="pl-s">'/admin'</span>)


<span class="pl-en">@<span class="pl-s1">admin</span>.<span class="pl-s1">before_request</span></span>
<span class="pl-k">def</span> <span class="pl-en">before</span>():
    <span class="pl-en">print</span>(<span class="pl-s">"针对单个蓝图[这里仅仅是admin]进行处理"</span>)


<span class="pl-en">@<span class="pl-s1">admin</span>.<span class="pl-en">route</span>(<span class="pl-s">'/center'</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">center</span>():
    <span class="pl-k">return</span> <span class="pl-s">"用户管理后台"</span></pre></div>
<h3><a id="user-content-二模板" class="anchor" aria-hidden="true" href="#二模板"><span aria-hidden="true" class="octicon octicon-link"></span></a>二、模板</h3>
<p>由于这部分主要使用Jinja2，且和django template非常相似，故不再重点介绍</p>
<ul>
<li>自定义模板</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># 定义后可以在所有的模板中使用该标签</span>
<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">template_global</span>()</span>
<span class="pl-k">def</span> <span class="pl-en">add</span>(<span class="pl-s1">value</span>):
    <span class="pl-k">return</span> <span class="pl-s1">value</span> <span class="pl-c1">*</span> <span class="pl-c1">2</span>


<span class="pl-c"># 定义后可以在所有的模板中使用该过滤器</span>
<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">template_filter</span>()</span>
<span class="pl-k">def</span> <span class="pl-en">db</span>(<span class="pl-s1">a1</span>, <span class="pl-s1">a2</span>, <span class="pl-s1">a3</span>):
    <span class="pl-k">return</span> <span class="pl-s1">a1</span> <span class="pl-c1">+</span> <span class="pl-s1">a2</span> <span class="pl-c1">+</span> <span class="pl-s1">a3</span></pre></div>
<h3><a id="user-content-三路由" class="anchor" aria-hidden="true" href="#三路由"><span aria-hidden="true" class="octicon octicon-link"></span></a>三、路由</h3>
<ol>
<li>简单路由部分</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)


<span class="pl-c"># 使用装饰器添加路由 -- 推荐</span>
<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/'</span>, <span class="pl-s1">methods</span><span class="pl-c1">=</span>[<span class="pl-s">'GET'</span>])</span>
<span class="pl-k">def</span> <span class="pl-en">index</span>():
    <span class="pl-k">return</span> <span class="pl-s">"hello flask"</span>


<span class="pl-k">def</span> <span class="pl-en">hello</span>():
    <span class="pl-k">return</span> <span class="pl-s">"hello flask"</span>


<span class="pl-c"># 直接添加 -- 不推荐</span>
<span class="pl-s1">app</span>.<span class="pl-en">add_url_rule</span>(<span class="pl-s">'/hello/'</span>, <span class="pl-s1">view_func</span><span class="pl-c1">=</span><span class="pl-s1">hello</span>)</pre></div>
<ol start="2">
<li>反向解析</li>
</ol>
<ul>
<li>和django中reverse相互类似</li>
<li>在这里一般要配合end_point【它是用来起别名的，不写默认就是函数名】使用</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>, <span class="pl-s1">url_for</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/'</span>, <span class="pl-s1">methods</span><span class="pl-c1">=</span>[<span class="pl-s">'GET'</span>], <span class="pl-s1">endpoint</span><span class="pl-c1">=</span><span class="pl-s">'index_1'</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">index</span>():
    <span class="pl-k">return</span> <span class="pl-s">"index"</span>


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/look/'</span>, <span class="pl-s1">methods</span><span class="pl-c1">=</span>[<span class="pl-s">'GET'</span>])</span>
<span class="pl-k">def</span> <span class="pl-en">look</span>():
    <span class="pl-en">print</span>(<span class="pl-en">url_for</span>(<span class="pl-s">'index_1'</span>))  <span class="pl-c"># 解析地址</span>
    <span class="pl-k">return</span> <span class="pl-s">'look'</span></pre></div>
<ol start="3">
<li>重定向</li>
</ol>
<p><code>from flask import redirect</code></p>
<ol start="4">
<li>自定义路由</li>
</ol>
<ul>
<li>string: (缺省值)接受任何不包含斜杠的文本</li>
<li>int: 接受正整数</li>
<li>float: 接受正浮点数</li>
<li>path: 类似 string ，但可以包含斜杠</li>
<li>uuid: 接受 UUID 字符串</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/url_custom/&lt;int:fid&gt;/'</span>, <span class="pl-s1">methods</span><span class="pl-c1">=</span>[<span class="pl-s">'GET'</span>])</span>
<span class="pl-k">def</span> <span class="pl-en">url_custom</span>(<span class="pl-s1">fid</span>):
    <span class="pl-en">print</span>(<span class="pl-s1">fid</span>)
    <span class="pl-k">return</span> <span class="pl-s">'url_custom'</span></pre></div>
<ol start="5">
<li>自定义路由转换器</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>
<span class="pl-k">from</span> <span class="pl-s1">werkzeug</span>.<span class="pl-s1">routing</span> <span class="pl-k">import</span> <span class="pl-v">BaseConverter</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)


<span class="pl-k">class</span> <span class="pl-v">RegexConverter</span>(<span class="pl-v">BaseConverter</span>):
    <span class="pl-s">"""自定义路由转换器"""</span>

    <span class="pl-k">def</span> <span class="pl-en">__init__</span>(<span class="pl-s1">self</span>, <span class="pl-s1">map</span>, <span class="pl-s1">regex</span>):
        <span class="pl-en">super</span>().<span class="pl-en">__init__</span>(<span class="pl-s1">map</span>)
        <span class="pl-s1">self</span>.<span class="pl-s1">regex</span> <span class="pl-c1">=</span> <span class="pl-s1">regex</span>

    <span class="pl-k">def</span> <span class="pl-en">to_python</span>(<span class="pl-s1">self</span>, <span class="pl-s1">value</span>):
        <span class="pl-s">'''</span>
<span class="pl-s">        匹配路由成功之后，将匹配成功后传递给视图函数中参数的值</span>
<span class="pl-s">        :param value:</span>
<span class="pl-s">        :return:</span>
<span class="pl-s">        '''</span>
        <span class="pl-k">return</span> <span class="pl-s1">value</span>

    <span class="pl-k">def</span> <span class="pl-en">to_url</span>(<span class="pl-s1">self</span>, <span class="pl-s1">value</span>):
        <span class="pl-s">'''</span>
<span class="pl-s">        使用url_for反向生成url时，传递的参数经过改方式处理，返回值用于生成URL中的参数</span>
<span class="pl-s">        :param value: </span>
<span class="pl-s">        :return: </span>
<span class="pl-s">        '''</span>
        <span class="pl-k">return</span> <span class="pl-en">super</span>(<span class="pl-v">RegexConverter</span>, <span class="pl-s1">self</span>).<span class="pl-en">to_url</span>(<span class="pl-s1">value</span>)


<span class="pl-c"># 将自定义路由转换机加入到项目中</span>
<span class="pl-s1">app</span>.<span class="pl-s1">url_map</span>.<span class="pl-s1">converters</span>[<span class="pl-s">'xxx'</span>] <span class="pl-c1">=</span> <span class="pl-v">RegexConverter</span>


<span class="pl-c"># 使用</span>
<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">'/&lt;xxx("\d+"):fid&gt;'</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">index</span>(<span class="pl-s1">fid</span>):
    <span class="pl-en">print</span>(<span class="pl-s1">fid</span>)
    <span class="pl-k">return</span> <span class="pl-s">"hahahah"</span></pre></div>
<h3><a id="user-content-四信号" class="anchor" aria-hidden="true" href="#四信号"><span aria-hidden="true" class="octicon octicon-link"></span></a>四、信号</h3>
<p>Flask框架中的信号基于blinker，其主要就是让开发者可是在flask请求过程中定制一些用户行为。</p>
<p><code>pip install blinker</code></p>
<ol>
<li>内置信号</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-s1">request_started</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'request-started'</span>)  <span class="pl-c"># 请求到来前执行</span>
<span class="pl-s1">request_finished</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'request-finished'</span>)  <span class="pl-c"># 请求结束后执行</span>

<span class="pl-s1">before_render_template</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'before-render-template'</span>)  <span class="pl-c"># 模板渲染前执行</span>
<span class="pl-s1">template_rendered</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'template-rendered'</span>)  <span class="pl-c"># 模板渲染后执行</span>

<span class="pl-s1">got_request_exception</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'got-request-exception'</span>)  <span class="pl-c"># 请求执行出现异常时执行</span>

<span class="pl-s1">request_tearing_down</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'request-tearing-down'</span>)  <span class="pl-c"># 请求执行完毕后自动执行（无论成功与否）</span>
<span class="pl-s1">appcontext_tearing_down</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'appcontext-tearing-down'</span>)  <span class="pl-c"># 应用上下文执行完毕后自动执行（无论成功与否）</span>

<span class="pl-s1">appcontext_pushed</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'appcontext-pushed'</span>)  <span class="pl-c"># 应用上下文push时执行</span>
<span class="pl-s1">appcontext_popped</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'appcontext-popped'</span>)  <span class="pl-c"># 应用上下文pop时执行</span>
<span class="pl-s1">message_flashed</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'message-flashed'</span>)  <span class="pl-c"># 调用flask在其中添加数据时，自动触发</span></pre></div>
<ol start="2">
<li>自定义信号</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>, <span class="pl-s1">current_app</span>, <span class="pl-s1">flash</span>, <span class="pl-s1">render_template</span>
<span class="pl-k">from</span> <span class="pl-s1">flask</span>.<span class="pl-s1">signals</span> <span class="pl-k">import</span> <span class="pl-s1">_signals</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)

<span class="pl-c"># 自定义信号</span>
<span class="pl-s1">xxxxx</span> <span class="pl-c1">=</span> <span class="pl-s1">_signals</span>.<span class="pl-en">signal</span>(<span class="pl-s">'xxxxx'</span>)


<span class="pl-k">def</span> <span class="pl-en">func</span>(<span class="pl-s1">sender</span>, <span class="pl-c1">*</span><span class="pl-s1">args</span>, <span class="pl-c1">**</span><span class="pl-s1">kwargs</span>):
    <span class="pl-en">print</span>(<span class="pl-s1">sender</span>)


<span class="pl-c"># 自定义信号中注册函数</span>
<span class="pl-s1">xxxxx</span>.<span class="pl-en">connect</span>(<span class="pl-s1">func</span>)


<span class="pl-en">@<span class="pl-s1">app</span>.<span class="pl-en">route</span>(<span class="pl-s">"/x"</span>)</span>
<span class="pl-k">def</span> <span class="pl-en">index</span>():
    <span class="pl-c"># 触发信号</span>
    <span class="pl-s1">xxxxx</span>.<span class="pl-en">send</span>(<span class="pl-s">'123123'</span>, <span class="pl-s1">k1</span><span class="pl-c1">=</span><span class="pl-s">'v1'</span>)
    <span class="pl-k">return</span> <span class="pl-s">'Index'</span>


<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">'__main__'</span>:
    <span class="pl-s1">app</span>.<span class="pl-en">run</span>()</pre></div>
<ol start="3">
<li>源码实例</li>
</ol>
<ul>
<li>request_started</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">class</span> <span class="pl-v">Flask</span>(<span class="pl-s1">_PackageBoundObject</span>):

    <span class="pl-k">def</span> <span class="pl-en">full_dispatch_request</span>(<span class="pl-s1">self</span>):

        <span class="pl-s1">self</span>.<span class="pl-en">try_trigger_before_first_request_functions</span>()
        <span class="pl-k">try</span>:
            <span class="pl-c"># ############### 触发request_started 信号 ###############</span>
            <span class="pl-s1">request_started</span>.<span class="pl-en">send</span>(<span class="pl-s1">self</span>)
            <span class="pl-s1">rv</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">preprocess_request</span>()
            <span class="pl-k">if</span> <span class="pl-s1">rv</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span>:
                <span class="pl-s1">rv</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">dispatch_request</span>()
        <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
            <span class="pl-s1">rv</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">handle_user_exception</span>(<span class="pl-s1">e</span>)
        <span class="pl-s1">response</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">make_response</span>(<span class="pl-s1">rv</span>)
        <span class="pl-s1">response</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">process_response</span>(<span class="pl-s1">response</span>)

        <span class="pl-c"># ############### request_finished 信号 ###############</span>
        <span class="pl-s1">request_finished</span>.<span class="pl-en">send</span>(<span class="pl-s1">self</span>, <span class="pl-s1">response</span><span class="pl-c1">=</span><span class="pl-s1">response</span>)
        <span class="pl-k">return</span> <span class="pl-s1">response</span>

    <span class="pl-k">def</span> <span class="pl-en">wsgi_app</span>(<span class="pl-s1">self</span>, <span class="pl-s1">environ</span>, <span class="pl-s1">start_response</span>):

        <span class="pl-s1">ctx</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">request_context</span>(<span class="pl-s1">environ</span>)
        <span class="pl-s1">ctx</span>.<span class="pl-en">push</span>()
        <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-c1">None</span>
        <span class="pl-k">try</span>:
            <span class="pl-k">try</span>:
                <span class="pl-s1">response</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">full_dispatch_request</span>()
            <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
                <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-s1">e</span>
                <span class="pl-s1">response</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">make_response</span>(<span class="pl-s1">self</span>.<span class="pl-en">handle_exception</span>(<span class="pl-s1">e</span>))
            <span class="pl-k">return</span> <span class="pl-en">response</span>(<span class="pl-s1">environ</span>, <span class="pl-s1">start_response</span>)
        <span class="pl-k">finally</span>:
            <span class="pl-k">if</span> <span class="pl-s1">self</span>.<span class="pl-en">should_ignore_error</span>(<span class="pl-s1">error</span>):
                <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-c1">None</span>
            <span class="pl-s1">ctx</span>.<span class="pl-en">auto_pop</span>(<span class="pl-s1">error</span>)</pre></div>
<ul>
<li>request_finished</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># 同上</span></pre></div>
<ul>
<li>before_render_template</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">render_template</span>(<span class="pl-s1">template_name_or_list</span>, <span class="pl-c1">**</span><span class="pl-s1">context</span>):
    <span class="pl-s">"""Renders a template from the template folder with the given</span>
<span class="pl-s">    context.</span>
<span class="pl-s"></span>
<span class="pl-s">    :param template_name_or_list: the name of the template to be</span>
<span class="pl-s">                                  rendered, or an iterable with template names</span>
<span class="pl-s">                                  the first one existing will be rendered</span>
<span class="pl-s">    :param context: the variables that should be available in the</span>
<span class="pl-s">                    context of the template.</span>
<span class="pl-s">    """</span>
    <span class="pl-s1">ctx</span> <span class="pl-c1">=</span> <span class="pl-s1">_app_ctx_stack</span>.<span class="pl-s1">top</span>
    <span class="pl-s1">ctx</span>.<span class="pl-s1">app</span>.<span class="pl-en">update_template_context</span>(<span class="pl-s1">context</span>)
    <span class="pl-k">return</span> <span class="pl-en">_render</span>(<span class="pl-s1">ctx</span>.<span class="pl-s1">app</span>.<span class="pl-s1">jinja_env</span>.<span class="pl-en">get_or_select_template</span>(<span class="pl-s1">template_name_or_list</span>),
                   <span class="pl-s1">context</span>, <span class="pl-s1">ctx</span>.<span class="pl-s1">app</span>)


<span class="pl-k">def</span> <span class="pl-en">_render</span>(<span class="pl-s1">template</span>, <span class="pl-s1">context</span>, <span class="pl-s1">app</span>):
    <span class="pl-s">"""Renders the template and fires the signal"""</span>

    <span class="pl-c"># ############### before_render_template 信号 ###############</span>
    <span class="pl-s1">before_render_template</span>.<span class="pl-en">send</span>(<span class="pl-s1">app</span>, <span class="pl-s1">template</span><span class="pl-c1">=</span><span class="pl-s1">template</span>, <span class="pl-s1">context</span><span class="pl-c1">=</span><span class="pl-s1">context</span>)
    <span class="pl-s1">rv</span> <span class="pl-c1">=</span> <span class="pl-s1">template</span>.<span class="pl-en">render</span>(<span class="pl-s1">context</span>)

    <span class="pl-c"># ############### template_rendered 信号 ###############</span>
    <span class="pl-s1">template_rendered</span>.<span class="pl-en">send</span>(<span class="pl-s1">app</span>, <span class="pl-s1">template</span><span class="pl-c1">=</span><span class="pl-s1">template</span>, <span class="pl-s1">context</span><span class="pl-c1">=</span><span class="pl-s1">context</span>)
    <span class="pl-k">return</span> <span class="pl-s1">rv</span></pre></div>
<ul>
<li>template_rendered</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># 同上</span></pre></div>
<ul>
<li>got_request_exception</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">class</span> <span class="pl-v">Flask</span>(<span class="pl-s1">_PackageBoundObject</span>):

    <span class="pl-k">def</span> <span class="pl-en">handle_exception</span>(<span class="pl-s1">self</span>, <span class="pl-s1">e</span>):

        <span class="pl-s1">exc_type</span>, <span class="pl-s1">exc_value</span>, <span class="pl-s1">tb</span> <span class="pl-c1">=</span> <span class="pl-s1">sys</span>.<span class="pl-en">exc_info</span>()

        <span class="pl-c"># ############### got_request_exception 信号 ###############</span>
        <span class="pl-s1">got_request_exception</span>.<span class="pl-en">send</span>(<span class="pl-s1">self</span>, <span class="pl-s1">exception</span><span class="pl-c1">=</span><span class="pl-s1">e</span>)
        <span class="pl-s1">handler</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">_find_error_handler</span>(<span class="pl-v">InternalServerError</span>())

        <span class="pl-k">if</span> <span class="pl-s1">self</span>.<span class="pl-s1">propagate_exceptions</span>:
            <span class="pl-c"># if we want to repropagate the exception, we can attempt to</span>
            <span class="pl-c"># raise it with the whole traceback in case we can do that</span>
            <span class="pl-c"># (the function was actually called from the except part)</span>
            <span class="pl-c"># otherwise, we just raise the error again</span>
            <span class="pl-k">if</span> <span class="pl-s1">exc_value</span> <span class="pl-c1">is</span> <span class="pl-s1">e</span>:
                <span class="pl-en">reraise</span>(<span class="pl-s1">exc_type</span>, <span class="pl-s1">exc_value</span>, <span class="pl-s1">tb</span>)
            <span class="pl-k">else</span>:
                <span class="pl-k">raise</span> <span class="pl-s1">e</span>

        <span class="pl-s1">self</span>.<span class="pl-en">log_exception</span>((<span class="pl-s1">exc_type</span>, <span class="pl-s1">exc_value</span>, <span class="pl-s1">tb</span>))
        <span class="pl-k">if</span> <span class="pl-s1">handler</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span>:
            <span class="pl-k">return</span> <span class="pl-v">InternalServerError</span>()
        <span class="pl-k">return</span> <span class="pl-en">handler</span>(<span class="pl-s1">e</span>)

    <span class="pl-k">def</span> <span class="pl-en">wsgi_app</span>(<span class="pl-s1">self</span>, <span class="pl-s1">environ</span>, <span class="pl-s1">start_response</span>):

        <span class="pl-s1">ctx</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">request_context</span>(<span class="pl-s1">environ</span>)
        <span class="pl-s1">ctx</span>.<span class="pl-en">push</span>()
        <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-c1">None</span>
        <span class="pl-k">try</span>:
            <span class="pl-k">try</span>:
                <span class="pl-s1">response</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">full_dispatch_request</span>()
            <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
                <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-s1">e</span>
                <span class="pl-c"># 这里这里这里这里这里这里这里这里这里这里这里这里 #</span>
                <span class="pl-s1">response</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">make_response</span>(<span class="pl-s1">self</span>.<span class="pl-en">handle_exception</span>(<span class="pl-s1">e</span>))
            <span class="pl-k">return</span> <span class="pl-en">response</span>(<span class="pl-s1">environ</span>, <span class="pl-s1">start_response</span>)
        <span class="pl-k">finally</span>:
            <span class="pl-k">if</span> <span class="pl-s1">self</span>.<span class="pl-en">should_ignore_error</span>(<span class="pl-s1">error</span>):
                <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-c1">None</span>
            <span class="pl-s1">ctx</span>.<span class="pl-en">auto_pop</span>(<span class="pl-s1">error</span>)</pre></div>
<ul>
<li>request_tearing_down</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">class</span> <span class="pl-v">AppContext</span>(<span class="pl-s1">object</span>):
    <span class="pl-k">def</span> <span class="pl-en">push</span>(<span class="pl-s1">self</span>):
        <span class="pl-s">"""Binds the app context to the current context."""</span>
        <span class="pl-s1">self</span>.<span class="pl-s1">_refcnt</span> <span class="pl-c1">+=</span> <span class="pl-c1">1</span>
        <span class="pl-k">if</span> <span class="pl-en">hasattr</span>(<span class="pl-s1">sys</span>, <span class="pl-s">'exc_clear'</span>):
            <span class="pl-s1">sys</span>.<span class="pl-en">exc_clear</span>()
        <span class="pl-s1">_app_ctx_stack</span>.<span class="pl-en">push</span>(<span class="pl-s1">self</span>)
        <span class="pl-c"># ############## 触发 appcontext_pushed 信号 ##############</span>
        <span class="pl-s1">appcontext_pushed</span>.<span class="pl-en">send</span>(<span class="pl-s1">self</span>.<span class="pl-s1">app</span>)

    <span class="pl-k">def</span> <span class="pl-en">pop</span>(<span class="pl-s1">self</span>, <span class="pl-s1">exc</span><span class="pl-c1">=</span><span class="pl-s1">_sentinel</span>):
        <span class="pl-s">"""Pops the app context."""</span>
        <span class="pl-k">try</span>:
            <span class="pl-s1">self</span>.<span class="pl-s1">_refcnt</span> <span class="pl-c1">-=</span> <span class="pl-c1">1</span>
            <span class="pl-k">if</span> <span class="pl-s1">self</span>.<span class="pl-s1">_refcnt</span> <span class="pl-c1">&lt;=</span> <span class="pl-c1">0</span>:
                <span class="pl-k">if</span> <span class="pl-s1">exc</span> <span class="pl-c1">is</span> <span class="pl-s1">_sentinel</span>:
                    <span class="pl-s1">exc</span> <span class="pl-c1">=</span> <span class="pl-s1">sys</span>.<span class="pl-en">exc_info</span>()[<span class="pl-c1">1</span>]
                <span class="pl-c"># ############## 触发 appcontext_tearing_down 信号 ##############</span>
                <span class="pl-s1">self</span>.<span class="pl-s1">app</span>.<span class="pl-en">do_teardown_appcontext</span>(<span class="pl-s1">exc</span>)
        <span class="pl-k">finally</span>:
            <span class="pl-s1">rv</span> <span class="pl-c1">=</span> <span class="pl-s1">_app_ctx_stack</span>.<span class="pl-en">pop</span>()
        <span class="pl-k">assert</span> <span class="pl-s1">rv</span> <span class="pl-c1">is</span> <span class="pl-s1">self</span>, <span class="pl-s">'Popped wrong app context.  (%r instead of %r)'</span>
        <span class="pl-c1">%</span> (<span class="pl-s1">rv</span>, <span class="pl-s1">self</span>)

    <span class="pl-c"># ############## 触发 appcontext_popped 信号 ##############</span>
    <span class="pl-s1">appcontext_popped</span>.<span class="pl-en">send</span>(<span class="pl-s1">self</span>.<span class="pl-s1">app</span>)


<span class="pl-k">class</span> <span class="pl-v">RequestContext</span>(<span class="pl-s1">object</span>):
    <span class="pl-k">def</span> <span class="pl-en">push</span>(<span class="pl-s1">self</span>):
        <span class="pl-s1">top</span> <span class="pl-c1">=</span> <span class="pl-s1">_request_ctx_stack</span>.<span class="pl-s1">top</span>
        <span class="pl-k">if</span> <span class="pl-s1">top</span> <span class="pl-c1">is</span> <span class="pl-c1">not</span> <span class="pl-c1">None</span> <span class="pl-c1">and</span> <span class="pl-s1">top</span>.<span class="pl-s1">preserved</span>:
            <span class="pl-s1">top</span>.<span class="pl-en">pop</span>(<span class="pl-s1">top</span>.<span class="pl-s1">_preserved_exc</span>)

        <span class="pl-s1">app_ctx</span> <span class="pl-c1">=</span> <span class="pl-s1">_app_ctx_stack</span>.<span class="pl-s1">top</span>
        <span class="pl-k">if</span> <span class="pl-s1">app_ctx</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span> <span class="pl-c1">or</span> <span class="pl-s1">app_ctx</span>.<span class="pl-s1">app</span> <span class="pl-c1">!=</span> <span class="pl-s1">self</span>.<span class="pl-s1">app</span>:

            <span class="pl-c"># ####################################################</span>
            <span class="pl-s1">app_ctx</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-s1">app</span>.<span class="pl-en">app_context</span>()
            <span class="pl-s1">app_ctx</span>.<span class="pl-en">push</span>()
            <span class="pl-s1">self</span>.<span class="pl-s1">_implicit_app_ctx_stack</span>.<span class="pl-en">append</span>(<span class="pl-s1">app_ctx</span>)
        <span class="pl-k">else</span>:
            <span class="pl-s1">self</span>.<span class="pl-s1">_implicit_app_ctx_stack</span>.<span class="pl-en">append</span>(<span class="pl-c1">None</span>)

        <span class="pl-k">if</span> <span class="pl-en">hasattr</span>(<span class="pl-s1">sys</span>, <span class="pl-s">'exc_clear'</span>):
            <span class="pl-s1">sys</span>.<span class="pl-en">exc_clear</span>()

        <span class="pl-s1">_request_ctx_stack</span>.<span class="pl-en">push</span>(<span class="pl-s1">self</span>)

        <span class="pl-c"># Open the session at the moment that the request context is</span>
        <span class="pl-c"># available. This allows a custom open_session method to use the</span>
        <span class="pl-c"># request context (e.g. code that access database information</span>
        <span class="pl-c"># stored on `g` instead of the appcontext).</span>
        <span class="pl-s1">self</span>.<span class="pl-s1">session</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-s1">app</span>.<span class="pl-en">open_session</span>(<span class="pl-s1">self</span>.<span class="pl-s1">request</span>)
        <span class="pl-k">if</span> <span class="pl-s1">self</span>.<span class="pl-s1">session</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span>:
            <span class="pl-s1">self</span>.<span class="pl-s1">session</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-s1">app</span>.<span class="pl-en">make_null_session</span>()


<span class="pl-k">class</span> <span class="pl-v">Flask</span>(<span class="pl-s1">_PackageBoundObject</span>):

    <span class="pl-k">def</span> <span class="pl-en">wsgi_app</span>(<span class="pl-s1">self</span>, <span class="pl-s1">environ</span>, <span class="pl-s1">start_response</span>):

        <span class="pl-s1">ctx</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">request_context</span>(<span class="pl-s1">environ</span>)
        <span class="pl-s1">ctx</span>.<span class="pl-en">push</span>()
        <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-c1">None</span>
        <span class="pl-k">try</span>:
            <span class="pl-k">try</span>:
                <span class="pl-s1">response</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">full_dispatch_request</span>()
            <span class="pl-k">except</span> <span class="pl-v">Exception</span> <span class="pl-k">as</span> <span class="pl-s1">e</span>:
                <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-s1">e</span>
                <span class="pl-s1">response</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-en">make_response</span>(<span class="pl-s1">self</span>.<span class="pl-en">handle_exception</span>(<span class="pl-s1">e</span>))
            <span class="pl-k">return</span> <span class="pl-en">response</span>(<span class="pl-s1">environ</span>, <span class="pl-s1">start_response</span>)
        <span class="pl-k">finally</span>:
            <span class="pl-k">if</span> <span class="pl-s1">self</span>.<span class="pl-en">should_ignore_error</span>(<span class="pl-s1">error</span>):
                <span class="pl-s1">error</span> <span class="pl-c1">=</span> <span class="pl-c1">None</span>
            <span class="pl-s1">ctx</span>.<span class="pl-en">auto_pop</span>(<span class="pl-s1">error</span>)

    <span class="pl-k">def</span> <span class="pl-en">pop</span>(<span class="pl-s1">self</span>, <span class="pl-s1">exc</span><span class="pl-c1">=</span><span class="pl-s1">_sentinel</span>):
        <span class="pl-s1">app_ctx</span> <span class="pl-c1">=</span> <span class="pl-s1">self</span>.<span class="pl-s1">_implicit_app_ctx_stack</span>.<span class="pl-en">pop</span>()

        <span class="pl-k">try</span>:
            <span class="pl-s1">clear_request</span> <span class="pl-c1">=</span> <span class="pl-c1">False</span>
            <span class="pl-k">if</span> <span class="pl-c1">not</span> <span class="pl-s1">self</span>.<span class="pl-s1">_implicit_app_ctx_stack</span>:
                <span class="pl-s1">self</span>.<span class="pl-s1">preserved</span> <span class="pl-c1">=</span> <span class="pl-c1">False</span>
                <span class="pl-s1">self</span>.<span class="pl-s1">_preserved_exc</span> <span class="pl-c1">=</span> <span class="pl-c1">None</span>
                <span class="pl-k">if</span> <span class="pl-s1">exc</span> <span class="pl-c1">is</span> <span class="pl-s1">_sentinel</span>:
                    <span class="pl-s1">exc</span> <span class="pl-c1">=</span> <span class="pl-s1">sys</span>.<span class="pl-en">exc_info</span>()[<span class="pl-c1">1</span>]

                <span class="pl-c"># ################## 触发 request_tearing_down 信号 ##################</span>
                <span class="pl-s1">self</span>.<span class="pl-s1">app</span>.<span class="pl-en">do_teardown_request</span>(<span class="pl-s1">exc</span>)

                <span class="pl-c"># If this interpreter supports clearing the exception information</span>
                <span class="pl-c"># we do that now.  This will only go into effect on Python 2.x,</span>
                <span class="pl-c"># on 3.x it disappears automatically at the end of the exception</span>
                <span class="pl-c"># stack.</span>
                <span class="pl-k">if</span> <span class="pl-en">hasattr</span>(<span class="pl-s1">sys</span>, <span class="pl-s">'exc_clear'</span>):
                    <span class="pl-s1">sys</span>.<span class="pl-en">exc_clear</span>()

                <span class="pl-s1">request_close</span> <span class="pl-c1">=</span> <span class="pl-en">getattr</span>(<span class="pl-s1">self</span>.<span class="pl-s1">request</span>, <span class="pl-s">'close'</span>, <span class="pl-c1">None</span>)
                <span class="pl-k">if</span> <span class="pl-s1">request_close</span> <span class="pl-c1">is</span> <span class="pl-c1">not</span> <span class="pl-c1">None</span>:
                    <span class="pl-en">request_close</span>()
                <span class="pl-s1">clear_request</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>
        <span class="pl-k">finally</span>:
            <span class="pl-s1">rv</span> <span class="pl-c1">=</span> <span class="pl-s1">_request_ctx_stack</span>.<span class="pl-en">pop</span>()

            <span class="pl-c"># get rid of circular dependencies at the end of the request</span>
            <span class="pl-c"># so that we don't require the GC to be active.</span>
            <span class="pl-k">if</span> <span class="pl-s1">clear_request</span>:
                <span class="pl-s1">rv</span>.<span class="pl-s1">request</span>.<span class="pl-s1">environ</span>[<span class="pl-s">'werkzeug.request'</span>] <span class="pl-c1">=</span> <span class="pl-c1">None</span>

            <span class="pl-c"># Get rid of the app as well if necessary.</span>
            <span class="pl-k">if</span> <span class="pl-s1">app_ctx</span> <span class="pl-c1">is</span> <span class="pl-c1">not</span> <span class="pl-c1">None</span>:
                <span class="pl-c"># ####################################################</span>
                <span class="pl-s1">app_ctx</span>.<span class="pl-en">pop</span>(<span class="pl-s1">exc</span>)

            <span class="pl-k">assert</span> <span class="pl-s1">rv</span> <span class="pl-c1">is</span> <span class="pl-s1">self</span>, <span class="pl-s">'Popped wrong request context.  '</span>
            <span class="pl-s">'(%r instead of %r)'</span> <span class="pl-c1">%</span> (<span class="pl-s1">rv</span>, <span class="pl-s1">self</span>)


<span class="pl-k">def</span> <span class="pl-en">auto_pop</span>(<span class="pl-s1">self</span>, <span class="pl-s1">exc</span>):
    <span class="pl-k">if</span> <span class="pl-s1">self</span>.<span class="pl-s1">request</span>.<span class="pl-s1">environ</span>.<span class="pl-en">get</span>(<span class="pl-s">'flask._preserve_context'</span>) <span class="pl-c1">or</span>
        (<span class="pl-s1">exc</span> <span class="pl-c1">is</span> <span class="pl-c1">not</span> <span class="pl-c1">None</span> <span class="pl-c1">and</span> <span class="pl-s1">self</span>.<span class="pl-s1">app</span>.<span class="pl-s1">preserve_context_on_exception</span>):
    <span class="pl-s1">self</span>.<span class="pl-s1">preserved</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>
    <span class="pl-s1">self</span>.<span class="pl-s1">_preserved_exc</span> <span class="pl-c1">=</span> <span class="pl-s1">exc</span>

<span class="pl-s1">else</span>:
<span class="pl-s1">self</span>.<span class="pl-en">pop</span>(<span class="pl-s1">exc</span>)</pre></div>
<ul>
<li>appcontext_tearing_down</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># 同上</span></pre></div>
<ul>
<li>appcontext_tearing_down</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># 同上</span></pre></div>
<ul>
<li>appcontext_pushed</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># 同上</span></pre></div>
<ul>
<li>appcontext_popped</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># 同上</span></pre></div>
<ul>
<li>message_flashed</li>
</ul>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">flash</span>(<span class="pl-s1">message</span>, <span class="pl-s1">category</span><span class="pl-c1">=</span><span class="pl-s">'message'</span>):
    <span class="pl-s">"""Flashes a message to the next request.  In order to remove the</span>
<span class="pl-s">    flashed message from the session and to display it to the user,</span>
<span class="pl-s">    the template has to call :func:`get_flashed_messages`.</span>
<span class="pl-s"></span>
<span class="pl-s">    .. versionchanged:: 0.3</span>
<span class="pl-s">       `category` parameter added.</span>
<span class="pl-s"></span>
<span class="pl-s">    :param message: the message to be flashed.</span>
<span class="pl-s">    :param category: the category for the message.  The following values</span>
<span class="pl-s">                     are recommended: ``'message'`` for any kind of message,</span>
<span class="pl-s">                     ``'error'`` for errors, ``'info'`` for information</span>
<span class="pl-s">                     messages and ``'warning'`` for warnings.  However any</span>
<span class="pl-s">                     kind of string can be used as category.</span>
<span class="pl-s">    """</span>
    <span class="pl-c"># Original implementation:</span>
    <span class="pl-c">#</span>
    <span class="pl-c">#     session.setdefault('_flashes', []).append((category, message))</span>
    <span class="pl-c">#</span>
    <span class="pl-c"># This assumed that changes made to mutable structures in the session are</span>
    <span class="pl-c"># are always in sync with the session object, which is not true for session</span>
    <span class="pl-c"># implementations that use external storage for keeping their keys/values.</span>
    <span class="pl-s1">flashes</span> <span class="pl-c1">=</span> <span class="pl-s1">session</span>.<span class="pl-en">get</span>(<span class="pl-s">'_flashes'</span>, [])
    <span class="pl-s1">flashes</span>.<span class="pl-en">append</span>((<span class="pl-s1">category</span>, <span class="pl-s1">message</span>))
    <span class="pl-s1">session</span>[<span class="pl-s">'_flashes'</span>] <span class="pl-c1">=</span> <span class="pl-s1">flashes</span>

    <span class="pl-c"># ############### 触发 message_flashed 信号 ###############</span>
    <span class="pl-s1">message_flashed</span>.<span class="pl-en">send</span>(<span class="pl-s1">current_app</span>.<span class="pl-en">_get_current_object</span>(),
                         <span class="pl-s1">message</span><span class="pl-c1">=</span><span class="pl-s1">message</span>, <span class="pl-s1">category</span><span class="pl-c1">=</span><span class="pl-s1">category</span>)</pre></div>
<h3><a id="user-content-五离线脚本" class="anchor" aria-hidden="true" href="#五离线脚本"><span aria-hidden="true" class="octicon octicon-link"></span></a>五、离线脚本</h3>
<ol>
<li>单app离线脚本</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)

<span class="pl-k">with</span> <span class="pl-s1">app</span>.<span class="pl-en">app_context</span>():
    <span class="pl-s">"""</span>
<span class="pl-s">    此时项目所有内容已经加载，需要所做操作处可以直接写在这里</span>
<span class="pl-s">    """</span>
    <span class="pl-k">pass</span></pre></div>
<ol start="2">
<li>多app离线脚本</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>

<span class="pl-s1">app01</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s">"app01"</span>)
<span class="pl-s1">app02</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s">"app02"</span>)

<span class="pl-k">with</span> <span class="pl-s1">app01</span>.<span class="pl-en">app_context</span>():
    <span class="pl-s">"""</span>
<span class="pl-s">    此时app01所有内容已经加载，需要所做操作处可以直接写在这里</span>
<span class="pl-s">    """</span>
    <span class="pl-k">with</span> <span class="pl-s1">app02</span>.<span class="pl-en">app_context</span>():
        <span class="pl-s">"""</span>
<span class="pl-s">        此时app01所有内容已经加载，需要所做操作处可以直接写在这里        </span>
<span class="pl-s">        """</span>
        <span class="pl-k">pass</span>
    <span class="pl-k">pass</span></pre></div>
<h3><a id="user-content-六常用扩展组件" class="anchor" aria-hidden="true" href="#六常用扩展组件"><span aria-hidden="true" class="octicon octicon-link"></span></a>六、常用扩展组件</h3>
<ol>
<li>flask_session组件</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># session的扩展存储</span>
<span class="pl-c"># pip3 install redis</span>
<span class="pl-c"># pip3 install flask-session</span>


<span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>
<span class="pl-k">from</span> <span class="pl-s1">flask_session</span> <span class="pl-k">import</span> <span class="pl-v">Session</span>
<span class="pl-k">from</span> <span class="pl-s1">redis</span> <span class="pl-k">import</span> <span class="pl-v">Redis</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)
<span class="pl-s1">app</span>.<span class="pl-s1">debug</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>
<span class="pl-s1">app</span>.<span class="pl-s1">secret_key</span> <span class="pl-c1">=</span> <span class="pl-s">'djrtsfgtjhsehs'</span>

<span class="pl-c"># 配置session存储到redis中</span>
<span class="pl-s1">app</span>.<span class="pl-s1">config</span>[<span class="pl-s">'SESSION_TYPE'</span>] <span class="pl-c1">=</span> <span class="pl-s">'redis'</span>
<span class="pl-s1">app</span>.<span class="pl-s1">config</span>[<span class="pl-s">'SESSION_REDIS'</span>] <span class="pl-c1">=</span> <span class="pl-v">Redis</span>(<span class="pl-s1">host</span><span class="pl-c1">=</span><span class="pl-s">'192.168.199.103'</span>, <span class="pl-s1">port</span><span class="pl-c1">=</span><span class="pl-s">'6379'</span>)
<span class="pl-v">Session</span>(<span class="pl-s1">app</span>)</pre></div>
<ol start="2">
<li>flask_script组件</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>
<span class="pl-k">from</span> <span class="pl-s1">flask_script</span> <span class="pl-k">import</span> <span class="pl-v">Manager</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)

<span class="pl-s1">manage</span> <span class="pl-c1">=</span> <span class="pl-v">Manager</span>(<span class="pl-s1">app</span>)

<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">'__main__'</span>:
    <span class="pl-s1">manage</span>.<span class="pl-en">run</span>()

<span class="pl-c"># 如此就可以实现python manage runserver启动项目</span></pre></div>
<ol start="3">
<li>flask-sqlalchemy</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># __init__.py </span>
<span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>
<span class="pl-k">from</span> <span class="pl-s1">flask_sqlalchemy</span> <span class="pl-k">import</span> <span class="pl-v">SQLAlchemy</span>

<span class="pl-c"># db包含了SQLAlchemy的所有操作</span>
<span class="pl-s1">db</span> <span class="pl-c1">=</span> <span class="pl-v">SQLAlchemy</span>()

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)
<span class="pl-s1">app</span>.<span class="pl-s1">config</span>[<span class="pl-s">'xxxx'</span>] <span class="pl-c1">=</span> <span class="pl-s">'xxxxx'</span>  <span class="pl-c"># 写配置文件</span>
<span class="pl-s1">db</span>.<span class="pl-en">init_app</span>(<span class="pl-s1">app</span>)  <span class="pl-c"># 将app的所有配置文件加载，在使用SQLAlchemy时变的更加简单</span>

<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">'__main__'</span>:
    <span class="pl-s1">app</span>.<span class="pl-en">run</span>()

<span class="pl-c"># models.py</span>
<span class="pl-k">from</span> <span class="pl-s1">sqlalchemy</span> <span class="pl-k">import</span> <span class="pl-v">Column</span>, <span class="pl-v">Integer</span>, <span class="pl-v">String</span>
<span class="pl-k">from</span> 项目名 <span class="pl-k">import</span> <span class="pl-s1">db</span>


<span class="pl-k">class</span> <span class="pl-v">User</span>(<span class="pl-s1">db</span>.<span class="pl-v">Model</span>):
    <span class="pl-s1">id</span> <span class="pl-c1">=</span> <span class="pl-v">Column</span>(<span class="pl-v">Integer</span>, <span class="pl-s1">primary_key</span><span class="pl-c1">=</span><span class="pl-c1">True</span>, <span class="pl-s1">autoincrement</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-v">Column</span>(<span class="pl-v">String</span>(<span class="pl-c1">32</span>), <span class="pl-s1">nullable</span><span class="pl-c1">=</span><span class="pl-c1">False</span>, <span class="pl-s1">unique</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)


<span class="pl-c"># views.py</span>
<span class="pl-k">from</span> 项目名 <span class="pl-k">import</span> <span class="pl-s1">db</span>

<span class="pl-c"># 数据库操作</span>
<span class="pl-s1">db</span>.<span class="pl-s1">session</span>.<span class="pl-en">query</span>()</pre></div>
<ol start="4">
<li>flask-migrate</li>
</ol>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># 依赖</span>
<span class="pl-c"># flask-script</span>
<span class="pl-c"># flask-sqlalchemy</span>
<span class="pl-k">from</span> <span class="pl-s1">flask</span> <span class="pl-k">import</span> <span class="pl-v">Flask</span>
<span class="pl-k">from</span> <span class="pl-s1">flask_script</span> <span class="pl-k">import</span> <span class="pl-v">Manager</span>
<span class="pl-k">from</span> <span class="pl-s1">flask_sqlalchemy</span> <span class="pl-k">import</span> <span class="pl-v">SQLAlchemy</span>
<span class="pl-k">from</span> <span class="pl-s1">flask_migrate</span> <span class="pl-k">import</span> <span class="pl-v">Migrate</span>, <span class="pl-v">MigrateCommand</span>

<span class="pl-s1">app</span> <span class="pl-c1">=</span> <span class="pl-v">Flask</span>(<span class="pl-s1">__name__</span>)
<span class="pl-s1">app</span>.<span class="pl-s1">config</span>[<span class="pl-s">'SQLALCHEMY_DATABASE_URI'</span>] <span class="pl-c1">=</span> <span class="pl-s">"mysql+pymysql://root:00090009@192.168.199.103:3306/testmigrate?charset=utf8"</span>
<span class="pl-s1">db</span> <span class="pl-c1">=</span> <span class="pl-v">SQLAlchemy</span>(<span class="pl-s1">app</span>)

<span class="pl-s1">manager</span> <span class="pl-c1">=</span> <span class="pl-v">Manager</span>(<span class="pl-s1">app</span>)
<span class="pl-v">Migrate</span>(<span class="pl-s1">app</span>, <span class="pl-s1">db</span>)

<span class="pl-s1">manager</span>.<span class="pl-en">add_command</span>(<span class="pl-s">'db'</span>, <span class="pl-v">MigrateCommand</span>)


<span class="pl-k">class</span> <span class="pl-v">User</span>(<span class="pl-s1">db</span>.<span class="pl-v">Model</span>):
    <span class="pl-s1">__tablename__</span> <span class="pl-c1">=</span> <span class="pl-s">"scriptUser"</span>
    <span class="pl-s1">id</span> <span class="pl-c1">=</span> <span class="pl-s1">db</span>.<span class="pl-v">Column</span>(<span class="pl-s1">db</span>.<span class="pl-v">Integer</span>, <span class="pl-s1">primary_key</span><span class="pl-c1">=</span><span class="pl-c1">True</span>, <span class="pl-s1">autoincrement</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s1">db</span>.<span class="pl-v">Column</span>(<span class="pl-s1">db</span>.<span class="pl-v">String</span>(<span class="pl-c1">64</span>), <span class="pl-s1">nullable</span><span class="pl-c1">=</span><span class="pl-c1">False</span>, <span class="pl-s1">unique</span><span class="pl-c1">=</span><span class="pl-c1">True</span>)
    <span class="pl-s1">age</span> <span class="pl-c1">=</span> <span class="pl-s1">db</span>.<span class="pl-v">Column</span>(<span class="pl-s1">db</span>.<span class="pl-v">Integer</span>, <span class="pl-s1">default</span><span class="pl-c1">=</span><span class="pl-c1">12</span>)


<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">'__main__'</span>:
    <span class="pl-s1">manager</span>.<span class="pl-en">run</span>()

<span class="pl-s">"""</span>
<span class="pl-s">python manage.py db init</span>
<span class="pl-s">python manage.py db migrate # makemigrations</span>
<span class="pl-s">python manage.py db upgrade # migrate</span>
<span class="pl-s">"""</span></pre></div>

      </article>
    </div>
  </div>
  <div class="
    side
    Box
    md
    js-code-block-container
    Box--responsive
    container-right-nav
    mt-5
    d-none d-lg-block
  " style="overflow: hidden;">
    <div class="Box-body p-5">
      <div class="container-right-nav-logo">
        <a href="https://www.github.com/Bean-jun"><svg height="32" class="octicon octicon-mark-github anim-pulse"
            viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true">
            <path fill-rule="evenodd"
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z">
            </path>
          </svg></a>
      </div>
    </div>
    <div class="content-title-nav">
      <ul>
        <li><a href="#一、视图">一、视图</a></li><li><a href="#二、模板">二、模板</a></li><li><a href="#三、路由">三、路由</a></li><li><a href="#四、信号">四、信号</a></li><li><a href="#五、离线脚本">五、离线脚本</a></li><li><a href="#六、常用扩展组件">六、常用扩展组件</a></li>
      </ul>
    </div>
  </div>
  <script src="/.static/js/theme.js"></script>
  <script src="/.static/js/iconify.min.js"></script>
</body>

</html>